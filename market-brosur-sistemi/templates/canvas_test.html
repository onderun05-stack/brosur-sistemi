<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Test - SÄ±fÄ±rdan Ä°nÅŸa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d9ff;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        .template-select {
            padding: 12px 20px;
            border: 2px solid #00d9ff;
            border-radius: 8px;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .template-select option {
            background: #1a1a2e;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .canvas-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #test-canvas {
            border: 3px solid #00d9ff;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.3);
        }
        .log-panel {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-panel h3 {
            margin-bottom: 10px;
            color: #00d9ff;
        }
        #log-output {
            font-family: monospace;
            font-size: 12px;
            color: #0f0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: rgba(0,255,0,0.1);
            border-radius: 4px;
        }
        
        /* Context Menu */
        .context-menu {
            display: none;
            position: absolute;
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #00d9ff;
            border-radius: 12px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0, 217, 255, 0.3);
            z-index: 1000;
        }
        .context-menu.show {
            display: block;
        }
        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(0, 217, 255, 0.2);
        }
        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        .context-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
        }
        
        /* Note Modal */
        .note-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .note-modal.show {
            display: flex;
        }
        .note-modal-content {
            background: #1a1a2e;
            border: 2px solid #00d9ff;
            border-radius: 12px;
            padding: 20px;
            width: 350px;
        }
        .note-modal h3 {
            color: #00d9ff;
            margin-bottom: 15px;
        }
        .note-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #00d9ff;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .note-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: rgba(0,217,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Canvas Test - SÄ±fÄ±rdan Ä°nÅŸa</h1>
        
        <div class="status" id="status">
            HazÄ±r - Test butonlarÄ±na tÄ±kla
        </div>
        
        <div class="controls">
            <!-- PC'DEN ÅABLON YÃœKLE -->
            <input type="file" id="template-file" accept="image/*" style="display:none" onchange="loadTemplateFromPC(event)">
            <button class="btn btn-info" onclick="document.getElementById('template-file').click()">
                ğŸ“ PC'den Åablon YÃ¼kle
            </button>
            
            <span style="margin: 0 10px; color: #666;">|</span>
            
            <!-- HAZIR ÅABLONLAR -->
            <select id="template-select" class="template-select">
                <option value="">-- HazÄ±r Åablon --</option>
                <option value="red-header">ğŸ”´ KÄ±rmÄ±zÄ± Header</option>
                <option value="blue-gradient">ğŸ”µ Mavi Gradient</option>
                <option value="green-fresh">ğŸŸ¢ YeÅŸil Taze</option>
                <option value="orange-sale">ğŸŸ  Turuncu Ä°ndirim</option>
            </select>
            <button class="btn btn-secondary" onclick="applyTemplate()">
                ğŸ¨ Uygula
            </button>
            
            <span style="margin: 0 10px; color: #666;">|</span>
            
            <!-- ÃœRÃœN EKLE -->
            <button class="btn btn-primary" onclick="testStep1()">
                ğŸ“¸ Resim Ekle
            </button>
            <button class="btn btn-success" onclick="testStep2()">
                ğŸ“ Resim + Ä°sim
            </button>
            <button class="btn btn-warning" onclick="testStep3()">
                ğŸ”¢ 3 ÃœrÃ¼n Grid
            </button>
            <button class="btn btn-danger" onclick="clearCanvas()">
                ğŸ—‘ï¸ Temizle
            </button>
            
            <span style="margin: 0 10px; color: #666;">|</span>
            
            <button class="btn btn-export" onclick="exportPDF()">
                ğŸ“„ PDF Ä°ndir
            </button>
            <button class="btn btn-export" onclick="exportImage()">
                ğŸ–¼ï¸ Resim Ä°ndir
            </button>
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="test-canvas"></canvas>
        </div>
        
        <div class="log-panel">
            <h3>ğŸ“‹ Log</h3>
            <div id="log-output"></div>
        </div>
    </div>

    <script>
        // Canvas boyutlarÄ± (A4)
        const CANVAS_WIDTH = 595;
        const CANVAS_HEIGHT = 842;
        
        // Test resim URL'leri (depodaki GERÃ‡EK resimler)
        const TEST_PRODUCTS = [
            {
                name: 'Ã‡ay ÃœrÃ¼nÃ¼',
                image_url: '/static/uploads/customers/2/supermarket/Ä°Ã§ecek/8690105000115/product.png',
                price: '255,25 â‚º'
            },
            {
                name: 'Temizlik ÃœrÃ¼nÃ¼',
                image_url: '/static/uploads/customers/2/supermarket/Temizlik/8692900327015/product.png',
                price: '135,25 â‚º'
            },
            {
                name: 'AtÄ±ÅŸtÄ±rmalÄ±k',
                image_url: '/static/uploads/customers/2/supermarket/AtÄ±ÅŸtÄ±rmalÄ±k/8690504011200/product.png',
                price: '99,99 â‚º'
            }
        ];
        
        // Canvas oluÅŸtur
        let canvas;
        
        function initCanvas() {
            canvas = new fabric.Canvas('test-canvas', {
                width: CANVAS_WIDTH,
                height: CANVAS_HEIGHT,
                backgroundColor: '#ffffff'
            });
            log('âœ… Canvas oluÅŸturuldu: ' + CANVAS_WIDTH + 'x' + CANVAS_HEIGHT);
        }
        
        // Log fonksiyonu
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logOutput.insertBefore(entry, logOutput.firstChild);
            console.log(message);
        }
        
        // Status gÃ¼ncelle
        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        // ========== PC'DEN ÅABLON YÃœKLE ==========
        function loadTemplateFromPC(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log('ğŸ“ Åablon dosyasÄ± seÃ§ildi: ' + file.name);
            setStatus('â³ Åablon yÃ¼kleniyor...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // Canvas'Ä± temizle
                    canvas.clear();
                    
                    // Åablonu Canvas boyutuna Ã¶lÃ§ekle
                    const scaleX = CANVAS_WIDTH / img.width;
                    const scaleY = CANVAS_HEIGHT / img.height;
                    const scale = Math.max(scaleX, scaleY);
                    
                    img.scale(scale);
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false
                    });
                    
                    canvas.add(img);
                    canvas.sendToBack(img); // Åablonu en arkaya gÃ¶nder
                    canvas.renderAll();
                    
                    log('âœ… Åablon yÃ¼klendi: ' + file.name);
                    setStatus('âœ… Åablon yÃ¼klendi - Åimdi Ã¼rÃ¼n ekleyebilirsin');
                });
            };
            reader.readAsDataURL(file);
            
            // Input'u sÄ±fÄ±rla (aynÄ± dosyayÄ± tekrar seÃ§ebilmek iÃ§in)
            event.target.value = '';
        }
        
        // ========== ADIM 1: SADECE RESÄ°M ==========
        function testStep1() {
            setStatus('â³ Resim yÃ¼kleniyor...');
            log('ğŸ”„ Resim ekleniyor (ÅŸablon korunuyor)');
            
            const product = TEST_PRODUCTS[0];
            addSingleProduct(product, 50, 100);
        }
        
        // Tek Ã¼rÃ¼n ekle (GRUP - ÅŸeffaf, kutusuz)
        function addSingleProduct(product, x, y) {
            fabric.Image.fromURL(product.image_url, function(img) {
                if (!img) {
                    log('âŒ Resim yÃ¼klenemedi: ' + product.name);
                    return;
                }
                
                // Resmi Ã¶lÃ§ekle
                const imgScale = 100 / Math.max(img.width, img.height);
                const imgWidth = img.width * imgScale;
                const imgHeight = img.height * imgScale;
                
                img.scale(imgScale);
                img.set({
                    left: imgWidth / 2,
                    top: imgHeight / 2,
                    originX: 'center',
                    originY: 'center'
                });
                
                // Ä°sim (resmin altÄ±nda, ortalÄ±)
                const nameText = new fabric.Text(product.name, {
                    left: imgWidth / 2,
                    top: imgHeight + 10,
                    fontSize: 14,
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    stroke: '#000000',
                    strokeWidth: 0.5,
                    originX: 'center'
                });
                
                // Fiyat (ismin altÄ±nda, ortalÄ±)
                const priceText = new fabric.Text(product.price, {
                    left: imgWidth / 2,
                    top: imgHeight + 30,
                    fontSize: 20,
                    fontWeight: 'bold',
                    fill: '#ffff00',
                    stroke: '#000000',
                    strokeWidth: 0.5,
                    originX: 'center'
                });
                
                // GRUP OLUÅTUR (ÅŸeffaf - beyaz kutu yok)
                const productGroup = new fabric.Group([img, nameText, priceText], {
                    left: x,
                    top: y,
                    selectable: true,
                    hasControls: true
                });
                
                productGroup.productData = product;
                canvas.add(productGroup);
                canvas.renderAll();
                
                log('âœ… ÃœrÃ¼n grubu eklendi: ' + product.name);
                setStatus('âœ… ÃœrÃ¼n eklendi - Resim+Ä°sim+Fiyat birlikte hareket eder');
            }, { crossOrigin: 'anonymous' });
        }
        
        // ========== ADIM 2: RESÄ°M + Ä°SÄ°M ==========
        function testStep2() {
            setStatus('â³ Resim + Ä°sim yÃ¼kleniyor...');
            log('ğŸ”„ Resim + Ä°sim ekleniyor (ÅŸablon korunuyor)');
            
            const product = TEST_PRODUCTS[1]; // Ä°kinci Ã¼rÃ¼n
            addSingleProduct(product, 220, 100);
        }
        
        // ========== ADIM 3: GRÄ°D (3 ÃœRÃœN) ==========
        function testStep3() {
            // clearCanvas(); // ÅABLONU SÄ°LME!
            setStatus('â³ Grid yÃ¼kleniyor...');
            log('ğŸ”„ 3 Ã¼rÃ¼n grid ekleniyor (ÅŸablon korunuyor)');
            
            const COLS = 3;
            const CARD_WIDTH = 180;
            const CARD_HEIGHT = 250;
            const GAP = 10;
            const START_X = 20;
            const START_Y = 100; // Åablon header'Ä±nÄ±n altÄ±nda baÅŸla
            
            TEST_PRODUCTS.forEach((product, index) => {
                const col = index % COLS;
                const row = Math.floor(index / COLS);
                const x = START_X + col * (CARD_WIDTH + GAP);
                const y = START_Y + row * (CARD_HEIGHT + GAP);
                
                log('ğŸ“¦ ÃœrÃ¼n ' + (index + 1) + ': ' + product.name + ' -> (' + x + ', ' + y + ')');
                
                addProductToCanvas(product, x, y, index);
            });
        }
        
        function addProductToCanvas(product, x, y, index) {
            fabric.Image.fromURL(product.image_url, function(img) {
                if (!img) {
                    log('âŒ Resim yÃ¼klenemedi: ' + product.name);
                    return;
                }
                
                // Resmi Ã¶lÃ§ekle
                const imgScale = 80 / Math.max(img.width, img.height);
                const imgWidth = img.width * imgScale;
                const imgHeight = img.height * imgScale;
                
                img.scale(imgScale);
                img.set({
                    left: imgWidth / 2,
                    top: imgHeight / 2,
                    originX: 'center',
                    originY: 'center'
                });
                
                // Ä°sim (resmin altÄ±nda, ortalÄ±)
                const nameText = new fabric.Text(product.name.substring(0, 18), {
                    left: imgWidth / 2,
                    top: imgHeight + 8,
                    fontSize: 11,
                    fontWeight: 'bold',
                    fill: '#ffffff',
                    stroke: '#000000',
                    strokeWidth: 0.4,
                    originX: 'center'
                });
                
                // Fiyat (ismin altÄ±nda, ortalÄ±)
                const priceText = new fabric.Text(product.price, {
                    left: imgWidth / 2,
                    top: imgHeight + 24,
                    fontSize: 14,
                    fontWeight: 'bold',
                    fill: '#ffff00',
                    stroke: '#000000',
                    strokeWidth: 0.4,
                    originX: 'center'
                });
                
                // GRUP OLUÅTUR (ÅŸeffaf)
                const productGroup = new fabric.Group([img, nameText, priceText], {
                    left: x,
                    top: y,
                    selectable: true,
                    hasControls: true
                });
                
                productGroup.productData = product;
                canvas.add(productGroup);
                canvas.renderAll();
                
                log('âœ… ÃœrÃ¼n grubu eklendi: ' + product.name);
                
                if (index === TEST_PRODUCTS.length - 1) {
                    setStatus('âœ… ' + TEST_PRODUCTS.length + ' Ã¼rÃ¼n eklendi - Birlikte hareket eder');
                }
            }, { crossOrigin: 'anonymous' });
        }
        
        // ========== ÅABLON UYGULA ==========
        function applyTemplate() {
            const select = document.getElementById('template-select');
            const templateId = select.value;
            
            if (!templateId) {
                alert('LÃ¼tfen bir ÅŸablon seÃ§in!');
                return;
            }
            
            log('ğŸ¨ Åablon uygulanÄ±yor: ' + templateId);
            setStatus('â³ Åablon uygulanÄ±yor...');
            
            // Canvas'Ä± temizle
            canvas.clear();
            
            // Åablona gÃ¶re arka plan ve header ekle
            switch(templateId) {
                case 'red-header':
                    applyRedHeaderTemplate();
                    break;
                case 'blue-gradient':
                    applyBlueGradientTemplate();
                    break;
                case 'green-fresh':
                    applyGreenFreshTemplate();
                    break;
                case 'orange-sale':
                    applyOrangeSaleTemplate();
                    break;
            }
            
            canvas.renderAll();
            log('âœ… Åablon uygulandÄ±: ' + templateId);
            setStatus('âœ… Åablon uygulandÄ± - Åimdi Ã¼rÃ¼n ekleyebilirsin');
        }
        
        // KÄ±rmÄ±zÄ± Header Åablonu
        function applyRedHeaderTemplate() {
            canvas.backgroundColor = '#ffffff';
            
            // KÄ±rmÄ±zÄ± header
            const header = new fabric.Rect({
                left: 0, top: 0,
                width: CANVAS_WIDTH, height: 80,
                fill: '#dc2626',
                selectable: false
            });
            canvas.add(header);
            
            // BaÅŸlÄ±k
            const title = new fabric.Text('ğŸ”¥ SÃœPER Ä°NDÄ°RÄ°MLER', {
                left: CANVAS_WIDTH / 2, top: 25,
                fontSize: 28, fontWeight: 'bold',
                fill: '#ffffff', originX: 'center'
            });
            canvas.add(title);
            
            log('ğŸ”´ KÄ±rmÄ±zÄ± header eklendi');
        }
        
        // Mavi Gradient Åablonu
        function applyBlueGradientTemplate() {
            // Gradient arka plan
            const gradient = new fabric.Gradient({
                type: 'linear',
                coords: { x1: 0, y1: 0, x2: 0, y2: CANVAS_HEIGHT },
                colorStops: [
                    { offset: 0, color: '#667eea' },
                    { offset: 1, color: '#764ba2' }
                ]
            });
            
            const bg = new fabric.Rect({
                left: 0, top: 0,
                width: CANVAS_WIDTH, height: CANVAS_HEIGHT,
                fill: gradient, selectable: false
            });
            canvas.add(bg);
            
            // BaÅŸlÄ±k
            const title = new fabric.Text('ğŸ’™ Ã–ZEL FIRSATLAR', {
                left: CANVAS_WIDTH / 2, top: 30,
                fontSize: 28, fontWeight: 'bold',
                fill: '#ffffff', originX: 'center'
            });
            canvas.add(title);
            
            log('ğŸ”µ Mavi gradient eklendi');
        }
        
        // YeÅŸil Taze Åablonu
        function applyGreenFreshTemplate() {
            canvas.backgroundColor = '#f0fdf4';
            
            // YeÅŸil header
            const header = new fabric.Rect({
                left: 0, top: 0,
                width: CANVAS_WIDTH, height: 80,
                fill: '#16a34a', selectable: false
            });
            canvas.add(header);
            
            // BaÅŸlÄ±k
            const title = new fabric.Text('ğŸ¥¬ TAZE ÃœRÃœNLER', {
                left: CANVAS_WIDTH / 2, top: 25,
                fontSize: 28, fontWeight: 'bold',
                fill: '#ffffff', originX: 'center'
            });
            canvas.add(title);
            
            log('ğŸŸ¢ YeÅŸil taze ÅŸablonu eklendi');
        }
        
        // Turuncu Ä°ndirim Åablonu
        function applyOrangeSaleTemplate() {
            canvas.backgroundColor = '#fff7ed';
            
            // Turuncu header
            const header = new fabric.Rect({
                left: 0, top: 0,
                width: CANVAS_WIDTH, height: 100,
                fill: '#ea580c', selectable: false
            });
            canvas.add(header);
            
            // BaÅŸlÄ±k
            const title = new fabric.Text('ğŸ·ï¸ %50 Ä°NDÄ°RÄ°M', {
                left: CANVAS_WIDTH / 2, top: 20,
                fontSize: 32, fontWeight: 'bold',
                fill: '#ffffff', originX: 'center'
            });
            canvas.add(title);
            
            // Alt baÅŸlÄ±k
            const subtitle = new fabric.Text('KaÃ§Ä±rma bu fÄ±rsatÄ±!', {
                left: CANVAS_WIDTH / 2, top: 60,
                fontSize: 18, fill: '#ffedd5',
                originX: 'center'
            });
            canvas.add(subtitle);
            
            log('ğŸŸ  Turuncu indirim ÅŸablonu eklendi');
        }
        
        // ========== TEMÄ°ZLE ==========
        function clearCanvas() {
            canvas.clear();
            canvas.backgroundColor = '#ffffff';
            canvas.renderAll();
            log('ğŸ—‘ï¸ Canvas temizlendi');
            setStatus('HazÄ±r - Test butonlarÄ±na tÄ±kla');
        }
        
        // Sayfa yÃ¼klendiÄŸinde Canvas'Ä± baÅŸlat
        window.onload = function() {
            initCanvas();
        };
    </script>
</body>
</html>


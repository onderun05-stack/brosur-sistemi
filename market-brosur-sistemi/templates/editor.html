<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Admin Theme Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: white;
            padding: 15px 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #667eea;
        }
        
        header h1 {
            color: #667eea;
            font-size: 18px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        button.back {
            background: #ccc;
            color: #333;
        }
        
        button.back:hover {
            background: #999;
        }
        
        .container {
            display: flex;
            gap: 15px;
            padding: 15px;
            flex: 1;
            overflow: hidden;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-y: auto;
        }
        
        .panel-left {
            width: 320px;
            flex-shrink: 0;
        }
        
        .panel-right {
            flex: 1;
        }
        
        .panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        input[type="text"],
        input[type="color"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        input[type="color"] {
            height: 40px;
            cursor: pointer;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        .range-value {
            text-align: center;
            font-size: 11px;
            color: #667eea;
            margin-top: 4px;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 4px rgba(102, 126, 234, 0.3);
        }
        
        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 4px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .status.success {
            background: #107c10;
            color: white;
        }
        
        .status.error {
            background: #d13438;
            color: white;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 8px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .color-scheme {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .color-box {
            height: 50px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .color-box:hover {
            border-color: #667eea;
        }
        
        .color-box.selected {
            border-color: #667eea;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.4);
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .template-card {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }
        
        .template-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            cursor: pointer;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .preset-themes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .preset-theme {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .preset-theme:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }
        
        .preset-theme.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .preset-theme h4 {
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .preset-theme p {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .color-palette {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .color-sample {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header>
        <h1>üé® Enhanced Theme Editor</h1>
        <div class="btn-group">
            <button id="save-theme-btn">üíæ Save Theme</button>
            <button id="apply-theme-btn">‚ú® Apply Theme</button>
            <button id="export-theme-btn">üì§ Export</button>
            <button class="back" id="back-btn">‚Üê Back</button>
        </div>
    </header>

    <div class="container">
        <div class="panel panel-left">
            <div class="tabs">
                <button class="tab active" data-tab="colors">Colors</button>
                <button class="tab" data-tab="typography">Typography</button>
                <button class="tab" data-tab="layout">Layout</button>
                <button class="tab" data-tab="presets">Presets</button>
            </div>
            
            <div id="colors" class="tab-content active">
                <h3>üé® Color Scheme</h3>
                
                <div class="control-group">
                    <label>Color Scheme Generator</label>
                    <div class="color-scheme" id="color-schemes">
                        <!-- Generated color schemes will appear here -->
                    </div>
                    <button id="generate-scheme" style="width: 100%; margin-top: 10px;">Generate New Scheme</button>
                </div>
                
                <div class="control-group">
                    <label>Primary Color</label>
                    <input type="color" id="primary-color" value="#667eea">
                    <input type="range" id="primary-brightness" min="-50" max="50" value="0">
                    <div class="range-value">Brightness: <span id="primary-brightness-value">0</span></div>
                </div>
                
                <div class="control-group">
                    <label>Secondary Color</label>
                    <input type="color" id="secondary-color" value="#764ba2">
                </div>
                
                <div class="control-group">
                    <label>Accent Color</label>
                    <input type="color" id="accent-color" value="#ec4899">
                </div>
                
                <div class="control-group">
                    <label>Background Color</label>
                    <input type="color" id="bg-color" value="#ffffff">
                </div>
                
                <div class="control-group">
                    <label>Text Color</label>
                    <input type="color" id="text-color" value="#333333">
                </div>
                
                <div class="control-group">
                    <label>Price Color</label>
                    <input type="color" id="price-color" value="#e74c3c">
                </div>
            </div>
            
            <div id="typography" class="tab-content">
                <h3>üìù Typography</h3>
                
                <div class="control-group">
                    <label>Primary Font</label>
                    <select id="primary-font">
                        <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">System Font</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="Verdana, Geneva, sans-serif">Verdana</option>
                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        <option value="'Palatino Linotype', 'Book Antiqua', Palatino, serif">Palatino</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Heading Font Size</label>
                    <input type="range" id="heading-size" min="14" max="36" value="24">
                    <div class="range-value">Size: <span id="heading-size-value">24</span>px</div>
                </div>
                
                <div class="control-group">
                    <label>Product Name Font Size</label>
                    <input type="range" id="product-name-size" min="12" max="28" value="18">
                    <div class="range-value">Size: <span id="product-name-size-value">18</span>px</div>
                </div>
                
                <div class="control-group">
                    <label>Price Font Size</label>
                    <input type="range" id="price-font-size" min="14" max="36" value="24">
                    <div class="range-value">Size: <span id="price-font-size-value">24</span>px</div>
                </div>
                
                <div class="control-group">
                    <label>Body Text Size</label>
                    <input type="range" id="body-size" min="10" max="20" value="14">
                    <div class="range-value">Size: <span id="body-size-value">14</span>px</div>
                </div>
                
                <div class="control-group">
                    <label>Line Height</label>
                    <input type="range" id="line-height" min="100" max="200" value="160">
                    <div class="range-value">Height: <span id="line-height-value">160</span>%</div>
                </div>
            </div>
            
            <div id="layout" class="tab-content">
                <h3>üèóÔ∏è Layout & Branding</h3>
                
                <div class="control-group">
                    <label>Logo Upload</label>
                    <div class="logo-preview" id="logo-preview">
                        <span>Click to upload</span>
                    </div>
                    <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                </div>
                
                <div class="control-group">
                    <label>Logo Position</label>
                    <select id="logo-position">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Header Template</label>
                    <div class="template-grid">
                        <div class="template-card" data-template="classic">
                            <div>Classic</div>
                        </div>
                        <div class="template-card" data-template="modern">
                            <div>Modern</div>
                        </div>
                        <div class="template-card" data-template="minimal">
                            <div>Minimal</div>
                        </div>
                        <div class="template-card" data-template="bold">
                            <div>Bold</div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Footer Template</label>
                    <textarea id="footer-template" placeholder="Enter footer HTML template...">
&lt;footer&gt;
  &lt;p&gt;¬© 2025 Market Name. All rights reserved.&lt;/p&gt;
&lt;/footer&gt;</textarea>
                </div>
                
                <div class="control-group">
                    <label>Custom CSS</label>
                    <textarea id="custom-css" placeholder="/* Your custom CSS */"></textarea>
                </div>
            </div>
            
            <div id="presets" class="tab-content">
                <h3>üé® Theme Presets</h3>
                
                <div class="preset-themes">
                    <div class="preset-theme" data-preset="professional">
                        <h4>Professional</h4>
                        <p>Clean and corporate look</p>
                        <div class="color-palette">
                            <div class="color-sample" style="background: #1e3a8a;"></div>
                            <div class="color-sample" style="background: #333;"></div>
                            <div class="color-sample" style="background: #c41e3a;"></div>
                            <div class="color-sample" style="background: #fff;"></div>
                        </div>
                    </div>
                    
                    <div class="preset-theme" data-preset="colorful">
                        <h4>Colorful</h4>
                        <p>Vibrant and energetic</p>
                        <div class="color-palette">
                            <div class="color-sample" style="background: #f59e0b;"></div>
                            <div class="color-sample" style="background: #2563eb;"></div>
                            <div class="color-sample" style="background: #dc2626;"></div>
                            <div class="color-sample" style="background: #fef3c7;"></div>
                        </div>
                    </div>
                    
                    <div class="preset-theme" data-preset="minimal">
                        <h4>Minimal</h4>
                        <p>Simple and elegant</p>
                        <div class="color-palette">
                            <div class="color-sample" style="background: #000;"></div>
                            <div class="color-sample" style="background: #666;"></div>
                            <div class="color-sample" style="background: #999;"></div>
                            <div class="color-sample" style="background: #fff;"></div>
                        </div>
                    </div>
                    
                    <div class="preset-theme" data-preset="modern">
                        <h4>Modern</h4>
                        <p>Contemporary design</p>
                        <div class="color-palette">
                            <div class="color-sample" style="background: #6366f1;"></div>
                            <div class="color-sample" style="background: #1f2937;"></div>
                            <div class="color-sample" style="background: #ef4444;"></div>
                            <div class="color-sample" style="background: #f9fafb;"></div>
                        </div>
                    </div>
                    
                    <div class="preset-theme" data-preset="nature">
                        <h4>Nature</h4>
                        <p>Earth tones and organic</p>
                        <div class="color-palette">
                            <div class="color-sample" style="background: #059669;"></div>
                            <div class="color-sample" style="background: #7c2d12;"></div>
                            <div class="color-sample" style="background: #ca8a04;"></div>
                            <div class="color-sample" style="background: #f7fee7;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>

        <div class="panel panel-right">
            <h3>üëÅÔ∏è Live Preview</h3>
            <iframe id="preview" class="preview-frame"></iframe>
        </div>
    </div>

    <script>
        // Theme presets
        const themePresets = {
            professional: {
                primaryColor: '#1e3a8a',
                secondaryColor: '#1e40af',
                accentColor: '#c41e3a',
                bgColor: '#ffffff',
                textColor: '#333333',
                priceColor: '#c41e3a',
                font: 'Georgia, serif'
            },
            colorful: {
                primaryColor: '#f59e0b',
                secondaryColor: '#2563eb',
                accentColor: '#dc2626',
                bgColor: '#fef3c7',
                textColor: '#2563eb',
                priceColor: '#dc2626',
                font: 'Verdana, Geneva, sans-serif'
            },
            minimal: {
                primaryColor: '#000000',
                secondaryColor: '#333333',
                accentColor: '#666666',
                bgColor: '#ffffff',
                textColor: '#000000',
                priceColor: '#666666',
                font: 'Arial, sans-serif'
            },
            modern: {
                primaryColor: '#6366f1',
                secondaryColor: '#4f46e5',
                accentColor: '#ef4444',
                bgColor: '#f9fafb',
                textColor: '#1f2937',
                priceColor: '#ef4444',
                font: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
            },
            nature: {
                primaryColor: '#059669',
                secondaryColor: '#047857',
                accentColor: '#ca8a04',
                bgColor: '#f7fee7',
                textColor: '#1f2937',
                priceColor: '#7c2d12',
                font: "'Trebuchet MS', sans-serif"
            }
        };

        let currentTheme = {};
        let originalHtml = '';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCurrentTheme();
            setupEventListeners();
            generateColorSchemes();
            updatePreview();
        });
        
        async function loadCurrentTheme() {
            try {
                const res = await fetch('/api/theme');
                originalHtml = await res.text();
                
                const res2 = await fetch('/api/custom-theme/active');
                const data = await res2.json();
                
                if (data.success && data.theme) {
                    applyThemeToControls(data.theme);
                }
            } catch (e) {
                showStatus('Failed to load theme', 'error');
            }
        }
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            // Color inputs
            ['primary-color', 'secondary-color', 'accent-color', 'bg-color', 'text-color', 'price-color'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            
            // Typography inputs
            ['primary-font', 'heading-size', 'product-name-size', 'price-font-size', 'body-size', 'line-height'].forEach(id => {
                const elem = document.getElementById(id);
                elem.addEventListener('input', (e) => {
                    const valueElem = document.getElementById(id + '-value');
                    if (valueElem) valueElem.textContent = e.target.value;
                    updatePreview();
                });
            });
            
            // Brightness slider
            document.getElementById('primary-brightness').addEventListener('input', (e) => {
                document.getElementById('primary-brightness-value').textContent = e.target.value;
                updatePreview();
            });
            
            // Logo upload
            document.getElementById('logo-preview').addEventListener('click', () => {
                document.getElementById('logo-upload').click();
            });
            
            document.getElementById('logo-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('logo-preview');
                        preview.innerHTML = `<img src="${e.target.result}" alt="Logo">`;
                        currentTheme.logoUrl = e.target.result;
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Template selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    currentTheme.headerTemplate = card.dataset.template;
                    updatePreview();
                });
            });
            
            // Preset themes
            document.querySelectorAll('.preset-theme').forEach(preset => {
                preset.addEventListener('click', () => {
                    document.querySelectorAll('.preset-theme').forEach(p => p.classList.remove('active'));
                    preset.classList.add('active');
                    const theme = themePresets[preset.dataset.preset];
                    applyThemeToControls(theme);
                    updatePreview();
                });
            });
            
            // Generate color scheme
            document.getElementById('generate-scheme').addEventListener('click', generateColorSchemes);
            
            // Custom CSS
            document.getElementById('custom-css').addEventListener('input', updatePreview);
            
            // Action buttons
            document.getElementById('save-theme-btn').addEventListener('click', saveTheme);
            document.getElementById('apply-theme-btn').addEventListener('click', applyTheme);
            document.getElementById('export-theme-btn').addEventListener('click', exportTheme);
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = '/admin';
            });
        }
        
        function applyThemeToControls(theme) {
            if (theme.primaryColor) document.getElementById('primary-color').value = theme.primaryColor;
            if (theme.secondaryColor) document.getElementById('secondary-color').value = theme.secondaryColor;
            if (theme.accentColor) document.getElementById('accent-color').value = theme.accentColor;
            if (theme.bgColor) document.getElementById('bg-color').value = theme.bgColor;
            if (theme.textColor) document.getElementById('text-color').value = theme.textColor;
            if (theme.priceColor) document.getElementById('price-color').value = theme.priceColor;
            if (theme.font) document.getElementById('primary-font').value = theme.font;
        }
        
        function generateColorSchemes() {
            const baseColor = document.getElementById('primary-color').value;
            const schemes = [
                generateMonochromaticScheme(baseColor),
                generateComplementaryScheme(baseColor),
                generateTriadicScheme(baseColor),
                generateAnalogousScheme(baseColor)
            ];
            
            const container = document.getElementById('color-schemes');
            container.innerHTML = schemes.map((scheme, i) => 
                `<div class="color-box" data-scheme="${i}" style="background: linear-gradient(90deg, ${scheme.join(', ')})"></div>`
            ).join('');
            
            container.querySelectorAll('.color-box').forEach((box, i) => {
                box.addEventListener('click', () => {
                    container.querySelectorAll('.color-box').forEach(b => b.classList.remove('selected'));
                    box.classList.add('selected');
                    const scheme = schemes[i];
                    document.getElementById('primary-color').value = scheme[0];
                    document.getElementById('secondary-color').value = scheme[1];
                    document.getElementById('accent-color').value = scheme[2];
                    updatePreview();
                });
            });
        }
        
        function generateMonochromaticScheme(base) {
            const hsl = hexToHsl(base);
            return [
                base,
                hslToHex(hsl[0], hsl[1], Math.max(20, hsl[2] - 20)),
                hslToHex(hsl[0], hsl[1], Math.min(80, hsl[2] + 20)),
                hslToHex(hsl[0], hsl[1] * 0.5, hsl[2])
            ];
        }
        
        function generateComplementaryScheme(base) {
            const hsl = hexToHsl(base);
            return [
                base,
                hslToHex((hsl[0] + 180) % 360, hsl[1], hsl[2]),
                hslToHex((hsl[0] + 30) % 360, hsl[1], hsl[2]),
                hslToHex((hsl[0] + 210) % 360, hsl[1], hsl[2])
            ];
        }
        
        function generateTriadicScheme(base) {
            const hsl = hexToHsl(base);
            return [
                base,
                hslToHex((hsl[0] + 120) % 360, hsl[1], hsl[2]),
                hslToHex((hsl[0] + 240) % 360, hsl[1], hsl[2]),
                hslToHex(hsl[0], hsl[1] * 0.7, hsl[2] * 1.2)
            ];
        }
        
        function generateAnalogousScheme(base) {
            const hsl = hexToHsl(base);
            return [
                base,
                hslToHex((hsl[0] + 30) % 360, hsl[1], hsl[2]),
                hslToHex((hsl[0] - 30 + 360) % 360, hsl[1], hsl[2]),
                hslToHex(hsl[0], hsl[1] * 0.8, hsl[2] * 0.9)
            ];
        }
        
        function hexToHsl(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return [h * 360, s * 100, l * 100];
        }
        
        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c/2;
            let r = 0, g = 0, b = 0;
            
            if (0 <= h && h < 60) { r = c; g = x; b = 0; }
            else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
            else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
            else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
            else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
            else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
            
            r = Math.round((r + m) * 255).toString(16).padStart(2, '0');
            g = Math.round((g + m) * 255).toString(16).padStart(2, '0');
            b = Math.round((b + m) * 255).toString(16).padStart(2, '0');
            
            return `#${r}${g}${b}`;
        }
        
        function updatePreview() {
            const primaryColor = document.getElementById('primary-color').value;
            const secondaryColor = document.getElementById('secondary-color').value;
            const accentColor = document.getElementById('accent-color').value;
            const bgColor = document.getElementById('bg-color').value;
            const textColor = document.getElementById('text-color').value;
            const priceColor = document.getElementById('price-color').value;
            const font = document.getElementById('primary-font').value;
            const headingSize = document.getElementById('heading-size').value;
            const productNameSize = document.getElementById('product-name-size').value;
            const priceFontSize = document.getElementById('price-font-size').value;
            const bodySize = document.getElementById('body-size').value;
            const lineHeight = document.getElementById('line-height').value;
            const customCss = document.getElementById('custom-css').value;
            const footerTemplate = document.getElementById('footer-template').value;
            const brightness = document.getElementById('primary-brightness').value;
            
            // Apply brightness adjustment
            const adjustedPrimary = adjustBrightness(primaryColor, brightness);
            
            const css = `
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: ${font};
                    background: ${bgColor};
                    color: ${textColor};
                    line-height: ${lineHeight / 100};
                    font-size: ${bodySize}px;
                }
                h1, h2, h3 {
                    font-size: ${headingSize}px;
                    color: ${adjustedPrimary};
                }
                .product-name {
                    font-size: ${productNameSize}px;
                    color: ${textColor};
                }
                .price {
                    font-size: ${priceFontSize}px;
                    color: ${priceColor};
                }
                .btn-primary, .upload-box {
                    background: linear-gradient(135deg, ${adjustedPrimary} 0%, ${secondaryColor} 100%);
                }
                .btn-accent {
                    background: ${accentColor};
                }
                .header-bar {
                    border-bottom-color: ${adjustedPrimary};
                }
                ${customCss}
            `;
            
            // Create preview HTML
            let previewHtml = originalHtml;
            
            // Inject new CSS
            const styleMatch = previewHtml.match(/<style>([\s\S]*?)<\/style>/);
            if (styleMatch) {
                previewHtml = previewHtml.replace(styleMatch[0], `<style>${css}</style>`);
            } else {
                previewHtml = previewHtml.replace('</head>', `<style>${css}</style></head>`);
            }
            
            // Add footer if provided
            if (footerTemplate) {
                previewHtml = previewHtml.replace('</body>', `${footerTemplate}</body>`);
            }
            
            // Update preview iframe
            const preview = document.getElementById('preview');
            const doc = preview.contentDocument || preview.contentWindow.document;
            doc.open();
            doc.write(previewHtml);
            doc.close();
        }
        
        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, Math.max(0, (num >> 16) + amt));
            const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
            const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
            return `#${(0x1000000 + (R * 0x10000) + (G * 0x100) + B).toString(16).slice(1)}`;
        }
        
        async function saveTheme() {
            try {
                const theme = gatherThemeData();
                const response = await fetch('/api/custom-theme/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(theme)
                });
                
                const data = await response.json();
                if (data.success) {
                    showStatus('‚úÖ Theme saved successfully!', 'success');
                } else {
                    showStatus('‚ùå Failed to save theme', 'error');
                }
            } catch (e) {
                showStatus('‚ùå Error: ' + e.message, 'error');
            }
        }
        
        async function applyTheme() {
            try {
                const theme = gatherThemeData();
                theme.is_active = true;
                
                const response = await fetch('/api/custom-theme/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(theme)
                });
                
                const data = await response.json();
                if (data.success) {
                    showStatus('‚úÖ Theme applied and activated!', 'success');
                } else {
                    showStatus('‚ùå Failed to apply theme', 'error');
                }
            } catch (e) {
                showStatus('‚ùå Error: ' + e.message, 'error');
            }
        }
        
        function exportTheme() {
            const theme = gatherThemeData();
            const blob = new Blob([JSON.stringify(theme, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'theme-export.json';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('‚úÖ Theme exported!', 'success');
        }
        
        function gatherThemeData() {
            const selectedPreset = document.querySelector('.preset-theme.active');
            return {
                name: selectedPreset ? selectedPreset.querySelector('h4').textContent : 'Custom Theme',
                primary_color: document.getElementById('primary-color').value,
                secondary_color: document.getElementById('secondary-color').value,
                accent_color: document.getElementById('accent-color').value,
                font_family: document.getElementById('primary-font').value,
                custom_css: document.getElementById('custom-css').value,
                logo_url: currentTheme.logoUrl || '',
                header_template: currentTheme.headerTemplate || '',
                footer_template: document.getElementById('footer-template').value || '',
                settings: {
                    bgColor: document.getElementById('bg-color').value,
                    textColor: document.getElementById('text-color').value,
                    priceColor: document.getElementById('price-color').value,
                    headingSize: document.getElementById('heading-size').value,
                    productNameSize: document.getElementById('product-name-size').value,
                    priceFontSize: document.getElementById('price-font-size').value,
                    bodySize: document.getElementById('body-size').value,
                    lineHeight: document.getElementById('line-height').value,
                    brightness: document.getElementById('primary-brightness').value
                }
            };
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status show ${type}`;
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }
    </script>
    
    <!-- Ghost Assistant -->
    <script src="/static/js/ghost.js"></script>
</body>
</html>
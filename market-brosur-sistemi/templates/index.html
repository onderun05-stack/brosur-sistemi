<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEUyazÄ±lÄ±m BroÅŸÃ¼r Sistemi</title>
    <link rel="icon" href="/static/favicon.ico">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Fabric.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    
    <!-- Fabric.js textBaseline Fix - 'alphabetical' -> 'alphabetic' -->
    <script>
    (function() {
        if (!window.fabric) return;
        
        // Patch Object.set to fix invalid textBaseline values
        const originalSet = fabric.Object.prototype.set;
        fabric.Object.prototype.set = function(key, value) {
            if (key === 'textBaseline' && value === 'alphabetical') {
                value = 'alphabetic';
            }
            if (typeof key === 'object') {
                for (let k in key) {
                    if (k === 'textBaseline' && key[k] === 'alphabetical') {
                        key[k] = 'alphabetic';
                    }
                }
            }
            return originalSet.call(this, key, value);
        };
        
        // Patch Text initialization
        const originalTextInit = fabric.Text.prototype.initialize;
        fabric.Text.prototype.initialize = function(text, options) {
            if (options && options.textBaseline === 'alphabetical') {
                options.textBaseline = 'alphabetic';
            }
            return originalTextInit.call(this, text, options);
        };
        
        // Patch Textbox initialization
        if (fabric.Textbox) {
            const originalTextboxInit = fabric.Textbox.prototype.initialize;
            fabric.Textbox.prototype.initialize = function(text, options) {
                if (options && options.textBaseline === 'alphabetical') {
                    options.textBaseline = 'alphabetic';
                }
                return originalTextboxInit.call(this, text, options);
            };
        }
        
        // Patch IText if exists
        if (fabric.IText) {
            const originalITextInit = fabric.IText.prototype.initialize;
            fabric.IText.prototype.initialize = function(text, options) {
                if (options && options.textBaseline === 'alphabetical') {
                    options.textBaseline = 'alphabetic';
                }
                return originalITextInit.call(this, text, options);
            };
        }
        
        // Also patch the canvas context directly as last resort
        const originalTextBaseline = Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype, 'textBaseline');
        if (originalTextBaseline && originalTextBaseline.set) {
            Object.defineProperty(CanvasRenderingContext2D.prototype, 'textBaseline', {
                get: originalTextBaseline.get,
                set: function(val) {
                    if (val === 'alphabetical') val = 'alphabetic';
                    originalTextBaseline.set.call(this, val);
                },
                configurable: true
            });
        }
        
        console.log('âœ… Fabric.js textBaseline patch applied');
    })();
    </script>
    
    <!-- Interact.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <!-- Multipage Editor CSS -->
    <link href="/static/css/multipage_editor.css" rel="stylesheet">
    <!-- Glassmorphism UI CSS -->
    <link href="/static/css/glassmorphism.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* GLASSMORPHISM BODY - AÃ§Ä±k Mavi/Cyan Tema */
        body { 
            font-family: -apple-system, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 25%, #7dd3fc 50%, #a5f3fc 75%, #cffafe 100%);
            min-height: 100vh;
            position: relative;
            color: #1e3a5f;
        }
        
        /* AltÄ±n/SarÄ± parlama - saÄŸ alt */
        body::before {
            content: '';
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.5) 0%, rgba(245, 158, 11, 0.25) 30%, transparent 60%);
            bottom: -150px;
            right: -100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: floatYellow 20s ease-in-out infinite;
        }
        
        /* Cyan bÃ¼yÃ¼k daire - saÄŸ Ã¼st */
        body::after {
            content: '';
            position: fixed;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(34, 211, 238, 0.4) 0%, rgba(6, 182, 212, 0.15) 40%, transparent 70%);
            top: -100px;
            right: 10%;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: floatCyan 25s ease-in-out infinite;
        }
        
        @keyframes floatYellow {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-20px, -15px) scale(1.05); }
            50% { transform: translate(-10px, 10px) scale(0.95); }
            75% { transform: translate(15px, -8px) scale(1.02); }
        }
        
        @keyframes floatCyan {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(15px, 20px) scale(1.08); }
            66% { transform: translate(-20px, 8px) scale(0.95); }
        }
        
        .screen { width: 100%; }
        .hidden { display: none !important; }
        
        /* Extra Decorative Shapes */
        .glass-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .glass-shape-1 {
            position: absolute;
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, rgba(167, 139, 250, 0.3) 0%, rgba(139, 92, 246, 0.1) 40%, transparent 70%);
            top: 20%;
            left: -80px;
            border-radius: 50%;
            animation: shapeFloat1 18s ease-in-out infinite;
        }
        
        .glass-shape-2 {
            position: absolute;
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, transparent 60%);
            bottom: 25%;
            left: 8%;
            border-radius: 50%;
            animation: shapeFloat2 22s ease-in-out infinite;
        }
        
        .glass-shape-3 {
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
            top: 35%;
            left: 25%;
            border-radius: 50%;
            animation: shapeFloat3 15s ease-in-out infinite;
        }
        
        .glass-line-1 {
            position: absolute;
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.4), transparent);
            top: 30%;
            left: 15%;
            transform: rotate(-15deg);
            animation: linePulse 4s ease-in-out infinite;
        }
        
        .glass-line-2 {
            position: absolute;
            width: 150px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            bottom: 40%;
            right: 25%;
            transform: rotate(20deg);
            animation: linePulse 5s ease-in-out infinite 1s;
        }
        
        @keyframes shapeFloat1 {
            0%, 100% { transform: translate(0, 0); opacity: 0.7; }
            50% { transform: translate(-40px, 30px); opacity: 1; }
        }
        
        @keyframes shapeFloat2 {
            0%, 100% { transform: translate(0, 0); opacity: 0.5; }
            50% { transform: translate(30px, -40px); opacity: 0.8; }
        }
        
        @keyframes shapeFloat3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(50px, -30px) scale(1.1); }
        }
        
        @keyframes linePulse {
            0%, 100% { opacity: 0.3; transform: scaleX(1); }
            50% { opacity: 0.6; transform: scaleX(1.2); }
        }
        
        /* MAIN SCREEN */
        #main-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }
        
        /* TOP SECTION - 5 CARDS RESPONSIVE GRID - GLASSMORPHISM */
        .top-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 32px 40px;
            display: grid;
            grid-template-columns: 1.3fr 0.9fr 1.1fr 0.7fr 1fr;
            /* Excel, Logo, Åžirket Bilgileri, Sosyal Medya (YARI GENÄ°ÅžLÄ°K), Kredi */
            gap: 12px;
            align-items: stretch;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        @media (max-width: 1024px) {
            .top-section {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 800px) {
            .top-section {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .top-section {
                grid-template-columns: 1fr;
            }
        }
        
        /* Sosyal Medya Kompakt Stiller - YARI GENÄ°ÅžLÄ°K */
        .social-media-card {
            max-width: 100%;
            grid-column: span 1;
        }
        
        #social-media-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .social-media-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            font-size: 12px;
            position: relative;
        }
        
        .social-platform-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 13px;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .social-platform-btn:hover {
            transform: scale(1.3);
        }
        
        .social-platform-btn:focus {
            outline: 2px solid #d2b48c;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        .social-media-item .fa-twitter { color: #1DA1F2; }
        .social-media-item .fa-facebook { color: #4267B2; }
        .social-media-item .fa-instagram { color: #E1306C; }
        .social-media-item .fa-linkedin { color: #0077B5; }
        .social-media-item .fa-tiktok { color: #000000; }
        .social-media-item .fa-youtube { color: #FF0000; }
        .social-media-item .fa-whatsapp { color: #25D366; }
        
        .social-media-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 11px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        
        .social-media-item input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(210, 180, 140, 0.3);
        }
        
        .social-media-item select {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        .social-media-item .remove-social-btn {
            background: #d2b48c;
            color: #5a4a3a;
            border: 1px solid #5a4a3a;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: absolute;
            top: 2px;
            right: 2px;
        }
        
        .add-social-btn {
            width: 100%;
            padding: 6px;
            background: rgba(210, 180, 140, 0.2);
            color: #5a4a3a;
            border: 1px solid #d2b48c;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            grid-column: 1 / -1;
            box-shadow: 0 0 5px rgba(210, 180, 140, 0.4);
        }
        
        .add-social-btn:hover {
            background: rgba(210, 180, 140, 0.4);
            box-shadow: 0 0 15px rgba(210, 180, 140, 0.6);
        }
        
        #social-media-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .social-media-wrapper {
            flex: 3;
        }
        
        .meal-cards-wrapper {
            flex: 1;
            border-top: 3px solid #d2b48c;
            padding-top: 10px;
            margin-top: 5px;
            box-shadow: 0 -2px 10px rgba(210, 180, 140, 0.3);
        }
        
        .top-card {
            padding: 24px;
            border-radius: 16px;
            border: 2px solid #d2b48c;
            transition: all 0.3s ease;
            height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            color: #ffffff;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }
        
        .top-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Card 1 - Excel Upload (Glassmorphism) */
        .upload-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .upload-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .info-card {
            color: #ffffff;
        }
        
        /* Card 2 - Logo (Glassmorphism) */
        .info-card:nth-child(2) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .info-card:nth-child(2):hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Card 3 - Company Info (Glassmorphism) */
        .info-card:nth-child(3) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .info-card:nth-child(3):hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Card 4 - Social Media (Glassmorphism) */
        .info-card:nth-child(4) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .info-card:nth-child(4):hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Card 5 - Credit (Glassmorphism) */
        .credit-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            width: 75%;
            height: 290px;
        }
        
        .credit-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .credit-balance-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .credit-balance-amount {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 10px 0;
        }
        
        .credit-info-text {
            font-size: 12px;
            opacity: 0.9;
            text-align: center;
            margin-top: 10px;
        }
        
        /* Toggle Section Styles */
        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .toggle-header h3 {
            margin: 0;
        }
        
        .toggle-btn {
            padding: 6px 12px;
            background: rgba(210, 180, 140, 0.3);
            color: #5a4a3a;
            border: 1px solid #d2b48c;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .toggle-btn:hover {
            background: rgba(210, 180, 140, 0.5);
            transform: translateY(-1px);
        }
        
        .toggle-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .toggle-content.open {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .format-info {
            font-size: 9px;
            color: #5a4a3a;
            margin-top: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            text-align: center;
            border: 1px solid #d2b48c;
            line-height: 1.4;
        }
        
        .top-card h3 {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #5a4a3a;
            letter-spacing: -0.5px;
        }
        
        .input-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            opacity: 0.8;
            color: #5a4a3a;
            letter-spacing: 0.5px;
            display: block;
        }
        
        .upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 18px;
            background: rgba(210, 180, 140, 0.4);
            color: #5a4a3a;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
            border: 2px solid #d2b48c;
            transition: all 0.2s ease;
        }
        
        .upload-label:hover {
            transform: translateY(-1px);
            background: rgba(210, 180, 140, 0.6);
            box-shadow: 0 4px 12px rgba(210, 180, 140, 0.5);
        }
        
        .btn-template {
            width: 100%;
            padding: 12px 16px;
            background: rgba(210, 180, 140, 0.4);
            color: #5a4a3a;
            border: 2px solid #d2b48c;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 8px;
        }
        
        .btn-template:hover {
            background: rgba(210, 180, 140, 0.6);
        }
        
        .upload-card p {
            font-size: 11px;
            margin-top: 8px;
            color: #5a4a3a;
        }
        
        .logo-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            border: 2px dashed #d2b48c;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            background: rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-preview-text {
            color: #5a4a3a;
            font-size: 12px;
            text-align: center;
            opacity: 0.8;
        }
        
        .btn-logo-select {
            width: auto;
            padding: 10px 16px;
            background: rgba(210, 180, 140, 0.4);
            color: #5a4a3a;
            border: 2px solid #d2b48c;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: block;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        
        .btn-logo-select:hover {
            background: rgba(210, 180, 140, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(210, 180, 140, 0.5);
        }
        
        .company-input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 2px solid #d2b48c;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.95);
            color: #5a4a3a;
            box-shadow: 0 2px 8px rgba(210, 180, 140, 0.2);
            transition: all 0.2s ease;
        }
        
        .company-input:focus {
            outline: none;
            border: 2px solid #d2b48c;
            box-shadow: 0 0 0 3px rgba(210, 180, 140, 0.3);
        }
        
        .company-textarea {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 2px solid #d2b48c;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 60px;
            background: rgba(255, 255, 255, 0.95);
            color: #5a4a3a;
            box-shadow: 0 2px 8px rgba(210, 180, 140, 0.2);
            transition: all 0.2s ease;
        }
        
        .company-textarea:focus {
            outline: none;
            border: 2px solid #d2b48c;
            box-shadow: 0 0 0 3px rgba(210, 180, 140, 0.3);
        }
        
        /* MIDDLE SECTION - Sticky Wrapper */
        .middle-section {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 0;
            margin: 0;
        }
        
        /* ACTION BUTTONS */
        .action-buttons {
            background: white;
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            overflow-x: auto;
            border-bottom: 1px solid #e0e0e0;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }
        
        .action-buttons::-webkit-scrollbar {
            height: 6px;
        }
        
        .action-buttons::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        .action-buttons::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
        
        .btn-action {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: #667eea;
            color: white;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        /* KÄ±rmÄ±zÄ±/Turuncu Gradient - Åžablon YÃ¼kle */
        .btn-action.btn-red-orange {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        }
        .btn-action.btn-red-orange:hover {
            box-shadow: 0 6px 12px rgba(239, 68, 68, 0.4);
        }
        
        /* YeÅŸil - AI Tasarla, AI BroÅŸÃ¼r */
        .btn-action.btn-green {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        .btn-action.btn-green:hover {
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
        }
        
        /* Mavi - Ä°ndirim Åžablonu, AI Slogan */
        .btn-action.btn-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        .btn-action.btn-blue:hover {
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
        }
        
        /* Pembe - Tema, AI Otomatik */
        .btn-action.btn-pink {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        }
        .btn-action.btn-pink:hover {
            box-shadow: 0 6px 12px rgba(236, 72, 153, 0.4);
        }
        
        /* Mor - PDF, JPEG, Instagram */
        .btn-action.btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }
        .btn-action.btn-purple:hover {
            box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
        }
        
        /* Action Bar Dropdown */
        .action-dropdown {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            white-space: nowrap;
            flex-shrink: 0;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 35px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all 0.2s ease;
        }
        
        .action-dropdown:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        /* EDITOR AREA */
        .editor-area {
            display: flex;
            gap: 15px;
            padding: 15px;
            flex: 1;
        }
        
        .sidebar-left {
            background: rgba(10, 14, 39, 0.8);
            border-radius: 10px;
            padding: 15px;
            width: 250px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .sidebar-left h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        /* Ä°ndirimli ÃœrÃ¼n Listesi Hover */
        .discount-product-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: grab;
            background: rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .discount-product-item:hover {
            background: rgba(245, 158, 11, 0.3) !important;
            transform: translateX(3px);
        }
        .discount-product-item img {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .discount-product-item .product-name {
            flex: 1;
            font-size: 11px;
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .discount-product-item .product-price {
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .discount-product-item .product-price.has-price {
            color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }
        .discount-product-item .product-price.no-price {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }
        .discount-product-item .product-price:hover {
            transform: scale(1.1);
        }
        
        .hint {
            font-size: 10px;
            color: #e0e0e0;
            background: rgba(0, 255, 255, 0.1);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #00ffff;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.2);
        }
        
        #products-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .product-item {
            background: rgba(10, 14, 39, 0.7);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            cursor: grab;
            transition: all 0.3s;
            font-size: 11px;
            position: relative;
            color: #e0e0e0;
        }
        
        .product-item:hover {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .product-price {
            font-size: 10px;
            margin-bottom: 6px;
        }
        
        .product-action {
            font-size: 9px;
            background: rgba(0, 255, 255, 0.2);
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin-top: 4px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .product-action:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .search-term {
            background: #f0f9ff;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-term:hover {
            background: #667eea;
            color: white;
        }
        
        .image-input-group {
            margin-top: 15px;
        }
        
        .image-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-buttons .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .modal-buttons .btn-close {
            background: #ccc;
            color: #333;
        }
        
        .canvas-center {
            flex: 1;
            background: rgba(10, 14, 39, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-shadow: inset 0 0 20px rgba(255, 0, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 255, 0.3);
            overflow: hidden;
        }
        
        #canvas {
            border: 2px dashed rgba(255, 0, 255, 0.4);
            border-radius: 8px;
            background: rgba(10, 14, 39, 0.5);
            max-width: 100%;
            max-height: 100%;
        }
        
        .sidebar-right {
            background: rgba(10, 14, 39, 0.8);
            border-radius: 10px;
            padding: 15px;
            width: 250px;
            overflow-y: auto;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .sidebar-right h3 {
            font-size: 13px;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .parking-header {
            position: sticky;
            top: 0;
            z-index: 90;
            background: rgba(10, 14, 39, 0.95);
            padding-bottom: 10px;
            margin-bottom: 0;
        }
        
        #parking-area {
            min-height: 100px;
            background: rgba(10, 14, 39, 0.7);
            border-radius: 6px;
            padding: 10px;
            border: 2px dashed rgba(0, 255, 255, 0.4);
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.1);
        }
        
        /* PAGE TABS */
        .page-tabs {
            position: sticky;
            top: 0;
            z-index: 90;
            background: rgba(10, 14, 39, 0.95);
            padding: 10px;
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #00ffff;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
        }
        
        .page-tab {
            padding: 4px 8px;
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 9px;
            transition: all 0.3s;
            color: #e0e0e0;
        }
        
        .page-tab:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }
        
        .page-tab.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }
        
        .page-tab.add-page {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        /* CANVAS CONTROLS */
        .canvas-controls {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        
        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding: 0 10px;
            border-right: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .control-group:last-child {
            border-right: none;
        }
        
        .control-label {
            font-size: 11px;
            color: #e0e0e0;
            margin-right: 5px;
        }
        
        .control-btn {
            padding: 5px 10px;
            background: rgba(10, 14, 39, 0.7);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            color: #e0e0e0;
        }
        
        .control-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .control-btn.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }
        
        select.control-select {
            padding: 5px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 11px;
            background: rgba(10, 14, 39, 0.7);
            color: #ffffff;
        }
        
        input.control-input {
            width: 60px;
            padding: 5px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 11px;
            background: rgba(10, 14, 39, 0.7);
            color: #ffffff;
        }
        
        /* PARKING COUNTER */
        .parking-counter {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
            border: 1px solid #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        #canvas-container {
            position: relative;
            display: inline-block;
            min-height: 1200px;
        }
        
        #brochure-canvas {
            border: 3px solid #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
        }
        
        /* THEME MODAL STYLES */
        .theme-tab {
            padding: 12px 20px;
            background: white;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        
        .theme-tab:hover {
            color: #f093fb;
            background: #fef5ff;
        }
        
        .theme-tab.active {
            color: #f5576c;
            border-bottom-color: #f5576c;
            background: #fff5f7;
        }
        
        .theme-tab-content {
            display: none;
        }
        
        .theme-tab-content.active {
            display: block;
        }
        
        .gradient-box {
            height: 80px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .gradient-box:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        
        .template-card {
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #eee;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #f093fb;
        }
        
        .template-preview {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .border-card {
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border-radius: 12px;
            padding: 10px;
            border: 2px solid #eee;
        }
        
        .border-card:hover {
            border-color: #f093fb;
            background: #fef5ff;
        }
        
        .border-preview {
            height: 80px;
            margin-bottom: 10px;
            background: white;
        }
        
        .font-card {
            cursor: pointer;
            transition: all 0.3s;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #eee;
            background: white;
        }
        
        .font-card:hover {
            border-color: #f093fb;
            background: #fef5ff;
        }
        
        .theme-apply-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
        }
        
        /* Neon Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(10, 14, 39, 0.5);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ffff, #ff00ff);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }
        
        /* Main Header Neon Glow */
        #main-screen > div:first-child {
            background: rgba(10, 14, 39, 0.9) !important;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid transparent;
            border-image: linear-gradient(90deg, #00ffff, #ff00ff, #00ffff) 1;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.5),
                0 0 40px rgba(255, 0, 255, 0.3),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        /* Settings Modal Tab Hover Effects */
        .settings-tab:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            color: white !important;
        }
        
        .settings-tab.active {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            border-bottom-color: white !important;
        }
    </style>
</head>
<body>
    <!-- GLASSMORPHISM DECORATIVE SHAPES -->
    <div class="glass-shapes">
        <div class="glass-shape-1"></div>
        <div class="glass-shape-2"></div>
        <div class="glass-shape-3"></div>
        <div class="glass-line-1"></div>
        <div class="glass-line-2"></div>
    </div>
    
    <!-- MAIN SCREEN -->
    <div id="main-screen" class="screen" style="display: none;">
        <!-- MAIN TITLE -->
        <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 18px 40px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);">
            <h1 style="background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; font-weight: 800; letter-spacing: -0.5px; margin: 0;">
                âœ¨ AEUyazÄ±lÄ±m BroÅŸÃ¼r Sistemi
            </h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div id="welcome-message" style="font-size: 18px; font-weight: 600; color: #667eea;">HOÅž GELDÄ°N SAYIN KULLANICI</div>
                
                <!-- Admin Toggle Button (initially hidden, shown only for admins) -->
                <button id="admin-toggle-btn" onclick="toggleAdminMode()" style="
                    display: none;
                    background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
                    border: none;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-weight: 700;
                    font-size: 14px;
                    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
                    transition: all 0.3s;
                    align-items: center;
                    gap: 8px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(139, 92, 246, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(139, 92, 246, 0.4)';">
                    <span id="admin-mode-text">ðŸ”§ Admin DÃ¼zenleme Modu</span>
                </button>
            </div>
        </div>

        <!-- Hidden file inputs -->
        <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display:none">
        <input type="file" id="template-upload-input" accept=".png,.jpg,.jpeg,.json" style="display:none">
        <input type="file" id="company-logo-input" accept="image/*" style="display: none;">

        <!-- 4 LARGE GLASSMORPHIC BUTTONS -->
        <div style="padding: 40px; background: linear-gradient(135deg, #fdf5e6 0%, #faebd7 50%, #ffe4c4 100%); display: flex; justify-content: center; align-items: center; gap: 20px;">
            <button id="btn-product-upload" onclick="window.location.href='/pre-approval'" style="
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 16px;
                padding: 32px 40px;
                cursor: pointer;
                font-weight: 700;
                font-size: 18px;
                color: #667eea;
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.25);
                transition: all 0.3s;
                min-width: 220px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(102, 126, 234, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(102, 126, 234, 0.25)';">
                <i class="fas fa-box" style="font-size: 36px;"></i>
                <span>ðŸ“¦ ÃœrÃ¼n YÃ¼kle</span>
            </button>
            
            <button id="btn-brosur-olustur" onclick="openBrochureWizard()" style="
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 16px;
                padding: 32px 40px;
                cursor: pointer;
                font-weight: 700;
                font-size: 18px;
                color: #10b981;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.25);
                transition: all 0.3s;
                min-width: 220px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(16, 185, 129, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(16, 185, 129, 0.25)';">
                <i class="fas fa-magic" style="font-size: 36px;"></i>
                <span>ðŸŽ¨ BroÅŸÃ¼r OluÅŸtur</span>
            </button>
            
            <button id="btn-settings" onclick="openSettingsModal()" style="
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 16px;
                padding: 32px 40px;
                cursor: pointer;
                font-weight: 700;
                font-size: 18px;
                color: #f59e0b;
                box-shadow: 0 8px 32px rgba(245, 158, 11, 0.25);
                transition: all 0.3s;
                min-width: 220px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(245, 158, 11, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(245, 158, 11, 0.25)';">
                <i class="fas fa-cog" style="font-size: 36px;"></i>
                <span>âš™ï¸ Ayarlar</span>
            </button>
            
            <!-- Site YÃ¶netimi Butonu (Admin Only) -->
            <button id="btn-site-management" onclick="window.location.href='/admin/site-management'" style="
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 16px;
                padding: 32px 40px;
                cursor: pointer;
                font-weight: 700;
                font-size: 18px;
                color: #8b5cf6;
                box-shadow: 0 8px 32px rgba(139, 92, 246, 0.25);
                transition: all 0.3s;
                min-width: 220px;
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(139, 92, 246, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(139, 92, 246, 0.25)';">
                <i class="fas fa-shield-alt" style="font-size: 36px;"></i>
                <span>ðŸ›¡ï¸ Site YÃ¶netimi</span>
            </button>
            
            <button id="btn-logout" onclick="logout()" style="
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 16px;
                padding: 32px 40px;
                cursor: pointer;
                font-weight: 700;
                font-size: 18px;
                color: #ef4444;
                box-shadow: 0 8px 32px rgba(239, 68, 68, 0.25);
                transition: all 0.3s;
                min-width: 220px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(239, 68, 68, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(239, 68, 68, 0.25)';">
                <i class="fas fa-sign-out-alt" style="font-size: 36px;"></i>
                <span>ðŸšª Ã‡Ä±kÄ±ÅŸ</span>
            </button>
        </div>

        <!-- MIDDLE SECTION - Sticky Action Buttons Wrapper -->
        <div class="middle-section">
            <!-- ACTION BUTTONS -->
            <div class="action-buttons">
            <!-- 1. Åžablon YÃ¼kle - KÄ±rmÄ±zÄ±/Turuncu -->
            <button class="btn-action btn-red-orange" onclick="document.getElementById('template-upload-input').click()">
                <span>ðŸŽ¨</span> Åžablon YÃ¼kle
            </button>
            
            <!-- 2. AI ile Åžablon Tasarla - YeÅŸil -->
            <button class="btn-action btn-green" id="ai-template-btn">
                <span>ðŸ¤–</span> AI ile Åžablon Tasarla
            </button>
            
            <!-- 3. Ä°ndirim Åžablonu SeÃ§in - Mavi Dropdown -->
            <select id="template-selector" class="action-dropdown" onchange="applyDiscountTemplate()">
                <option value="">ðŸ“‘ Ä°ndirim Åžablonu SeÃ§in</option>
                <option value="super-friday">ðŸŽ¯ SÃ¼per Cuma FÄ±rsatlarÄ±</option>
                <option value="discount-50">ðŸ’¥ %50'ye Varan Ä°ndirimler</option>
                <option value="week-campaign">ðŸ“… HaftanÄ±n KampanyasÄ±</option>
                <option value="season-end">ðŸ›ï¸ Sezon Sonu Ä°ndirimi</option>
                <option value="new-year">ðŸŽ„ YÄ±lbaÅŸÄ± Ã–zel</option>
                <option value="school">ðŸ“š Okul AlÄ±ÅŸveriÅŸi</option>
                <option value="custom">âœ¨ Ã–zel Åžablon</option>
            </select>
            
            <!-- 4. AI BroÅŸÃ¼r OluÅŸtur - YeÅŸil -->
            <button class="btn-action btn-green" id="ai-generate-btn">
                <span>ðŸŽ¨</span> AI BroÅŸÃ¼r OluÅŸtur
            </button>
            
            <!-- 5. Tema Ã–zelleÅŸtir - Pembe -->
            <button class="btn-action btn-pink" id="theme-customize-btn">
                <span>ðŸŒˆ</span> Tema Ã–zelleÅŸtir
            </button>
            
            <!-- 6. AI Otomatik DÃ¼zenle - Pembe -->
            <button class="btn-action btn-pink" id="auto-layout-btn">
                <span>ðŸ¤–</span> AI Otomatik DÃ¼zenle
            </button>
            
            <!-- 7. AI Slogan Ekle - Mavi -->
            <button class="btn-action btn-blue" id="ai-slogan-btn">
                <span>ðŸ¤–</span> AI Slogan Ekle
            </button>
            
            <!-- 8. PDF Ä°ndir - Mor -->
            <button class="btn-action btn-purple" id="pdf-btn">
                <span>ðŸ“„</span> PDF Ä°ndir
            </button>
            
            <!-- 9. JPEG Ä°ndir - Mor -->
            <button class="btn-action btn-purple" id="jpeg-btn">
                <span>ðŸ“¦</span> JPEG Ä°ndir
            </button>
            
            <!-- 10. Instagram Paketi - Mor -->
            <button class="btn-action btn-purple" id="instagram-btn">
                <span>ðŸ“·</span> Instagram Paketi
            </button>
            </div>
        </div>

        <!-- EDITOR AREA -->
        <div class="editor-area">
            <!-- LEFT - Ä°NDÄ°RÄ°MLÄ° ÃœRÃœNLER PANELÄ° -->
            <div class="sidebar-left">
                <h3 style="color: #f59e0b; margin-bottom: 8px;">ðŸ·ï¸ Ä°NDÄ°RÄ°MLÄ° ÃœRÃœNLER <span id="discount-count" style="font-size: 12px; color: #666;">(0)</span></h3>
                
                <!-- Barkod Arama -->
                <div style="display: flex; gap: 4px; margin-bottom: 10px;">
                    <input type="text" id="barcode-search-input" placeholder="Barkod gir..." 
                        style="flex: 1; padding: 6px 8px; border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; font-size: 12px; background: rgba(0,0,0,0.3); color: #fff;">
                    <button onclick="searchBarcodeForList()" 
                        style="padding: 6px 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold;">
                        Ara
                    </button>
                </div>
                
                <!-- ÃœrÃ¼n Listesi (Kompakt) -->
                <div id="discount-products-list" style="
                    max-height: calc(100vh - 280px);
                    overflow-y: auto;
                    border: 1px solid rgba(0, 255, 255, 0.2);
                    border-radius: 6px;
                    background: rgba(0, 0, 0, 0.3);
                "></div>
                
                <p class="hint" style="margin-top: 6px; font-size: 10px;">ðŸ‘‰ Fiyata tÄ±kla = DÃ¼zenle | SÃ¼rÃ¼kle â†’ Canvas</p>
            </div>
            
            <!-- Fiyat GiriÅŸ Popup -->
            <div id="price-popup" style="
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 200px;
            ">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">ðŸ’° Fiyat Gir</h4>
                <input type="hidden" id="price-popup-barcode">
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 11px; color: #666;">Ä°ndirimli Fiyat:</label>
                    <input type="number" id="price-popup-discount" step="0.01" placeholder="0.00" 
                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 11px; color: #666;">Normal Fiyat:</label>
                    <input type="number" id="price-popup-normal" step="0.01" placeholder="0.00" 
                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="savePricePopup()" style="flex: 1; padding: 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        âœ“ Tamam
                    </button>
                    <button onclick="closePricePopup()" style="flex: 1; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        âœ• Ä°ptal
                    </button>
                </div>
            </div>
            <div id="price-popup-overlay" onclick="closePricePopup()" style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.3);
                z-index: 9999;
            "></div>

            <!-- CENTER -->
            <div class="canvas-center">
                <!-- Page Tabs -->
                <div style="width: 100%;">
                    <div class="page-tabs" id="page-tabs">
                        <button class="page-tab active" onclick="switchPage(0)">ðŸ“„ Sayfa 1</button>
                        <button class="page-tab" onclick="switchPage(1)">ðŸ“„ Sayfa 2</button>
                        <button class="page-tab" onclick="switchPage(2)">ðŸ“„ Sayfa 3</button>
                        <button class="page-tab add-page" onclick="addNewPage()">âž• Yeni Sayfa</button>
                    </div>
                    
                    <!-- Canvas Controls -->
                    <div class="canvas-controls">
                        <div class="control-group">
                            <span class="control-label">Zoom:</span>
                            <button class="control-btn" onclick="setZoom(0.5)">50%</button>
                            <button class="control-btn active" onclick="setZoom(1)">100%</button>
                            <button class="control-btn" onclick="setZoom(1.5)">150%</button>
                        </div>
                        
                        <div class="control-group">
                            <span class="control-label">Font:</span>
                            <select class="control-select" id="font-selector" onchange="updateFont()">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                            <input type="number" class="control-input" id="font-size" value="14" min="8" max="48" onchange="updateFontSize()">
                        </div>

                        <div class="control-group">
                            <span class="control-label">Kart Fontu:</span>
                            <button class="control-btn" id="card-font-decrease">A-</button>
                            <button class="control-btn" id="card-font-increase">A+</button>
                        </div>
                        
                        <div class="control-group">
                            <button class="control-btn" id="lock-btn" onclick="togglePageLock()">ðŸ”“ Kilitle</button>
                            <button class="control-btn" onclick="applyToPage()">ðŸ“„ Sayfaya Uygula</button>
                            <button class="control-btn" onclick="applyToAll()">ðŸ“š TÃ¼mÃ¼ne Uygula</button>
                        </div>
                    </div>
                    
                    <!-- Canvas Container -->
                    <div id="canvas-container">
                        <canvas id="brochure-canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="sidebar-right">
                <div class="parking-header">
                    <h3>ðŸ…¿ï¸ Park AlanÄ± <span id="parking-counter" class="parking-counter">0 Ã¼rÃ¼n</span></h3>
                    <p class="hint">KullanÄ±lmayan Ã¼rÃ¼nleri buraya taÅŸÄ±yÄ±n</p>
                </div>
                <div id="parking-area" ondrop="dropToParking(event)" ondragover="allowDrop(event)"></div>
                
                <!-- ADMIN PANEL (initially hidden, shown when admin mode is ON) -->
                <div id="admin-panel" style="
                    display: none;
                    margin-top: 20px;
                    background: rgba(139, 92, 246, 0.15);
                    backdrop-filter: blur(10px);
                    border: 2px solid rgba(139, 92, 246, 0.3);
                    border-radius: 12px;
                    padding: 16px;
                    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
                ">
                    <h3 style="color: #8b5cf6; font-size: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        ðŸ”§ Admin DÃ¼zenleme Paneli
                    </h3>
                    
                    <!-- Selected Element Info -->
                    <div id="selected-element-info" style="display: none; margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.9); border-radius: 8px;">
                        <p style="margin: 0; font-size: 13px; font-weight: 600; color: #333;">
                            SeÃ§ili: <span id="selected-element-name" style="color: #8b5cf6;">-</span>
                        </p>
                    </div>
                    
                    <!-- Font Size Control -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">
                            ðŸ“ Font Boyutu: <span id="fontsize-value" style="color: #8b5cf6;">14px</span>
                        </label>
                        <input type="range" id="admin-fontsize-slider" min="10" max="32" value="14" style="width: 100%;">
                    </div>
                    
                    <!-- Color Picker -->
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px;">
                            ðŸŽ¨ Renk
                        </label>
                        <input type="color" id="admin-color-picker" value="#667eea" style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer;">
                    </div>
                    
                    <!-- Save Button -->
                    <button onclick="saveAdminLayout()" style="
                        width: 100%;
                        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
                        border: none;
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 700;
                        font-size: 13px;
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.3)';">
                        ðŸ’¾ DeÄŸiÅŸiklikleri Kaydet
                    </button>
                    
                    <p style="margin-top: 12px; font-size: 11px; color: #999; text-align: center;">
                        â„¹ï¸ Bir buton seÃ§ip dÃ¼zenleyin
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- IMAGE FINDER MODAL -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ðŸ” Resim Bul</h3>
            <div id="modalBody"></div>
            <div class="modal-buttons">
                <button class="btn-close" onclick="closeImageModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- THEME CUSTOMIZATION MODAL -->
    <div id="themeModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f093fb; padding-bottom: 15px;">
                <h3 style="margin: 0; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px;">ðŸŽ¨ Tema Ã–zelleÅŸtirme</h3>
                <button onclick="closeThemeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee;">
                <button class="theme-tab active" onclick="switchThemeTab('colors')" data-tab="colors">ðŸŽ¨ Renkler</button>
                <button class="theme-tab" onclick="switchThemeTab('templates')" data-tab="templates">ðŸ“ HazÄ±r Temalar</button>
                <button class="theme-tab" onclick="switchThemeTab('background')" data-tab="background">ðŸ–¼ï¸ Arkaplan</button>
                <button class="theme-tab" onclick="switchThemeTab('borders')" data-tab="borders">ðŸ–¼ï¸ Ã‡erÃ§eveler</button>
                <button class="theme-tab" onclick="switchThemeTab('fonts')" data-tab="fonts">âœï¸ Fontlar</button>
            </div>
            
            <!-- Tab Contents -->
            <div id="theme-tab-content">
                <!-- COLORS TAB -->
                <div id="colors-tab" class="theme-tab-content active">
                    <h4>ðŸŽ¨ Arkaplan Rengi</h4>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <input type="color" id="bg-color-picker" value="#ffffff" style="width: 60px; height: 60px; border: none; border-radius: 8px; cursor: pointer;">
                        <div>
                            <p style="margin: 0; font-weight: bold;">Ã–zel Renk SeÃ§</p>
                            <p style="margin: 0; color: #666; font-size: 12px;">Canvas arkaplan rengi</p>
                        </div>
                        <button onclick="applyBackgroundColor()" class="theme-apply-btn">Uygula</button>
                    </div>
                    
                    <h4>âœ¨ HazÄ±r Gradyan Temalar</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #667eea 0%, #764ba2 100%)')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #f093fb 0%, #f5576c 100%)')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #fa709a 0%, #fee140 100%)')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #30cfd0 0%, #330867 100%)')" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)')" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)')" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)')" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)')" style="background: linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)')" style="background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);"></div>
                        <div class="gradient-box" onclick="applyGradient('linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)')" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);"></div>
                    </div>
                </div>
                
                <!-- TEMPLATES TAB -->
                <div id="templates-tab" class="theme-tab-content" style="display: none;">
                    <h4>ðŸ“ HazÄ±r Tema ÅžablonlarÄ±</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="template-card" onclick="applyTemplate('supermarket')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);">
                                <span style="font-size: 32px;">ðŸ›’</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">SÃ¼permarket</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">Klasik market temasÄ±</p>
                        </div>
                        
                        <div class="template-card" onclick="applyTemplate('modern')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <span style="font-size: 32px;">âœ¨</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">Modern</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">ÅžÄ±k ve minimal</p>
                        </div>
                        
                        <div class="template-card" onclick="applyTemplate('fresh')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <span style="font-size: 32px;">ðŸŒ¿</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">Taze GÄ±da</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">YeÅŸil ve doÄŸal</p>
                        </div>
                        
                        <div class="template-card" onclick="applyTemplate('tech')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <span style="font-size: 32px;">ðŸ’»</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">Teknoloji</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">Teknoloji maÄŸazasÄ±</p>
                        </div>
                        
                        <div class="template-card" onclick="applyTemplate('luxury')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                                <span style="font-size: 32px;">ðŸ‘‘</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">LÃ¼ks</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">Premium tema</p>
                        </div>
                        
                        <div class="template-card" onclick="applyTemplate('fun')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <span style="font-size: 32px;">ðŸŽ‰</span>
                            </div>
                            <p style="font-weight: bold; margin: 10px 0 5px;">EÄŸlenceli</p>
                            <p style="font-size: 12px; color: #666; margin: 0;">Renkli ve canlÄ±</p>
                        </div>
                    </div>
                </div>
                
                <!-- BACKGROUND TAB -->
                <div id="background-tab" class="theme-tab-content" style="display: none;">
                    <h4>ðŸ–¼ï¸ Arkaplan Resmi</h4>
                    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">
                    <div style="border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; background: #f9f9f9; cursor: pointer;" onclick="document.getElementById('bg-image-input').click();">
                        <span style="font-size: 48px;">ðŸ“¤</span>
                        <p style="margin: 10px 0 0; font-weight: bold;">Arkaplan Resmi YÃ¼kle</p>
                        <p style="margin: 5px 0 0; color: #666; font-size: 14px;">PNG, JPG veya JPEG formatÄ±nda</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Arkaplan AyarlarÄ±</h4>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="bg-repeat" style="margin-right: 8px;">
                            ArkaplanÄ± tekrarla
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" id="bg-cover" checked style="margin-right: 8px;">
                            ArkaplanÄ± sÄ±ÄŸdÄ±r
                        </label>
                        <button onclick="removeBackground()" class="theme-apply-btn" style="background: #e74c3c;">ðŸ—‘ï¸ ArkaplanÄ± KaldÄ±r</button>
                    </div>
                </div>
                
                <!-- BORDERS TAB -->
                <div id="borders-tab" class="theme-tab-content" style="display: none;">
                    <h4>ðŸ–¼ï¸ Dekoratif Ã‡erÃ§eveler</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div class="border-card" onclick="applyBorder('classic')">
                            <div class="border-preview" style="border: 3px solid #333; padding: 20px;">
                                <div style="border: 1px solid #333; height: 100%;"></div>
                            </div>
                            <p>Klasik</p>
                        </div>
                        
                        <div class="border-card" onclick="applyBorder('elegant')">
                            <div class="border-preview" style="border: 5px double #d4af37; padding: 20px;">
                                <div style="border: 1px solid #d4af37; height: 100%;"></div>
                            </div>
                            <p>Zarif</p>
                        </div>
                        
                        <div class="border-card" onclick="applyBorder('modern')">
                            <div class="border-preview" style="border: 4px solid #667eea; border-radius: 12px; padding: 20px;">
                                <div style="height: 100%;"></div>
                            </div>
                            <p>Modern</p>
                        </div>
                        
                        <div class="border-card" onclick="applyBorder('dashed')">
                            <div class="border-preview" style="border: 3px dashed #e74c3c; padding: 20px;">
                                <div style="height: 100%;"></div>
                            </div>
                            <p>Kesikli</p>
                        </div>
                        
                        <div class="border-card" onclick="applyBorder('dotted')">
                            <div class="border-preview" style="border: 3px dotted #43e97b; padding: 20px;">
                                <div style="height: 100%;"></div>
                            </div>
                            <p>NoktalÄ±</p>
                        </div>
                        
                        <div class="border-card" onclick="applyBorder('none')">
                            <div class="border-preview" style="padding: 20px;">
                                <div style="height: 100%; background: #f0f0f0;"></div>
                            </div>
                            <p>Yok</p>
                        </div>
                    </div>
                </div>
                
                <!-- FONTS TAB -->
                <div id="fonts-tab" class="theme-tab-content" style="display: none;">
                    <h4>âœï¸ Font TemalarÄ±</h4>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <div class="font-card" onclick="applyFontTheme('professional')">
                            <div style="font-family: Arial, sans-serif; font-size: 20px; font-weight: bold;">Profesyonel Tema</div>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Arial, temiz ve okunabilir</p>
                        </div>
                        
                        <div class="font-card" onclick="applyFontTheme('elegant')">
                            <div style="font-family: Georgia, serif; font-size: 20px; font-weight: bold;">Zarif Tema</div>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Georgia, klasik ve ÅŸÄ±k</p>
                        </div>
                        
                        <div class="font-card" onclick="applyFontTheme('modern')">
                            <div style="font-family: Helvetica, sans-serif; font-size: 20px; font-weight: bold;">Modern Tema</div>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Helvetica, minimalist ve Ã§aÄŸdaÅŸ</p>
                        </div>
                        
                        <div class="font-card" onclick="applyFontTheme('bold')">
                            <div style="font-family: Impact, sans-serif; font-size: 20px; font-weight: bold;">KalÄ±n Tema</div>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Impact, dikkat Ã§ekici</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="apply-to-all-pages-theme" style="width: 18px; height: 18px;">
                        <span style="font-weight: bold;">TÃ¼m sayfalara uygula</span>
                    </label>
                </div>
                <button onclick="closeThemeModal()" class="theme-apply-btn" style="background: #667eea;">âœ… Tamam</button>
            </div>
        </div>
    </div>

    <script>
        // Admin mode variables (must be at top to avoid hoisting issues)
        let isAdminMode = false;
        let selectedButton = null;
        
        // Multi-page system variables
        let fabricCanvas = null;
        let pages = [];
        let currentPage = 0;
        let parkingArea = [];
        let currentDraggedProduct = null;
        let isFreeMode = true; // Default: FREE mode (everything is movable)
        
        // Canvas variables
        const A4_WIDTH = 595;
        const A4_HEIGHT = 842;
        let currentZoom = 1.0;
        let currentFont = 'Arial';
        let currentFontSize = 14;

        const CARD_CONSTANTS = {
            WIDTH: 160,
            HEIGHT: 220,
            PADDING: 8,
            IMAGE_WIDTH: 130,
            IMAGE_HEIGHT: 110,
            IMAGE_TOP: 0
        };
        CARD_CONSTANTS.NAME_TOP = CARD_CONSTANTS.IMAGE_TOP + CARD_CONSTANTS.IMAGE_HEIGHT + 12;
        CARD_CONSTANTS.PRICE_OLD_TOP = CARD_CONSTANTS.NAME_TOP + 32;
        CARD_CONSTANTS.PRICE_NEW_TOP = CARD_CONSTANTS.PRICE_OLD_TOP + 20;
        CARD_CONSTANTS.BADGE_RADIUS = 18;
        CARD_CONSTANTS.BADGE_TOP = CARD_CONSTANTS.PRICE_OLD_TOP - 26;

        const CARD_LAYOUT = {
            COLS: 3,
            GAP_X: 35,
            GAP_Y: 45,
            START_Y: 40
        };

        const CARD_FONT_DEFAULTS = {
            name: 16,
            price: 20
        };
        const CARD_FONT_LIMITS = {
            name: { min: 10, max: 28 },
            price: { min: 12, max: 32 }
        };
        let cardFontSettings = { ...CARD_FONT_DEFAULTS };
        
        // DOM elements
        const mainScreen = document.getElementById('main-screen');
        const fileInput = document.getElementById('file-input');
        const productsList = document.getElementById('products-list');
        
        // Global products array for wizard access
        window.allProducts = [];

        // Fiyat formatÄ±: 25,99 â‚º
        function formatPrice(price) {
            if (!price && price !== 0) return '0,00 â‚º';
            const num = parseFloat(price) || 0;
            return num.toFixed(2).replace('.', ',') + ' â‚º';
        }

        function getSafeImageUrl(url) {
            if (!url) return '';
            if (url.startsWith('/') || url.startsWith('data:')) return url;
            if (url.startsWith(window.location.origin)) return url;
            try {
                const parsedUrl = new URL(url, window.location.origin);
                if (parsedUrl.origin === window.location.origin) {
                    return parsedUrl.href;
                }
            } catch (error) {
                // ignore parse errors and fallback to proxy
            }
            return `/proxy-image?url=${encodeURIComponent(url)}`;
        }

        function normalizeProduct(product) {
            if (product && product.image_url) {
                product.image_url = getSafeImageUrl(product.image_url);
            }
            return product;
        }

        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function getCardGridStartX(cols = CARD_LAYOUT.COLS) {
            const totalWidth = cols * CARD_CONSTANTS.WIDTH + (cols - 1) * CARD_LAYOUT.GAP_X;
            return Math.max(CARD_CONSTANTS.PADDING, (A4_WIDTH - totalWidth) / 2);
        }

        function getCardPosition(index, startX, startY = CARD_LAYOUT.START_Y) {
            const col = index % CARD_LAYOUT.COLS;
            const row = Math.floor(index / CARD_LAYOUT.COLS);
            return {
                x: startX + col * (CARD_CONSTANTS.WIDTH + CARD_LAYOUT.GAP_X),
                y: startY + row * (CARD_CONSTANTS.HEIGHT + CARD_LAYOUT.GAP_Y)
            };
        }

        function formatProductNameForCard(name = '') {
            const safeName = name || 'ÃœrÃ¼n';
            if (safeName.length <= 36) return safeName;
            return safeName.slice(0, 33) + '...';
        }

        function calculateDiscountPercent(normalPrice, discountPrice) {
            if (!normalPrice || !discountPrice || normalPrice <= 0) return 0;
            return Math.max(0, Math.round(((normalPrice - discountPrice) / normalPrice) * 100));
        }

        function applyCardFontSettingsToGroup(group) {
            if (!group || !group.cardElements) return;
            const { nameText, oldPriceText, newPriceText, badgeText } = group.cardElements;
            if (nameText) {
                nameText.set({ fontSize: cardFontSettings.name });
            }
            if (oldPriceText) {
                const size = Math.max(10, cardFontSettings.price - 6);
                oldPriceText.set({ fontSize: size });
            }
            if (newPriceText) {
                newPriceText.set({ fontSize: cardFontSettings.price });
            }
            if (badgeText) {
                badgeText.set({ fontSize: Math.max(10, cardFontSettings.price - 6) });
            }
            updateBadgePosition(group);
        }

        function updateBadgePosition(group) {
            if (!group || !group.cardElements) return;
            const { badge, badgeText, oldPriceText } = group.cardElements;
            if (!badge || !badgeText) return;
            const priceTop = oldPriceText ? oldPriceText.top : CARD_CONSTANTS.PRICE_OLD_TOP;
            const badgeTop = priceTop - CARD_CONSTANTS.BADGE_RADIUS - 6;
            const badgeLeft = CARD_CONSTANTS.WIDTH - CARD_CONSTANTS.PADDING - CARD_CONSTANTS.BADGE_RADIUS;
            [badge, badgeText].forEach(item => {
                item.set({
                    left: badgeLeft,
                    top: badgeTop,
                    originX: 'center',
                    originY: 'center'
                });
            });
        }

        function syncAllCardFonts() {
            if (!fabricCanvas) return;
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.productCard) {
                    applyCardFontSettingsToGroup(obj);
                }
            });
            fabricCanvas.renderAll();
        }

        function adjustCardFonts(direction = 'increase') {
            const delta = direction === 'increase' ? 2 : -2;
            cardFontSettings.name = clamp(
                cardFontSettings.name + delta,
                CARD_FONT_LIMITS.name.min,
                CARD_FONT_LIMITS.name.max
            );
            cardFontSettings.price = clamp(
                cardFontSettings.price + delta,
                CARD_FONT_LIMITS.price.min,
                CARD_FONT_LIMITS.price.max
            );
            syncAllCardFonts();
        }

        // ========== YENÄ° ÅžEFFAF ÃœRÃœN KARTI (Test sisteminden) ==========
        function createProductCard(product, options = {}) {
            if (!fabricCanvas) {
                console.error('âŒ createProductCard: fabricCanvas yok!');
                return null;
            }
            const normalizedProduct = normalizeProduct({ ...product });
            const normalPrice = parseFloat(normalizedProduct.normal_price) || 0;
            const discountPrice = parseFloat(normalizedProduct.discount_price) || 0;
            
            console.log('ðŸŽ´ Kart oluÅŸturuluyor:', normalizedProduct.name, 'left:', options.left, 'top:', options.top);
            
            const isLocked = options.locked ?? false;
            const cardLeft = options.left || 0;
            const cardTop = options.top || 0;
            
            // Placeholder grup dÃ¶ndÃ¼r, resim async yÃ¼klenecek
            const placeholderGroup = createPlaceholderCard(normalizedProduct, cardLeft, cardTop, isLocked, options);
            
            // Resmi async yÃ¼kle ve gerÃ§ek kartÄ± oluÅŸtur
            if (normalizedProduct.image_url) {
                console.log('ðŸ–¼ï¸ Resim yÃ¼kleniyor:', normalizedProduct.image_url);
                fabric.Image.fromURL(normalizedProduct.image_url, (img) => {
                    if (!img) {
                        console.error('âŒ Resim yÃ¼klenemedi:', normalizedProduct.image_url);
                        return;
                    }
                    console.log('âœ… Resim yÃ¼klendi:', normalizedProduct.name);
                    
                    // Placeholder'Ä± kaldÄ±r
                    fabricCanvas.remove(placeholderGroup);
                    
                    // GerÃ§ek kartÄ± oluÅŸtur (ÅžEFFAF - beyaz kutu yok)
                    const imgScale = 100 / Math.max(img.width, img.height);
                    const imgWidth = img.width * imgScale;
                    const imgHeight = img.height * imgScale;
                    
                    img.scale(imgScale);
                    img.set({
                        left: imgWidth / 2,
                        top: imgHeight / 2,
                        originX: 'center',
                        originY: 'center'
                    });
                    
                    // ORANTILI MESAFELER (resim boyutuna gÃ¶re)
                    const nameFontSize = Math.max(10, Math.min(14, imgHeight * 0.12)); // %12, min 10, max 14
                    const priceFontSize = Math.max(12, Math.min(18, imgHeight * 0.15)); // %15, min 12, max 18
                    const gapAfterImage = 5; // Resim-isim arasÄ± sabit 5px
                    const gapAfterName = 2;  // Ä°sim-fiyat arasÄ± sabit 2px
                    
                    // Ä°sim (resmin hemen altÄ±nda)
                    const nameText = new fabric.Text(formatProductNameForCard(normalizedProduct.name), {
                        left: imgWidth / 2,
                        top: imgHeight + gapAfterImage,
                        fontSize: nameFontSize,
                        fontWeight: 'bold',
                        fill: '#ffffff',
                        stroke: '#000000',
                        strokeWidth: 0.3,
                        originX: 'center'
                    });
                    
                    // Fiyat (ismin hemen altÄ±nda)
                    const priceValue = discountPrice || normalPrice || 0;
                    const priceText = new fabric.Text(formatPrice(priceValue), {
                        left: imgWidth / 2,
                        top: imgHeight + gapAfterImage + nameFontSize + gapAfterName,
                        fontSize: priceFontSize,
                        fontWeight: 'bold',
                        fill: '#ffff00',
                        stroke: '#000000',
                        strokeWidth: 0.3,
                        originX: 'center'
                    });
                    
                    // ÅžEFFAF GRUP OLUÅžTUR (beyaz kutu yok!)
                    const productGroup = new fabric.Group([img, nameText, priceText], {
                        left: cardLeft,
                        top: cardTop,
                        selectable: options.selectable ?? !isLocked,
                        evented: options.evented ?? !isLocked,
                        hasControls: options.hasControls ?? !isLocked,
                        hasBorders: options.hasBorders ?? !isLocked
                    });
                    
                    productGroup.productData = normalizedProduct;
                    productGroup.productCard = true;
                    
                    fabricCanvas.add(productGroup);
                    fabricCanvas.renderAll();
                    console.log('ðŸŽ¨ Åžeffaf Ã¼rÃ¼n kartÄ± eklendi:', normalizedProduct.name);
                }, { crossOrigin: 'anonymous' });
            }
            
            return placeholderGroup;
        }
        
        // Placeholder kart (resim yÃ¼klenene kadar)
        function createPlaceholderCard(product, left, top, isLocked, options) {
            const placeholder = new fabric.Rect({
                left: 0, top: 0,
                width: 100, height: 130,
                fill: 'rgba(200,200,200,0.3)',
                rx: 8, ry: 8
            });
            
            const loadingText = new fabric.Text('YÃ¼kleniyor...', {
                left: 50, top: 60,
                fontSize: 10,
                fill: '#666',
                originX: 'center',
                originY: 'center'
            });
            
            const group = new fabric.Group([placeholder, loadingText], {
                left: left,
                top: top,
                selectable: options.selectable ?? !isLocked,
                evented: options.evented ?? !isLocked
            });
            
            group.productData = product;
            group.productCard = true;
            group.isPlaceholder = true;
            
            return group;
        }

        function addCardToCanvas(product, options = {}) {
            if (!fabricCanvas) {
                console.error('âŒ addCardToCanvas: fabricCanvas yok!');
                return null;
            }
            const group = createProductCard(product, options);
            if (!group) {
                console.error('âŒ addCardToCanvas: group oluÅŸturulamadÄ±!');
                return null;
            }
            fabricCanvas.add(group);
            console.log('âœ… Kart Canvas\'a eklendi, toplam obje:', fabricCanvas.getObjects().length);
            if (!options.suppressRender) {
                fabricCanvas.renderAll();
            }
            return group;
        }

        // ========== DÃœZENLEME MODU FONKSÄ°YONLARI ==========
        
        // DÃ¼zenleme modundaki aktif kart
        let editingCard = null;
        let editingOriginalObjects = [];
        let editingOriginalPosition = null;
        
        // DÃ¼zenleme moduna gir
        function enableEditMode(cardGroup) {
            if (!cardGroup || !cardGroup.productCard) {
                console.error('âŒ GeÃ§erli bir Ã¼rÃ¼n kartÄ± deÄŸil');
                return;
            }
            
            // Zaten dÃ¼zenleme modundaysa Ã§Ä±k
            if (editingCard) {
                finishEditMode();
            }
            
            editingCard = cardGroup;
            editingOriginalPosition = { left: cardGroup.left, top: cardGroup.top };
            
            // Grup pozisyonunu kaydet
            const groupLeft = cardGroup.left;
            const groupTop = cardGroup.top;
            
            // Grubu Ã§Ã¶z - nesneleri baÄŸÄ±msÄ±z yap
            const objects = cardGroup._objects.slice();
            editingOriginalObjects = objects.map(obj => ({
                obj: obj,
                left: obj.left,
                top: obj.top
            }));
            
            // Grubu kaldÄ±r
            fabricCanvas.remove(cardGroup);
            
            // Her nesneyi baÄŸÄ±msÄ±z olarak canvas'a ekle
            objects.forEach((obj, index) => {
                // Global pozisyon hesapla
                obj.set({
                    left: groupLeft + obj.left + (cardGroup.width / 2),
                    top: groupTop + obj.top + (cardGroup.height / 2),
                    selectable: true,
                    hasControls: true,
                    hasBorders: true,
                    borderColor: '#2196F3',
                    cornerColor: '#2196F3',
                    cornerSize: 8,
                    transparentCorners: false,
                    lockRotation: false
                });
                
                // Ä°sim ve fiyat iÃ§in Ã¶zel ayarlar
                if (obj.type === 'text' || obj.type === 'textbox') {
                    obj.set({
                        editable: true,
                        backgroundColor: 'rgba(33, 150, 243, 0.1)'
                    });
                }
                
                obj._editMode = true;
                obj._cardId = cardGroup.productData?.barcode || Date.now();
                fabricCanvas.add(obj);
            });
            
            // DÃ¼zenleme kontrolleri gÃ¶ster
            showEditControls(groupLeft, groupTop, cardGroup.width || 120);
            
            fabricCanvas.renderAll();
            console.log('âœï¸ DÃ¼zenleme modu aktif:', cardGroup.productData?.name);
        }
        
        // DÃ¼zenleme kontrollerini gÃ¶ster
        function showEditControls(left, top, width) {
            // Kontrol kutusu
            const controlBox = new fabric.Rect({
                left: left - 5,
                top: top - 30,
                width: width + 10,
                height: 25,
                fill: 'rgba(33, 150, 243, 0.9)',
                rx: 5,
                ry: 5,
                selectable: false,
                evented: false
            });
            controlBox._editControl = true;
            
            // Tamam butonu
            const okBtn = new fabric.Text('âœ…', {
                left: left + 10,
                top: top - 25,
                fontSize: 16,
                selectable: false,
                evented: true,
                hoverCursor: 'pointer'
            });
            okBtn._editControl = true;
            okBtn._editAction = 'ok';
            
            // Sil butonu
            const deleteBtn = new fabric.Text('ðŸ—‘ï¸', {
                left: left + width / 2,
                top: top - 25,
                fontSize: 16,
                selectable: false,
                evented: true,
                hoverCursor: 'pointer'
            });
            deleteBtn._editControl = true;
            deleteBtn._editAction = 'delete';
            
            // Ä°ptal butonu
            const cancelBtn = new fabric.Text('âŒ', {
                left: left + width - 20,
                top: top - 25,
                fontSize: 16,
                selectable: false,
                evented: true,
                hoverCursor: 'pointer'
            });
            cancelBtn._editControl = true;
            cancelBtn._editAction = 'cancel';
            
            fabricCanvas.add(controlBox, okBtn, deleteBtn, cancelBtn);
            fabricCanvas.renderAll();
        }
        
        // DÃ¼zenlemeyi bitir ve grubu tekrar oluÅŸtur
        function finishEditMode(action = 'ok') {
            if (!editingCard) return;
            
            // Kontrolleri kaldÄ±r
            fabricCanvas.getObjects().filter(obj => obj._editControl).forEach(obj => {
                fabricCanvas.remove(obj);
            });
            
            // DÃ¼zenlenen nesneleri bul
            const editedObjects = fabricCanvas.getObjects().filter(obj => obj._editMode);
            
            if (action === 'cancel') {
                // Ä°ptal - nesneleri kaldÄ±r, orijinal kartÄ± geri ekle
                editedObjects.forEach(obj => fabricCanvas.remove(obj));
                editingCard.set({
                    left: editingOriginalPosition.left,
                    top: editingOriginalPosition.top
                });
                fabricCanvas.add(editingCard);
            } else if (action === 'delete') {
                // Sil - nesneleri kaldÄ±r, kartÄ± geri ekleme
                editedObjects.forEach(obj => fabricCanvas.remove(obj));
                console.log('ðŸ—‘ï¸ ÃœrÃ¼n silindi:', editingCard.productData?.name);
            } else {
                // Tamam - yeni pozisyonlarla grubu oluÅŸtur
                if (editedObjects.length > 0) {
                    // Merkez noktasÄ± bul
                    const bounds = getBounds(editedObjects);
                    
                    // Her nesnenin gÃ¶reli pozisyonunu hesapla
                    editedObjects.forEach(obj => {
                        obj.set({
                            left: obj.left - bounds.left - bounds.width / 2,
                            top: obj.top - bounds.top - bounds.height / 2,
                            selectable: false,
                            hasControls: false,
                            backgroundColor: ''
                        });
                        delete obj._editMode;
                        delete obj._cardId;
                        fabricCanvas.remove(obj);
                    });
                    
                    // Yeni grup oluÅŸtur
                    const newGroup = new fabric.Group(editedObjects, {
                        left: bounds.left,
                        top: bounds.top,
                        selectable: true,
                        hasControls: true,
                        hasBorders: true
                    });
                    
                    newGroup.productData = editingCard.productData;
                    newGroup.productCard = true;
                    
                    fabricCanvas.add(newGroup);
                    console.log('âœ… DÃ¼zenleme tamamlandÄ±:', editingCard.productData?.name);
                }
            }
            
            editingCard = null;
            editingOriginalObjects = [];
            editingOriginalPosition = null;
            
            fabricCanvas.renderAll();
        }
        
        // Nesnelerin sÄ±nÄ±rlarÄ±nÄ± hesapla
        function getBounds(objects) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            objects.forEach(obj => {
                const rect = obj.getBoundingRect();
                minX = Math.min(minX, rect.left);
                minY = Math.min(minY, rect.top);
                maxX = Math.max(maxX, rect.left + rect.width);
                maxY = Math.max(maxY, rect.top + rect.height);
            });
            
            return {
                left: minX,
                top: minY,
                width: maxX - minX,
                height: maxY - minY
            };
        }
        
        // Canvas tÄ±klama olaylarÄ±nÄ± dinle
        function setupEditModeEvents() {
            if (!fabricCanvas) return;
            
            // Ã‡ift tÄ±klama - dÃ¼zenleme moduna gir
            fabricCanvas.on('mouse:dblclick', function(e) {
                if (e.target && e.target.productCard && !editingCard) {
                    enableEditMode(e.target);
                }
            });
            
            // Tek tÄ±klama - kontrol butonlarÄ±
            fabricCanvas.on('mouse:down', function(e) {
                if (e.target && e.target._editControl && e.target._editAction) {
                    finishEditMode(e.target._editAction);
                }
            });
            
            // ESC tuÅŸu - dÃ¼zenlemeyi iptal et
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && editingCard) {
                    finishEditMode('cancel');
                }
            });
        }
        
        // ========== Ä°NDÄ°RÄ°MLÄ° ÃœRÃœNLER PANELÄ° ==========
        
        // Ä°ndirimli Ã¼rÃ¼nler listesi (session bazlÄ±)
        let discountProducts = [];
        
        // Listeyi render et
        function renderDiscountProductsList() {
            const container = document.getElementById('discount-products-list');
            const counter = document.getElementById('discount-count');
            
            if (!container) return;
            
            counter.textContent = `(${discountProducts.length})`;
            
            if (discountProducts.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5); font-size: 11px;">HenÃ¼z Ã¼rÃ¼n yok.<br>Barkod ile ara veya<br>Ã–n YÃ¼kle\'den aktar.</p>';
                return;
            }
            
            container.innerHTML = discountProducts.map((p, index) => `
                <div class="discount-product-item" draggable="true" ondragstart="dragDiscountProduct(event, ${index})">
                    <img src="${p.image_url || '/static/img/placeholder.png'}" alt="">
                    <div class="product-name">${p.name || 'Ä°simsiz'}</div>
                    <div class="product-price ${p.discount_price > 0 ? 'has-price' : 'no-price'}" 
                        onclick="openPricePopup('${p.barcode}')" 
                        title="TÄ±kla: Fiyat dÃ¼zenle">
                        ${p.discount_price > 0 ? p.discount_price.toFixed(2) + 'â‚º' : 'Fiyat?'}
                    </div>
                </div>
            `).join('');
        }
        
        // Barkod ile arama
        async function searchBarcodeForList() {
            const input = document.getElementById('barcode-search-input');
            const barcode = input.value.trim();
            
            if (!barcode) {
                showNotification('Barkod girin!', 'warning');
                return;
            }
            
            try {
                // Depodan ara
                const response = await fetch(`/api/image-bank/search?barcode=${barcode}`);
                const data = await response.json();
                
                if (data.found) {
                    // ÃœrÃ¼n bulundu - listeye ekle
                    const existingIndex = discountProducts.findIndex(p => p.barcode === barcode);
                    
                    if (existingIndex >= 0) {
                        showNotification('Bu Ã¼rÃ¼n zaten listede!', 'warning');
                        return;
                    }
                    
                    discountProducts.push({
                        barcode: barcode,
                        name: data.product_name || data.name || 'Ä°simsiz',
                        image_url: data.image_url || data.image_path,
                        discount_price: 0,
                        normal_price: 0
                    });
                    
                    renderDiscountProductsList();
                    input.value = '';
                    showNotification('âœ… ÃœrÃ¼n eklendi: ' + (data.product_name || data.name), 'success');
                    
                    // Fiyat popup aÃ§
                    openPricePopup(barcode);
                } else {
                    showNotification('ÃœrÃ¼n bulunamadÄ±! Depo veya CAMGOZ\'da yok.', 'error');
                }
            } catch (error) {
                console.error('Arama hatasÄ±:', error);
                showNotification('Arama hatasÄ±!', 'error');
            }
        }
        
        // Fiyat popup aÃ§
        function openPricePopup(barcode) {
            const product = discountProducts.find(p => p.barcode === barcode);
            if (!product) return;
            
            document.getElementById('price-popup-barcode').value = barcode;
            document.getElementById('price-popup-discount').value = product.discount_price || '';
            document.getElementById('price-popup-normal').value = product.normal_price || '';
            
            document.getElementById('price-popup').style.display = 'block';
            document.getElementById('price-popup-overlay').style.display = 'block';
            document.getElementById('price-popup-discount').focus();
        }
        
        // Fiyat kaydet
        function savePricePopup() {
            const barcode = document.getElementById('price-popup-barcode').value;
            const discountPrice = parseFloat(document.getElementById('price-popup-discount').value) || 0;
            const normalPrice = parseFloat(document.getElementById('price-popup-normal').value) || 0;
            
            const product = discountProducts.find(p => p.barcode === barcode);
            if (product) {
                product.discount_price = discountPrice;
                product.normal_price = normalPrice;
                renderDiscountProductsList();
                showNotification('âœ… Fiyat kaydedildi!', 'success');
            }
            
            closePricePopup();
        }
        
        // Popup kapat
        function closePricePopup() {
            document.getElementById('price-popup').style.display = 'none';
            document.getElementById('price-popup-overlay').style.display = 'none';
        }
        
        // ÃœrÃ¼nÃ¼ sÃ¼rÃ¼kle
        function dragDiscountProduct(event, index) {
            const product = discountProducts[index];
            event.dataTransfer.setData('product', JSON.stringify(product));
        }
        
        // Enter tuÅŸu ile arama
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('barcode-search-input');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchBarcodeForList();
                    }
                });
            }
            
            // SessionStorage'dan Ã¼rÃ¼nleri yÃ¼kle (pre_approval'dan geliyorsa)
            const savedProducts = sessionStorage.getItem('preApprovalProducts');
            if (savedProducts) {
                try {
                    const products = JSON.parse(savedProducts);
                    // Sadece indirimli (fiyatÄ± olan) Ã¼rÃ¼nleri al
                    discountProducts = products.filter(p => p.discount_price > 0 || p.normal_price > 0).map(p => ({
                        barcode: p.barcode,
                        name: p.name || p.product_name,
                        image_url: p.image_url,
                        discount_price: parseFloat(p.discount_price) || 0,
                        normal_price: parseFloat(p.normal_price) || 0
                    }));
                    renderDiscountProductsList();
                    
                    // Temizle (bir kerelik kullanÄ±m)
                    // sessionStorage.removeItem('preApprovalProducts');
                } catch (e) {
                    console.error('ÃœrÃ¼nler yÃ¼klenemedi:', e);
                }
            } else {
                renderDiscountProductsList();
            }
        });
        
        window.addEventListener('load', checkSession);
        
        // Logout function
        function logout() {
            fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        // Download Excel template
        function downloadTemplate() {
            const csvContent = "Barkod,ÃœrÃ¼n AdÄ±,ÃœrÃ¼n Grubu,Eski Fiyat,Ä°ndirim FiyatÄ±\n1234567890123,Ã–rnek ÃœrÃ¼n,GÄ±da,10.00,7.50\n9876543210987,Ã–rnek ÃœrÃ¼n 2,Ä°Ã§ecek,15.00,12.00";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "excel_sablonu.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('âœ… Excel ÅŸablonu indirildi!');
        }

        // Toggle Company Info section
        function toggleCompanyInfo() {
            const content = document.getElementById('company-info-content');
            const summary = document.getElementById('company-info-summary');
            const btn = document.getElementById('company-toggle-btn');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                btn.textContent = 'DÃ¼zenle';
                saveCompanyInfo();
                updateCompanyInfoSummary();
                summary.style.display = 'block';
                
                const removeButtons = document.querySelectorAll('.social-media-item .remove-social-btn');
                removeButtons.forEach(btn => btn.style.display = 'none');
            } else {
                content.classList.add('open');
                btn.textContent = 'Tamam';
                summary.style.display = 'none';
                
                const removeButtons = document.querySelectorAll('.social-media-item .remove-social-btn');
                removeButtons.forEach(btn => btn.style.display = 'flex');
            }
        }

        // Save company info to localStorage
        function saveCompanyInfo() {
            const companyData = {
                name: document.getElementById('company-name').value,
                address: document.getElementById('company-address').value,
                phone: document.getElementById('company-phone').value,
                email: document.getElementById('company-email').value
            };
            localStorage.setItem('companyInfo', JSON.stringify(companyData));
            updateWelcomeMessage(); // Update welcome message when company info changes
        }

        // Update welcome message in header
        function updateWelcomeMessage() {
            const savedData = localStorage.getItem('companyInfo');
            const welcomeDiv = document.getElementById('welcome-message');
            
            // Check if element exists before updating
            if (!welcomeDiv) return;
            
            if (savedData) {
                const companyData = JSON.parse(savedData);
                const companyName = companyData.name || '';
                
                if (companyName) {
                    welcomeDiv.textContent = `HoÅŸ geldin, ${companyName}!`;
                } else {
                    welcomeDiv.textContent = '';
                }
            } else {
                welcomeDiv.textContent = '';
            }
        }

        // Load company info from localStorage
        function loadCompanyInfo() {
            const savedData = localStorage.getItem('companyInfo');
            if (savedData) {
                const companyData = JSON.parse(savedData);
                document.getElementById('company-name').value = companyData.name || '';
                document.getElementById('company-address').value = companyData.address || '';
                document.getElementById('company-phone').value = companyData.phone || '';
                document.getElementById('company-email').value = companyData.email || '';
                updateCompanyInfoSummary();
                updateWelcomeMessage(); // Update welcome message on load
                
                // Show summary if there's data
                const hasData = companyData.name || companyData.phone || companyData.address;
                if (hasData) {
                    const summary = document.getElementById('company-info-summary');
                    const content = document.getElementById('company-info-content');
                    const btn = document.getElementById('company-toggle-btn');
                    
                    summary.style.display = 'block';
                    content.classList.remove('open');
                    btn.textContent = 'DÃ¼zenle';
                }
            }
        }

        // Update company info summary
        function updateCompanyInfoSummary() {
            const summary = document.getElementById('company-info-summary');
            const name = document.getElementById('company-name').value;
            const phone = document.getElementById('company-phone').value;
            const address = document.getElementById('company-address').value;
            
            let summaryHTML = '';
            let lineCount = 0;
            
            if (name && lineCount < 3) {
                summaryHTML += `<div style="margin-bottom: 4px;">ðŸ¢ ${name}</div>`;
                lineCount++;
            }
            if (phone && lineCount < 3) {
                summaryHTML += `<div style="margin-bottom: 4px;">ðŸ“ž ${phone}</div>`;
                lineCount++;
            }
            if (address && lineCount < 3) {
                const shortAddress = address.length > 40 ? address.substring(0, 40) + '...' : address;
                summaryHTML += `<div style="margin-bottom: 4px;">ðŸ“ ${shortAddress}</div>`;
                lineCount++;
            }
            
            if (summaryHTML === '') {
                summaryHTML = '<div style="color: #999; font-style: italic;">Bilgi girilmedi</div>';
            }
            
            summary.innerHTML = summaryHTML;
        }

        // Toggle Social Media section
        function toggleSocialMedia() {
            const content = document.getElementById('social-media-content');
            const summary = document.getElementById('social-media-summary');
            const btn = document.getElementById('social-toggle-btn');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                btn.textContent = 'DÃ¼zenle';
                saveSocialMedia();
                updateSocialMediaSummary();
                summary.style.display = 'block';
                
                const removeButtons = document.querySelectorAll('.social-media-item .remove-social-btn');
                removeButtons.forEach(btn => btn.style.display = 'none');
            } else {
                content.classList.add('open');
                btn.textContent = 'Tamam';
                summary.style.display = 'none';
                
                const removeButtons = document.querySelectorAll('.social-media-item .remove-social-btn');
                removeButtons.forEach(btn => btn.style.display = 'flex');
            }
        }

        // Save social media to localStorage
        function saveSocialMedia() {
            const items = document.querySelectorAll('#social-media-list .social-media-item');
            const socialData = [];
            
            items.forEach(item => {
                const platform = item.getAttribute('data-platform');
                const inputField = item.querySelector('input[type="text"]');
                let username = inputField.value.trim();
                if (username) {
                    // Auto-add @ if not present
                    if (!username.startsWith('@')) {
                        username = '@' + username;
                    }
                    // Write back to DOM so UI stays in sync
                    inputField.value = username;
                    socialData.push({ platform, username });
                }
            });
            
            localStorage.setItem('socialMedia', JSON.stringify(socialData));
        }

        // Load social media from localStorage
        function loadSocialMedia() {
            const savedData = localStorage.getItem('socialMedia');
            if (savedData) {
                const socialData = JSON.parse(savedData);
                const list = document.getElementById('social-media-list');
                list.innerHTML = '';
                
                socialData.forEach(item => {
                    const platformNames = {
                        twitter: 'Twitter', facebook: 'Facebook', instagram: 'Instagram',
                        linkedin: 'LinkedIn', tiktok: 'TikTok', youtube: 'YouTube', whatsapp: 'WhatsApp'
                    };
                    const newItem = document.createElement('div');
                    newItem.className = 'social-media-item';
                    newItem.setAttribute('data-platform', item.platform);
                    newItem.innerHTML = `
                        <button class="social-platform-btn" onclick="cyclePlatform(this)" aria-label="${platformNames[item.platform]} - TÄ±klayarak deÄŸiÅŸtir">
                            <i class="fab fa-${item.platform}"></i>
                        </button>
                        <select onchange="updateSocialIcon(this)" aria-label="Platform seÃ§">
                            <option value="twitter" ${item.platform === 'twitter' ? 'selected' : ''}>Twitter</option>
                            <option value="facebook" ${item.platform === 'facebook' ? 'selected' : ''}>Facebook</option>
                            <option value="instagram" ${item.platform === 'instagram' ? 'selected' : ''}>Instagram</option>
                            <option value="linkedin" ${item.platform === 'linkedin' ? 'selected' : ''}>LinkedIn</option>
                            <option value="tiktok" ${item.platform === 'tiktok' ? 'selected' : ''}>TikTok</option>
                            <option value="youtube" ${item.platform === 'youtube' ? 'selected' : ''}>YouTube</option>
                            <option value="whatsapp" ${item.platform === 'whatsapp' ? 'selected' : ''}>WhatsApp</option>
                        </select>
                        <input type="text" placeholder="kullaniciadi" value="${item.username}" aria-label="KullanÄ±cÄ± adÄ±">
                        <button class="remove-social-btn" onclick="removeSocialMedia(this)" aria-label="KaldÄ±r">Ã—</button>
                    `;
                    list.appendChild(newItem);
                });
                
                updateSocialMediaSummary();
                
                // Show summary if there's data
                if (socialData.length > 0) {
                    const summary = document.getElementById('social-media-summary');
                    const content = document.getElementById('social-media-content');
                    const btn = document.getElementById('social-toggle-btn');
                    
                    summary.style.display = 'block';
                    content.classList.remove('open');
                    btn.textContent = 'DÃ¼zenle';
                }
            }
        }

        // Update social media summary
        function updateSocialMediaSummary() {
            const summary = document.getElementById('social-media-summary');
            const items = document.querySelectorAll('#social-media-list .social-media-item');
            
            const platformEmojis = {
                twitter: 'ðŸ¦',
                facebook: 'ðŸ“˜',
                instagram: 'ðŸ“·',
                linkedin: 'ðŸ’¼',
                tiktok: 'ðŸŽµ',
                youtube: 'ðŸ“¹',
                whatsapp: 'ðŸ’š'
            };
            
            const platformColors = {
                twitter: '#1DA1F2',
                facebook: '#1877F2',
                instagram: '#E4405F',
                linkedin: '#0A66C2',
                tiktok: '#000000',
                youtube: '#FF0000',
                whatsapp: '#25D366'
            };
            
            let summaryHTML = '';
            let count = 0;
            const maxShow = 3;
            
            items.forEach(item => {
                const platform = item.getAttribute('data-platform');
                const username = item.querySelector('input[type="text"]').value;
                
                if (username && count < maxShow) {
                    const color = platformColors[platform] || '#999';
                    const iconClass = platform === 'whatsapp' ? 'fa-whatsapp' : `fa-${platform}`;
                    summaryHTML += `<span style="margin-right: 8px;"><i class="fab ${iconClass}" style="color: ${color};"></i> ${username}</span>`;
                    count++;
                }
            });
            
            if (items.length > maxShow) {
                summaryHTML += '<span style="color: #999;">...</span>';
            }
            
            if (summaryHTML === '') {
                summaryHTML = '<div style="color: #999; font-style: italic;">Hesap eklenmedi</div>';
            }
            
            summary.innerHTML = summaryHTML;
        }

        // Add new social media account
        function addSocialMedia() {
            const list = document.getElementById('social-media-list');
            const newItem = document.createElement('div');
            newItem.className = 'social-media-item';
            newItem.setAttribute('data-platform', 'instagram');
            newItem.innerHTML = `
                <button class="social-platform-btn" onclick="cyclePlatform(this)" aria-label="Instagram - TÄ±klayarak deÄŸiÅŸtir">
                    <i class="fab fa-instagram"></i>
                </button>
                <select onchange="updateSocialIcon(this)" aria-label="Platform seÃ§">
                    <option value="twitter">Twitter</option>
                    <option value="facebook">Facebook</option>
                    <option value="instagram" selected>Instagram</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="tiktok">TikTok</option>
                    <option value="youtube">YouTube</option>
                    <option value="whatsapp">WhatsApp</option>
                </select>
                <input type="text" placeholder="kullaniciadi" value="" aria-label="KullanÄ±cÄ± adÄ±">
                <button class="remove-social-btn" onclick="removeSocialMedia(this)" aria-label="KaldÄ±r">Ã—</button>
            `;
            list.appendChild(newItem);
        }

        // Update social media icon when platform changes
        function updateSocialIcon(selectElement) {
            const item = selectElement.closest('.social-media-item');
            const button = item.querySelector('.social-platform-btn');
            const icon = button ? button.querySelector('i') : item.querySelector('i');
            const platform = selectElement.value;
            
            if (icon) {
                icon.className = 'fab fa-' + platform;
            }
            item.setAttribute('data-platform', platform);
            
            // Update button aria-label if exists
            if (button) {
                const platformNames = {
                    twitter: 'Twitter', facebook: 'Facebook', instagram: 'Instagram',
                    linkedin: 'LinkedIn', tiktok: 'TikTok', youtube: 'YouTube', whatsapp: 'WhatsApp'
                };
                button.setAttribute('aria-label', (platformNames[platform] || platform) + ' - TÄ±klayarak deÄŸiÅŸtir');
            }
        }
        
        // MODERN: Click icon to cycle through platforms (keyboard accessible)
        function cyclePlatform(buttonElement) {
            const platforms = ['twitter', 'facebook', 'instagram', 'linkedin', 'tiktok', 'youtube', 'whatsapp'];
            const item = buttonElement.closest('.social-media-item');
            const currentPlatform = item.getAttribute('data-platform');
            const currentIndex = platforms.indexOf(currentPlatform);
            const nextIndex = (currentIndex + 1) % platforms.length;
            const nextPlatform = platforms[nextIndex];
            
            // Update icon
            const icon = buttonElement.querySelector('i');
            icon.className = 'fab fa-' + nextPlatform;
            item.setAttribute('data-platform', nextPlatform);
            
            // Update aria-label
            const platformNames = {
                twitter: 'Twitter', facebook: 'Facebook', instagram: 'Instagram',
                linkedin: 'LinkedIn', tiktok: 'TikTok', youtube: 'YouTube', whatsapp: 'WhatsApp'
            };
            buttonElement.setAttribute('aria-label', platformNames[nextPlatform] + ' - TÄ±klayarak deÄŸiÅŸtir');
            
            // Sync with select (for accessibility)
            const select = item.querySelector('select');
            if (select) {
                select.value = nextPlatform;
                select.dispatchEvent(new Event('change'));
            }
        }

        // Remove social media account
        function removeSocialMedia(button) {
            const item = button.closest('.social-media-item');
            item.remove();
        }

        function saveMealCards() {
            const checkboxes = document.querySelectorAll('input[name="meal-card"]');
            const selectedCards = [];
            
            checkboxes.forEach(checkbox => {
                selectedCards.push({
                    name: checkbox.value,
                    icon: checkbox.getAttribute('data-icon') || 'ðŸ´',
                    checked: checkbox.checked
                });
            });
            
            localStorage.setItem('mealCards', JSON.stringify(selectedCards));
        }

        function loadMealCards() {
            const savedCards = localStorage.getItem('mealCards');
            if (savedCards) {
                const selectedCards = JSON.parse(savedCards);
                const checkboxes = document.querySelectorAll('input[name="meal-card"]');
                
                checkboxes.forEach(checkbox => {
                    const cardData = selectedCards.find(card => card.name === checkbox.value);
                    if (cardData) {
                        checkbox.checked = cardData.checked;
                    } else {
                        const legacyChecked = selectedCards.includes(checkbox.value);
                        checkbox.checked = legacyChecked;
                    }
                });
            }
        }

        // Apply discount template from dropdown
        function applyDiscountTemplate() {
            const selector = document.getElementById('template-selector');
            const templateId = selector.value;
            
            if (templateId && templateConfigs[templateId]) {
                currentTemplate = templateConfigs[templateId];
                applyTemplateStyle(currentTemplate);
                alert('âœ… "' + currentTemplate.name + '" ÅŸablonu uygulandÄ±!');
            }
        }

        function checkSession() {
            fetch('/api/check-session')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showMainScreen(data.user);
                        loadProducts();
                    }
                });
        }
        
        // Template Management
        let currentTemplate = null;
        const templateConfigs = {
            'super-friday': {
                name: 'SÃ¼per Cuma',
                colors: { bg: '#1a1a1a', primary: '#ff0000', secondary: '#ffcc00' },
                fonts: { title: 'Arial Black', body: 'Arial' },
                header: 'ðŸ”¥ SÃœPER CUMA FIRSATLARI ðŸ”¥',
                slogan: 'KaÃ§Ä±rmayÄ±n! Sadece Bu Cuma!'
            },
            'discount-50': {
                name: '%50 Ä°ndirim',
                colors: { bg: '#ff0000', primary: '#ffffff', secondary: '#ffcc00' },
                fonts: { title: 'Impact', body: 'Helvetica' },
                header: 'ðŸ’¥ %50\'YE VARAN Ä°NDÄ°RÄ°MLER ðŸ’¥',
                slogan: 'Fiyatlar YarÄ± YarÄ±ya!'
            },
            'week-campaign': {
                name: 'HaftanÄ±n KampanyasÄ±',
                colors: { bg: '#2196f3', primary: '#ffffff', secondary: '#ffc107' },
                fonts: { title: 'Verdana', body: 'Arial' },
                header: 'ðŸ“… HAFTANIN KAMPANYASI ðŸ“…',
                slogan: 'Her Hafta Yeni FÄ±rsatlar!'
            },
            'season-end': {
                name: 'Sezon Sonu',
                colors: { bg: '#9c27b0', primary: '#ffffff', secondary: '#ff9800' },
                fonts: { title: 'Georgia', body: 'Times New Roman' },
                header: 'ðŸ›ï¸ SEZON SONU Ä°NDÄ°RÄ°MÄ° ðŸ›ï¸',
                slogan: 'Stoklar TÃ¼kenmeden!'
            },
            'new-year': {
                name: 'YÄ±lbaÅŸÄ± Ã–zel',
                colors: { bg: '#d32f2f', primary: '#ffffff', secondary: '#4caf50' },
                fonts: { title: 'Georgia', body: 'Arial' },
                header: 'ðŸŽ„ YILBAÅžI Ã–ZEL FIRSATLARI ðŸŽ„',
                slogan: 'Yeni YÄ±la Ã–zel Ä°ndirimler!'
            },
            'school': {
                name: 'Okul AlÄ±ÅŸveriÅŸi',
                colors: { bg: '#4caf50', primary: '#ffffff', secondary: '#2196f3' },
                fonts: { title: 'Comic Sans MS', body: 'Arial' },
                header: 'ðŸ“š OKUL ALIÅžVERÄ°ÅžÄ° ðŸ“š',
                slogan: 'Okula DÃ¶nÃ¼ÅŸ KampanyasÄ±!'
            }
        };
        
        // Template Selector Handler
        document.addEventListener('DOMContentLoaded', () => {
            const templateSelector = document.getElementById('template-selector');
            if (templateSelector) {
                templateSelector.addEventListener('change', handleTemplateSelection);
            }
            
            const aiTemplateBtn = document.getElementById('ai-template-btn');
            if (aiTemplateBtn) {
                aiTemplateBtn.addEventListener('click', handleAITemplateDesign);
            }
            
            const templateUploadInput = document.getElementById('template-upload-input');
            if (templateUploadInput) {
                templateUploadInput.addEventListener('change', handleTemplateUpload);
            }
        });
        
        function handleTemplateSelection() {
            const selector = document.getElementById('template-selector');
            const selectedTemplate = selector.value;
            
            if (!selectedTemplate) return;
            
            currentTemplate = selectedTemplate;
            
            if (selectedTemplate === 'custom') {
                // Open custom template dialog
                alert('Ã–zel ÅŸablon tasarÄ±mÄ± iÃ§in AI ile Åžablon Tasarla butonunu kullanÄ±n veya ÅŸablon dosyasÄ± yÃ¼kleyin.');
                return;
            }
            
            // Apply template configuration
            const config = templateConfigs[selectedTemplate];
            if (config) {
                applyTemplateToCanvas(config);
                showNotification(`âœ… ${config.name} ÅŸablonu uygulandÄ±!`);
            }
        }
        
        function applyTemplateToCanvas(config) {
            if (!fabricCanvas) return;
            
            // Add header text
            const headerText = new fabric.Textbox(config.header, {
                left: A4_WIDTH / 2,
                top: 30,
                width: A4_WIDTH - 60,
                fontSize: 32,
                fontFamily: config.fonts.title,
                fontWeight: 'bold',
                fill: config.colors.primary,
                textAlign: 'center',
                originX: 'center'
            });
            fabricCanvas.add(headerText);
            
            // Add slogan
            const sloganText = new fabric.Textbox(config.slogan, {
                left: A4_WIDTH / 2,
                top: 80,
                width: A4_WIDTH - 60,
                fontSize: 18,
                fontFamily: config.fonts.body,
                fill: config.colors.secondary,
                textAlign: 'center',
                originX: 'center'
            });
            fabricCanvas.add(sloganText);
            
            // Apply colors to existing products
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.productData) {
                    obj.item(0).set('fill', config.colors.bg);
                    obj.item(0).set('stroke', config.colors.primary);
                }
            });
            
            fabricCanvas.renderAll();
        }
        
        async function handleAITemplateDesign() {
            const aiBtn = document.getElementById('ai-template-btn');
            aiBtn.disabled = true;
            aiBtn.textContent = 'ðŸ¤– AI TasarlÄ±yor...';
            
            try {
                // Collect company info
                const companyInfo = {
                    name: document.getElementById('company-name')?.value || 'Market',
                    address: document.getElementById('company-address')?.value || '',
                    phone: document.getElementById('company-phone')?.value || '',
                    email: document.getElementById('company-email')?.value || ''
                };
                
                // Get products
                const res = await fetch('/api/products');
                const data = await res.json();
                const products = data.success ? data.products : [];
                
                // Get product category for background
                const category = products.length > 0 && products[0].product_group 
                    ? products[0].product_group.toLowerCase() 
                    : 'food';
                
                // Generate DALL-E background
                aiBtn.textContent = 'ðŸŽ¨ Arka plan oluÅŸturuluyor...';
                const bgRes = await fetch('/api/ai/generate-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme: 'market',
                        season: getCurrentSeason(),
                        category: category
                    })
                });
                
                const bgData = await bgRes.json();
                let backgroundUrl = null;
                
                if (bgData.success && bgData.background_url) {
                    backgroundUrl = bgData.background_url;
                    showNotification('âœ… DALL-E arka plan oluÅŸturuldu!');
                } else {
                    console.warn('Background generation failed:', bgData.error);
                }
                
                // Call AI design endpoint
                aiBtn.textContent = 'ðŸ¤– Åžablon tasarlanÄ±yor...';
                const designRes = await fetch('/api/ai/design-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_info: companyInfo,
                        products: products,
                        current_season: getCurrentSeason()
                    })
                });
                
                const designData = await designRes.json();
                
                if (designData.success) {
                    // Apply AI-generated template
                    applyAITemplate(designData.template, backgroundUrl);
                    showNotification('âœ… AI ÅŸablon tasarÄ±mÄ± baÅŸarÄ±yla uygulandÄ±!');
                } else {
                    alert('âŒ AI tasarÄ±m hatasÄ±: ' + (designData.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('âŒ Hata: ' + error.message);
            } finally {
                aiBtn.disabled = false;
                aiBtn.textContent = 'ðŸ¤– AI ile Åžablon Tasarla';
            }
        }
        
        function applyAITemplate(template, backgroundUrl = null) {
            if (!fabricCanvas) return;
            
            // Clear canvas first
            fabricCanvas.clear();
            
            // Apply background image or color
            if (backgroundUrl) {
                fabric.Image.fromURL(backgroundUrl, (img) => {
                    if (img) {
                        // Scale to fit canvas
                        const scaleX = A4_WIDTH / img.width;
                        const scaleY = A4_HEIGHT / img.height;
                        const scale = Math.max(scaleX, scaleY);
                        
                        img.set({
                            scaleX: scale,
                            scaleY: scale,
                            left: 0,
                            top: 0,
                            selectable: false,
                            evented: false
                        });
                        
                        fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
                    } else {
                        fabricCanvas.backgroundColor = template.backgroundColor || '#ffffff';
                    }
                }, { crossOrigin: 'anonymous' });
            } else {
                fabricCanvas.backgroundColor = template.backgroundColor || '#ffffff';
            }
            
            // Add header
            if (template.header) {
                const header = new fabric.Textbox(template.header, {
                    left: A4_WIDTH / 2,
                    top: 30,
                    width: A4_WIDTH - 60,
                    fontSize: template.headerSize || 32,
                    fontFamily: template.headerFont || 'Arial',
                    fontWeight: 'bold',
                    fill: template.headerColor || '#000000',
                    textAlign: 'center',
                    originX: 'center'
                });
                fabricCanvas.add(header);
            }
            
            // Add slogan
            if (template.slogan) {
                const slogan = new fabric.Textbox(template.slogan, {
                    left: A4_WIDTH / 2,
                    top: 80,
                    width: A4_WIDTH - 60,
                    fontSize: template.sloganSize || 18,
                    fontFamily: template.sloganFont || 'Arial',
                    fill: template.sloganColor || '#666666',
                    textAlign: 'center',
                    originX: 'center'
                });
                fabricCanvas.add(slogan);
            }
            
            // Auto-arrange products
            if (template.products && template.products.length > 0) {
                template.products.forEach((productLayout, index) => {
                    addProductWithLayout(productLayout, index);
                });
            }
            
            fabricCanvas.renderAll();
        }
        
        function addProductWithLayout(productLayout, index) {
            const cols = 3;
            const rows = 3;
            const startY = 150;
            const cardWidth = (A4_WIDTH - 80) / cols;
            const cardHeight = (A4_HEIGHT - 250) / rows;
            
            const col = index % cols;
            const row = Math.floor(index / cols);
            
            const x = 40 + (col * cardWidth);
            const y = startY + (row * cardHeight);
            
            const group = new fabric.Group([], {
                left: x,
                top: y,
                selectable: true
            });
            
            // Product card background
            const rect = new fabric.Rect({
                width: cardWidth - 10,
                height: cardHeight - 10,
                fill: productLayout.backgroundColor || '#f9f9f9',
                stroke: productLayout.borderColor || '#667eea',
                strokeWidth: 2,
                rx: 8,
                ry: 8
            });
            group.add(rect);
            
            // Product name
            const nameText = new fabric.Textbox(productLayout.name, {
                left: 10,
                top: 10,
                width: cardWidth - 30,
                fontSize: productLayout.nameSize || 14,
                fontFamily: productLayout.nameFont || 'Arial',
                fontWeight: 'bold',
                fill: productLayout.nameColor || '#333'
            });
            group.add(nameText);
            
            // Prices with discount badge
            if (productLayout.discount_percent > 0) {
                const discountBadge = new fabric.Textbox(`%${productLayout.discount_percent}`, {
                    left: cardWidth - 60,
                    top: 10,
                    width: 50,
                    fontSize: 16,
                    fontFamily: 'Arial',
                    fontWeight: 'bold',
                    fill: '#ff0000',
                    textAlign: 'center'
                });
                group.add(discountBadge);
            }
            
            // Price info
            const priceText = new fabric.Textbox(
                `${formatPrice(productLayout.normal_price)}\n${formatPrice(productLayout.discount_price)}`,
                {
                    left: 10,
                    top: cardHeight - 60,
                    width: cardWidth - 30,
                    fontSize: 12,
                    fontFamily: 'Arial',
                    fill: productLayout.priceColor || '#667eea'
                }
            );
            group.add(priceText);
            
            group.productData = productLayout;
            fabricCanvas.add(group);
        }
        
        async function handleTemplateUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            
            if (fileType === 'application/json') {
                // Handle JSON template
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const template = JSON.parse(e.target.result);
                        applyAITemplate(template);
                        showNotification('âœ… Åžablon baÅŸarÄ±yla yÃ¼klendi!');
                    } catch (error) {
                        alert('âŒ GeÃ§ersiz ÅŸablon dosyasÄ±!');
                    }
                };
                reader.readAsText(file);
            } else if (fileType.startsWith('image/')) {
                // Handle image template
                const reader = new FileReader();
                reader.onload = (e) => {
                    fabric.Image.fromURL(e.target.result, (img) => {
                        img.scaleToWidth(A4_WIDTH);
                        img.set({
                            left: 0,
                            top: 0,
                            selectable: false,
                            evented: false
                        });
                        fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
                        showNotification('âœ… GÃ¶rsel ÅŸablon arka plan olarak ayarlandÄ±!');
                    });
                };
                reader.readAsDataURL(file);
            }
        }
        
        function getCurrentSeason() {
            const month = new Date().getMonth() + 1;
            if (month >= 3 && month <= 5) return 'spring';
            if (month >= 6 && month <= 8) return 'summer';
            if (month >= 9 && month <= 11) return 'autumn';
            return 'winter';
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // THEME CUSTOMIZATION FUNCTIONS
        let currentTheme = {
            backgroundColor: '#ffffff',
            backgroundImage: null,
            border: 'none',
            fontFamily: 'Arial'
        };
        
        function openThemeModal() {
            document.getElementById('themeModal').style.display = 'flex';
            showNotification('ðŸŽ¨ Tema Ã¶zelleÅŸtirme paneli aÃ§Ä±ldÄ±');
        }
        
        function closeThemeModal() {
            document.getElementById('themeModal').style.display = 'none';
        }
        
        function switchThemeTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.theme-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.theme-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        function applyBackgroundColor() {
            const color = document.getElementById('bg-color-picker').value;
            if (!fabricCanvas) return;
            
            fabricCanvas.backgroundColor = color;
            fabricCanvas.renderAll();
            currentTheme.backgroundColor = color;
            
            const applyToAll = document.getElementById('apply-to-all-pages-theme').checked;
            if (applyToAll) {
                pages.forEach(page => {
                    if (page.backgroundColor !== undefined) {
                        page.backgroundColor = color;
                    }
                });
            }
            
            showNotification(`ðŸŽ¨ Arkaplan rengi uygulandÄ±: ${color}`);
        }
        
        function applyGradient(gradient) {
            if (!fabricCanvas) {
                return;
            }
            
            // Extract colors from CSS gradient string
            const colorMatches = gradient.match(/#[0-9a-f]{6}/gi);
            if (!colorMatches || colorMatches.length < 2) {
                fabricCanvas.backgroundColor = colorMatches ? colorMatches[0] : '#ffffff';
                fabricCanvas.renderAll();
                return;
            }
            
            // Create Fabric.js gradient
            const fabricGradient = new fabric.Gradient({
                type: 'linear',
                coords: {
                    x1: 0,
                    y1: 0,
                    x2: A4_WIDTH,
                    y2: A4_HEIGHT
                },
                colorStops: [
                    { offset: 0, color: colorMatches[0] },
                    { offset: 1, color: colorMatches[1] }
                ]
            });
            
            fabricCanvas.backgroundColor = fabricGradient;
            fabricCanvas.renderAll();
            currentTheme.backgroundColor = gradient;
            
            // Save to page state
            pages[currentPage].backgroundColor = gradient;
            
            const applyToAll = document.getElementById('apply-to-all-pages-theme').checked;
            if (applyToAll) {
                pages.forEach(page => {
                    page.backgroundColor = gradient;
                });
            }
            
            showNotification('âœ¨ Gradyan tema uygulandÄ±');
        }
        
        function applyTemplate(templateName) {
            if (!fabricCanvas) return;
            
            const templates = {
                'supermarket': {
                    background: '#fff9e6',
                    name: 'SÃ¼permarket'
                },
                'modern': {
                    background: '#f0f0f0',
                    name: 'Modern'
                },
                'fresh': {
                    background: '#e8f5e9',
                    name: 'Taze GÄ±da'
                },
                'tech': {
                    background: '#e3f2fd',
                    name: 'Teknoloji'
                },
                'luxury': {
                    background: '#1a1a2e',
                    name: 'LÃ¼ks'
                },
                'fun': {
                    background: '#fff3e0',
                    name: 'EÄŸlenceli'
                }
            };
            
            const template = templates[templateName];
            if (template) {
                fabricCanvas.backgroundColor = template.background;
                fabricCanvas.renderAll();
                currentTheme.backgroundColor = template.background;
                
                const applyToAll = document.getElementById('apply-to-all-pages-theme').checked;
                if (applyToAll) {
                    pages.forEach(page => {
                        if (page.backgroundColor !== undefined) {
                            page.backgroundColor = template.background;
                        }
                    });
                }
                
                showNotification(`ðŸ“ ${template.name} temasÄ± uygulandÄ±`);
            }
        }
        
        function applyBorder(borderType) {
            if (!fabricCanvas) {
                return;
            }
            
            const borders = {
                'classic': { width: 10, color: '#333', style: 'solid' },
                'elegant': { width: 15, color: '#d4af37', style: 'double' },
                'modern': { width: 8, color: '#667eea', style: 'solid' },
                'dashed': { width: 6, color: '#e74c3c', style: 'dashed' },
                'dotted': { width: 6, color: '#43e97b', style: 'dotted' },
                'none': { width: 0, color: 'transparent', style: 'none' }
            };
            
            const border = borders[borderType];
            if (border) {
                // Remove ALL existing borders first
                const objectsToRemove = fabricCanvas.getObjects().filter(obj => obj.name === 'page-border');
                objectsToRemove.forEach(obj => fabricCanvas.remove(obj));
                
                if (borderType !== 'none') {
                    const borderRect = new fabric.Rect({
                        left: border.width / 2,
                        top: border.width / 2,
                        width: A4_WIDTH - border.width,
                        height: A4_HEIGHT - border.width,
                        fill: 'transparent',
                        stroke: border.color,
                        strokeWidth: border.width,
                        strokeDashArray: border.style === 'dashed' ? [10, 5] : (border.style === 'dotted' ? [2, 5] : null),
                        selectable: false,
                        evented: false,
                        name: 'page-border'
                    });
                    fabricCanvas.add(borderRect);
                    fabricCanvas.sendToBack(borderRect);
                    
                    // Save border to page state
                    pages[currentPage].border = borderType;
                } else {
                    pages[currentPage].border = null;
                }
                
                const applyToAll = document.getElementById('apply-to-all-pages-theme').checked;
                if (applyToAll) {
                    pages.forEach(page => {
                        page.border = borderType !== 'none' ? borderType : null;
                    });
                }
                
                fabricCanvas.renderAll();
                showNotification(`ðŸ–¼ï¸ ${borderType} Ã§erÃ§eve uygulandÄ±`);
            }
        }
        
        function applyFontTheme(themeName) {
            if (!fabricCanvas) return;
            
            const fontThemes = {
                'professional': { font: 'Arial', weight: 'normal' },
                'elegant': { font: 'Georgia', weight: 'normal' },
                'modern': { font: 'Helvetica', weight: 'normal' },
                'bold': { font: 'Impact', weight: 'bold' }
            };
            
            const theme = fontThemes[themeName];
            if (theme) {
                const objects = fabricCanvas.getObjects();
                objects.forEach(obj => {
                    if (obj.type === 'text' || obj.type === 'textbox' || obj.type === 'i-text') {
                        obj.fontFamily = theme.font;
                        obj.fontWeight = theme.weight;
                    } else if (obj.type === 'group') {
                        obj.getObjects().forEach(subObj => {
                            if (subObj.type === 'text' || subObj.type === 'textbox' || subObj.type === 'i-text') {
                                subObj.fontFamily = theme.font;
                                subObj.fontWeight = theme.weight;
                            }
                        });
                    }
                });
                
                fabricCanvas.renderAll();
                currentTheme.fontFamily = theme.font;
                showNotification(`âœï¸ ${themeName} font temasÄ± uygulandÄ±`);
            }
        }
        
        function removeBackground() {
            if (!fabricCanvas) return;
            
            fabricCanvas.backgroundColor = '#ffffff';
            fabricCanvas.backgroundImage = null;
            fabricCanvas.renderAll();
            currentTheme.backgroundColor = '#ffffff';
            currentTheme.backgroundImage = null;
            
            showNotification('ðŸ—‘ï¸ Arkaplan kaldÄ±rÄ±ldÄ±');
        }
        
        // Background image upload handler
        document.addEventListener('DOMContentLoaded', function() {
            const bgImageInput = document.getElementById('bg-image-input');
            if (bgImageInput) {
                bgImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && fabricCanvas) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            fabric.Image.fromURL(event.target.result, function(img) {
                                const repeat = document.getElementById('bg-repeat').checked;
                                const cover = document.getElementById('bg-cover').checked;
                                
                                if (cover) {
                                    img.scaleToWidth(A4_WIDTH);
                                    img.scaleToHeight(A4_HEIGHT);
                                }
                                
                                fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
                                    scaleX: cover ? fabricCanvas.width / img.width : 1,
                                    scaleY: cover ? fabricCanvas.height / img.height : 1
                                });
                                
                                currentTheme.backgroundImage = event.target.result;
                                // Save to page state
                                pages[currentPage].backgroundImage = event.target.result;
                                
                                const applyToAll = document.getElementById('apply-to-all-pages-theme').checked;
                                if (applyToAll) {
                                    pages.forEach(page => {
                                        page.backgroundImage = event.target.result;
                                    });
                                }
                                
                                showNotification('ðŸ–¼ï¸ Arkaplan resmi yÃ¼klendi');
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Theme button event listener
            const themeBtn = document.getElementById('theme-customize-btn');
            if (themeBtn) {
                themeBtn.addEventListener('click', openThemeModal);
            }
        });
        
        // Unified Lock/Unlock System (syncs with page lock)
        function toggleFreeMode() {
            // Guard: only operate if canvas is initialized
            if (!fabricCanvas || !pages[currentPage]) {
                console.warn('Canvas not initialized or no current page');
                return;
            }
            
            // Toggle page lock state
            pages[currentPage].locked = !pages[currentPage].locked;
            isFreeMode = !pages[currentPage].locked;
            
            // Update both UI elements
            updateFreeModeUI();
            updateLockButton();
            
            // Toggle all objects
            const objects = fabricCanvas.getObjects();
            objects.forEach(obj => {
                obj.selectable = isFreeMode;
                obj.evented = isFreeMode;
                obj.hasControls = isFreeMode;
                obj.hasBorders = isFreeMode;
            });
            
            fabricCanvas.selection = isFreeMode;
            fabricCanvas.renderAll();
            
            // Show notification
            if (isFreeMode) {
                showNotification('ðŸ”“ Serbest Mod - Her ÅŸey taÅŸÄ±nabilir');
            } else {
                showNotification('ðŸ”’ Kilitli Mod - TaÅŸÄ±ma engellendi');
            }
        }
        
        function updateFreeModeUI() {
            const toggleBtn = document.getElementById('free-mode-toggle');
            if (!toggleBtn) return;
            
            // Sync with page lock state
            isFreeMode = !pages[currentPage]?.locked;
            
            if (isFreeMode) {
                toggleBtn.textContent = 'ðŸ”“ Serbest Mod';
                toggleBtn.style.background = '#10b981';
                toggleBtn.style.color = 'white';
            } else {
                toggleBtn.textContent = 'ðŸ”’ Kilitli';
                toggleBtn.style.background = '#ef4444';
                toggleBtn.style.color = 'white';
            }
        }
        
        // Keyboard shortcut: Ctrl+L for lock/unlock
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                toggleFreeMode();
            }
        });
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        fileInput.addEventListener('change', uploadFile);

        const logoInput = document.getElementById('company-logo-input');
        logoInput.addEventListener('change', handleLogoUpload);

        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('company-logo-preview');
                preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:contain;border-radius:12px;">`;
            };
            reader.readAsDataURL(file);
            
            const formData = new FormData();
            formData.append('logo', file);
            
            try {
                const res = await fetch('/api/upload-logo', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    showNotification('âœ… Logo yÃ¼klendi!');
                    
                    if (fabricCanvas) {
                        fabric.Image.fromURL(data.logo_url, (img) => {
                            img.scaleToWidth(400);
                            const canvasWidth = fabricCanvas.width;
                            const canvasHeight = fabricCanvas.height;
                            img.set({ 
                                left: (canvasWidth - img.width * img.scaleX) / 2, 
                                top: 50, 
                                selectable: true 
                            });
                            fabricCanvas.add(img);
                            fabricCanvas.renderAll();
                        });
                    }
                } else {
                    alert('Logo yÃ¼kleme hatasÄ±: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('Logo yÃ¼kleme hatasÄ±: ' + error.message);
            }
        }

        async function uploadFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const res = await fetch('/api/upload-products', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            if (data.success) {
                if (data.redirect) {
                    sessionStorage.setItem('preApprovalProducts', JSON.stringify(data.products || []));
                    window.location.href = data.redirect;
                } else {
                    alert(`âœ… ${data.count} Ã¼rÃ¼n yÃ¼klendi!`);
                    loadProducts();
                }
            } else {
                alert('Hata: ' + data.error);
            }
        }

        async function loadProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();

            if (data.success) {
                productsList.innerHTML = '';
                
                const normalizedProducts = (data.products || []).map(prod => normalizeProduct({ ...prod }));
                
                // Save to global for wizard access
                window.allProducts = normalizedProducts;
                console.log('ðŸ“¦ ÃœrÃ¼nler yÃ¼klendi:', window.allProducts.length);
                const pageAssignments = data.page_assignments || {};
                const hasAssignments = Object.keys(pageAssignments).length > 0;
                
                if (hasAssignments) {
                    console.log('ðŸ“‹ Page assignments detected:', pageAssignments);
                    autoPlaceProductsOnPages(normalizedProducts, pageAssignments);
                }
                
                normalizedProducts.forEach((prod) => {
                    const div = document.createElement('div');
                    div.className = 'product-item';
                    div.draggable = true;
                    
                    const assignedPage = pageAssignments[prod.id];
                    if (assignedPage) {
                        div.style.border = '2px solid #10b981';
                        div.style.opacity = '0.7';
                        div.title = `Sayfa ${assignedPage}'ye atandÄ±`;
                    }
                    
                    div.ondragstart = (e) => {
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('product', JSON.stringify({
                            id: prod.id,
                            name: prod.name,
                            normal_price: prod.normal_price,
                            discount_price: prod.discount_price,
                            barcode: prod.barcode,
                            image_url: prod.image_url
                        }));
                    };
                    
                    const discount = Math.round(((prod.normal_price - prod.discount_price) / prod.normal_price) * 100) || 0;
                    div.innerHTML = `
                        <div class="product-name">${prod.name}${assignedPage ? ` <span style="color: #10b981; font-size: 10px;">(S${assignedPage})</span>` : ''}</div>
                        <div class="product-price">
                            %${discount} Ä°ndirim | ${formatPrice(prod.discount_price)}
                        </div>
                        ${!prod.image_url ? `<div class="product-action" onclick="openImageModal(${prod.id}, '${prod.name}')">ðŸ” Resim Bul</div>` : '<div class="product-action" style="color: green;">âœ… Resim var</div>'}
                    `;
                    productsList.appendChild(div);
                });
                
                if (hasAssignments) {
                    showNotification('âœ… ÃœrÃ¼nler otomatik olarak sayfalara yerleÅŸtirildi!');
                }
            }
        }

        let currentProductId = null;

        async function openImageModal(productId, productName) {
            currentProductId = productId;
            document.getElementById('modalTitle').textContent = `ðŸ” ${productName} - Resim Bul`;
            document.getElementById('modalBody').innerHTML = '<p style="text-align: center; color: #999;">YÃ¼kleniyor...</p>';
            document.getElementById('imageModal').classList.add('show');

            try {
                const res = await fetch('/api/find-product-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_name: productName })
                });

                const data = await res.json();

                if (data.success) {
                    let html = '<p style="margin-bottom: 12px; font-size: 12px; color: #666;">Google Images\'da bu terimlerle ara:</p>';
                    data.search_terms.forEach((term, i) => {
                        html += `<div class="search-term" onclick="copyToClipboard('${term}')">ðŸ“Œ ${term}</div>`;
                    });
                    html += `
                        <div class="image-input-group">
                            <p style="font-size: 11px; color: #999; margin-bottom: 5px;">Veya direkt resim URL'i yapÄ±ÅŸtÄ±r:</p>
                            <input type="text" id="imageUrl" placeholder="https://...jpg" />
                        </div>
                    `;
                    document.getElementById('modalBody').innerHTML = html;
                } else {
                    document.getElementById('modalBody').innerHTML = `<p style="color: red;">âŒ ${data.error}</p>`;
                }
            } catch (e) {
                document.getElementById('modalBody').innerHTML = `<p style="color: red;">âŒ Hata: ${e.message}</p>`;
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
            currentProductId = null;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert(`"${text}" kopyalandÄ±. Google Images'ta ara!`);
        }

        // Modal buton ekle
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('imageModal');
            const modalBody = document.getElementById('modalBody');
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn-primary';
            saveBtn.textContent = 'ðŸ’¾ Kaydet';
            saveBtn.onclick = async () => {
                const imageUrl = document.getElementById('imageUrl')?.value;
                if (!imageUrl) {
                    alert('LÃ¼tfen resim URL\'i girin');
                    return;
                }
                
                const res = await fetch('/api/update-product-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id: currentProductId, image_url: imageUrl })
                });
                
                if ((await res.json()).success) {
                    alert('âœ… Resim kaydedildi!');
                    closeImageModal();
                    loadProducts();
                }
            };

            const modalButtons = modal.querySelector('.modal-buttons');
            modalButtons.insertBefore(saveBtn, modalButtons.querySelector('.btn-close'));
        });

        function showMainScreen(user) {
            // Update username if element exists (legacy support)
            const usernameEl = document.getElementById('username');
            if (usernameEl) {
                usernameEl.textContent = user.name || 'Market';
            }
            
            // Show main screen (no login screen in this file)
            mainScreen.style.display = 'block';
            
            // Admin'se editÃ¶r linkini gÃ¶ster
            if (user.role === 'admin') {
                const editorLink = document.getElementById('editor-link');
                if (editorLink) {
                    editorLink.style.display = 'inline-block';
                }
            }
            
            // Free mode button is always visible now
            
            // Initialize Fabric.js Canvas
            initializeFabricCanvas();
            
            // Load saved company info and social media
            loadCompanyInfo();
            loadSocialMedia();
            loadMealCards();
        }

        // Initialize Fabric.js Canvas
        function initializeFabricCanvas() {
            if (!fabricCanvas) {
                fabricCanvas = new fabric.Canvas('brochure-canvas', {
                    width: A4_WIDTH,
                    height: A4_HEIGHT,
                    backgroundColor: '#ffffff',
                    preserveObjectStacking: true
                });
                
                // Initialize with 3 pages
                for (let i = 0; i < 3; i++) {
                    pages.push({
                        data: {},
                        objects: [],
                        locked: false,
                        backgroundColor: '#ffffff',
                        border: null
                    });
                }
                
                // Enable drop on canvas
                fabricCanvas.on('drop', function(e) {
                    e.e.preventDefault();
                    const data = e.e.dataTransfer.getData('product');
                    if (data) {
                        const product = JSON.parse(data);
                        addProductToCanvas(product);
                    }
                });
                
                // Setup enhanced drag-drop
                setupDragAndDrop();
                
                // Enable object deletion with Delete key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Delete' && fabricCanvas) {
                        const activeObject = fabricCanvas.getActiveObject();
                        if (activeObject) {
                            if (activeObject.productData) {
                                // Move to parking instead of deleting
                                parkingArea.push(activeObject.productData);
                                updateParkingArea();
                                showNotification('ðŸ“¦ ÃœrÃ¼n park alanÄ±na taÅŸÄ±ndÄ±');
                            }
                            fabricCanvas.remove(activeObject);
                        }
                    }
                });
                
                // Initialize both lock UI elements
                updateFreeModeUI();
                updateLockButton();
                
                // DÃ¼zenleme modu olaylarÄ±nÄ± kur
                setupEditModeEvents();
                
                loadProducts();
            }
        }
        
        // Multi-page functions
        function switchPage(pageIndex, options = {}) {
            if (pageIndex < 0 || pageIndex >= pages.length) return;
            
            const skipLoad = options.skipLoad === true;
            
            // Save current page state (including theme)
            if (fabricCanvas) {
                pages[currentPage].data = fabricCanvas.toJSON();
                pages[currentPage].objects = fabricCanvas.getObjects().map(obj => obj.productData).filter(Boolean);
                // Save theme settings
                if (fabricCanvas.backgroundColor) {
                    pages[currentPage].backgroundColor = typeof fabricCanvas.backgroundColor === 'string' 
                        ? fabricCanvas.backgroundColor 
                        : currentTheme.backgroundColor;
                }
            }
            
            // Switch to new page
            currentPage = pageIndex;
            
            // Update tabs
            const tabs = document.querySelectorAll('.page-tab');
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === pageIndex);
            });
            
            // Load new page
            if (fabricCanvas) {
                fabricCanvas.clear();
                
                // Restore theme FIRST (before loading objects)
                if (pages[currentPage].backgroundColor) {
                    // Check if it's a gradient
                    if (pages[currentPage].backgroundColor.includes('gradient')) {
                        applyGradient(pages[currentPage].backgroundColor);
                    } else {
                        fabricCanvas.backgroundColor = pages[currentPage].backgroundColor;
                    }
                }
                
                // Restore background image if exists
                if (pages[currentPage].backgroundImage) {
                    fabric.Image.fromURL(pages[currentPage].backgroundImage, function(img) {
                        fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
                            scaleX: fabricCanvas.width / img.width,
                            scaleY: fabricCanvas.height / img.height
                        });
                    });
                }
                
                // Restore border if exists
                if (pages[currentPage].border) {
                    applyBorder(pages[currentPage].border);
                }
                
                // Apply template if exists
                if (currentTemplate && templateConfigs[currentTemplate]) {
                    applyTemplateToCanvas(templateConfigs[currentTemplate]);
                }
                
                if (!skipLoad) {
                    // Load page content (objects)
                    if (pages[currentPage].data && pages[currentPage].data.objects) {
                        fabricCanvas.loadFromJSON(pages[currentPage].data, () => {
                            // FORCE lock state from page (override any saved flags)
                            const isLocked = pages[currentPage].locked || false;
                            const objects = fabricCanvas.getObjects();
                            objects.forEach(obj => {
                                // Override any saved selectable/evented flags
                                obj.set({
                                    selectable: !isLocked,
                                    evented: !isLocked,
                                    hasControls: !isLocked,
                                    hasBorders: !isLocked
                                });
                            });
                            fabricCanvas.selection = !isLocked;
                            fabricCanvas.renderAll();
                            setupDragAndDrop();
                        });
                    } else if (pages[currentPage].objects) {
                        // Restore products if data not saved
                        pages[currentPage].objects.forEach((product, index) => {
                            if (product) {
                                const x = 50 + (index % 3) * 160;
                                const y = 150 + Math.floor(index / 3) * 220;
                                addProductToCanvasAt(product, x, y);
                            }
                        });
                        fabricCanvas.renderAll();
                        setupDragAndDrop();
                    } else {
                        setupDragAndDrop();
                    }
                } else {
                    const isLocked = pages[currentPage].locked || false;
                    fabricCanvas.selection = !isLocked;
                    fabricCanvas.renderAll();
                    setupDragAndDrop();
                }
            }
            
            // Update both lock UI elements
            updateLockButton();
            updateFreeModeUI();
            showNotification(`ðŸ“„ Sayfa ${pageIndex + 1} aÃ§Ä±ldÄ±`);
        }
        
        function addNewPage() {
            pages.push({
                data: {},
                objects: [],
                locked: false
            });
            
            const pageIndex = pages.length - 1;
            const tabsContainer = document.getElementById('page-tabs');
            const newTab = document.createElement('button');
            newTab.className = 'page-tab';
            newTab.textContent = `ðŸ“„ Sayfa ${pages.length}`;
            newTab.onclick = () => switchPage(pageIndex);
            
            // Insert before "Add" button
            const addBtn = tabsContainer.querySelector('.add-page');
            tabsContainer.insertBefore(newTab, addBtn);
            
            switchPage(pageIndex);
        }
        
        function togglePageLock() {
            // Delegate to unified toggle function
            toggleFreeMode();
        }
        
        function updateLockButton() {
            const lockBtn = document.getElementById('lock-btn');
            if (!lockBtn) return;
            
            if (pages[currentPage] && pages[currentPage].locked) {
                lockBtn.innerHTML = 'ðŸ”’ Kilidi AÃ§';
                lockBtn.classList.add('active');
            } else {
                lockBtn.innerHTML = 'ðŸ”“ Kilitle';
                lockBtn.classList.remove('active');
            }
        }
        
        // Canvas control functions
        function setZoom(zoom) {
            currentZoom = zoom;
            if (fabricCanvas) {
                fabricCanvas.setZoom(zoom);
                fabricCanvas.setDimensions({
                    width: A4_WIDTH * zoom,
                    height: A4_HEIGHT * zoom
                });
            }
            
            // Update zoom buttons
            document.querySelectorAll('.canvas-controls .control-btn').forEach(btn => {
                if (btn.textContent.includes('%')) {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');
        }
        
        function updateFont() {
            currentFont = document.getElementById('font-selector').value;
            const selected = fabricCanvas && fabricCanvas.getActiveObject();
            if (selected && selected.type === 'textbox') {
                selected.set('fontFamily', currentFont);
                fabricCanvas.renderAll();
            }
        }
        
        function updateFontSize() {
            currentFontSize = parseInt(document.getElementById('font-size').value);
            const selected = fabricCanvas && fabricCanvas.getActiveObject();
            if (selected && selected.type === 'textbox') {
                selected.set('fontSize', currentFontSize);
                fabricCanvas.renderAll();
            }
        }
        
        function applyToPage() {
            if (!fabricCanvas) return;
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.type === 'textbox') {
                    obj.set({
                        fontFamily: currentFont,
                        fontSize: currentFontSize
                    });
                }
            });
            fabricCanvas.renderAll();
        }
        
        function applyToAll() {
            pages.forEach((page, i) => {
                if (i === currentPage) {
                    applyToPage();
                } else if (page.data && page.data.objects) {
                    page.data.objects.forEach(obj => {
                        if (obj.type === 'textbox') {
                            obj.fontFamily = currentFont;
                            obj.fontSize = currentFontSize;
                        }
                    });
                }
            });
        }
        
        // Add product to canvas
        function addProductToCanvas(product) {
            if (!fabricCanvas) return;
            product = normalizeProduct(product);
            const isLocked = pages[currentPage]?.locked || false;
            addCardToCanvas(product, {
                left: 50,
                top: 50,
                selectable: !isLocked,
                evented: !isLocked,
                hasControls: !isLocked,
                hasBorders: !isLocked
            });
        }
        
        function autoPlaceProductsOnPages(products, pageAssignments) {
            if (!fabricCanvas || !products || !pageAssignments) return;
            
            const maxPageNum = Math.max(...Object.values(pageAssignments).map(p => parseInt(p)));
            
            while (pages.length < maxPageNum) {
                pages.push({
                    data: {},
                    objects: [],
                    locked: false,
                    backgroundColor: '#ffffff',
                    border: null
                });
                console.log(`âž• Created page ${pages.length}`);
            }
            
            updatePageTabs();
            
            const productsPerPage = {};
            products.forEach(product => {
                const pageNum = pageAssignments[product.id];
                if (pageNum) {
                    if (!productsPerPage[pageNum]) {
                        productsPerPage[pageNum] = [];
                    }
                    productsPerPage[pageNum].push(product);
                }
            });
            
            Object.entries(productsPerPage).forEach(([pageNum, pageProducts]) => {
                const pageIndex = parseInt(pageNum) - 1;
                if (pageIndex >= 0 && pageIndex < pages.length) {
                    switchPage(pageIndex, { skipLoad: true });
                    
                    const existingObjects = fabricCanvas.getObjects();
                    if (existingObjects.length > 0) {
                        console.warn(`âš ï¸ Page ${pageNum} already has ${existingObjects.length} objects. Skipping auto-placement to preserve existing content.`);
                        return;
                    }
                    
                    fabricCanvas.clear();
                    fabricCanvas.backgroundColor = pages[pageIndex].backgroundColor || '#ffffff';
                    
                    const startX = getCardGridStartX();
                    const startY = CARD_LAYOUT.START_Y;
                    
                    pageProducts.forEach((product, index) => {
                        const { x, y } = getCardPosition(index, startX, startY);
                        const card = addCardToCanvas(product, { left: x, top: y, suppressRender: true });
                        if (card && card.productData) {
                            card.productData.assignedPage = pageNum;
                        }
                    });
                    
                    pages[pageIndex].data = fabricCanvas.toJSON();
                    pages[pageIndex].objects = fabricCanvas.getObjects().map(obj => obj.productData).filter(Boolean);
                    
                    fabricCanvas.renderAll();
                    console.log(`âœ… Page ${pageNum}: Placed ${pageProducts.length} products`);
                }
            });
            
            switchPage(0);
            fabricCanvas.renderAll();
        }
        
        // Parking area functions
        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        function dropToParking(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData('product');
            if (data) {
                const product = JSON.parse(data);
                parkingArea.push(product);
                updateParkingArea();
            }
        }
        
        function updateParkingArea() {
            const parkingDiv = document.getElementById('parking-area');
            const counter = document.getElementById('parking-counter');
            
            counter.textContent = `${parkingArea.length} Ã¼rÃ¼n`;
            
            parkingDiv.innerHTML = '';
            parkingArea.forEach((product, i) => {
                const div = document.createElement('div');
                div.className = 'product-item';
                div.draggable = true;
                div.ondragstart = (e) => {
                    e.dataTransfer.setData('product', JSON.stringify(product));
                    e.dataTransfer.setData('fromParking', 'true');
                    e.dataTransfer.setData('parkingIndex', i.toString());
                };
                
                const discount = Math.round(((product.normal_price - product.discount_price) / product.normal_price) * 100) || 0;
                div.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">
                        %${discount} Ä°ndirim | ${formatPrice(product.discount_price)}
                    </div>
                    <div class="product-action" onclick="removeFromParking(${i})">âŒ KaldÄ±r</div>
                `;
                parkingDiv.appendChild(div);
            });
        }
        
        function removeFromParking(index) {
            parkingArea.splice(index, 1);
            updateParkingArea();
        }
        
        // Enhanced drag-drop functionality
        function setupDragAndDrop() {
            // Enable drag from product list to canvas
            fabricCanvas.on('drop', function(e) {
                e.e.preventDefault();
                const data = e.e.dataTransfer.getData('product');
                const fromParking = e.e.dataTransfer.getData('fromParking') === 'true';
                const parkingIndex = e.e.dataTransfer.getData('parkingIndex');
                
                if (data) {
                    const product = JSON.parse(data);
                    
                    // Get mouse position on canvas
                    const pointer = fabricCanvas.getPointer(e.e);
                    addProductToCanvasAt(product, pointer.x, pointer.y);
                    
                    // If from parking, remove from parking area
                    if (fromParking && parkingIndex !== undefined) {
                        parkingArea.splice(parseInt(parkingIndex), 1);
                        updateParkingArea();
                    }
                }
            });
            
            // Enable drag from canvas to parking
            fabricCanvas.on('mouse:up', function(options) {
                if (!options.target || !options.e) return;
                
                // Check if object is being dragged out of canvas bounds
                const obj = options.target;
                const bounds = obj.getBoundingRect();
                const canvasBounds = fabricCanvas.getElement().getBoundingClientRect();
                
                // If object is moved to parking area (right side)
                if (bounds.left > fabricCanvas.width - 50) {
                    if (obj.productData) {
                        // Move to parking
                        parkingArea.push(obj.productData);
                        updateParkingArea();
                        fabricCanvas.remove(obj);
                        showNotification('ðŸ“¦ ÃœrÃ¼n park alanÄ±na taÅŸÄ±ndÄ±');
                    }
                }
            });
        }
        
        // Enhanced product addition with position
        function addProductToCanvasAt(product, x, y) {
            if (!fabricCanvas) return;
            product = normalizeProduct(product);
            
            // Respect current page lock state
            const isLocked = pages[currentPage]?.locked || false;
            addCardToCanvas(product, {
                left: x || 50,
                top: y || 50,
                selectable: !isLocked,
                evented: !isLocked,
                hasControls: !isLocked,
                hasBorders: !isLocked
            });
            
            // Save page state
            pages[currentPage].data = fabricCanvas.toJSON();
        }
        
        // Fix park area remove function
        function removeFromParking(index) {
            if (index >= 0 && index < parkingArea.length) {
                const product = parkingArea[index];
                
                // Option to add back to canvas
                if (confirm('ÃœrÃ¼nÃ¼ tekrar canvas\'a eklemek ister misiniz?')) {
                    addProductToCanvasAt(product, 100, 100);
                }
                
                parkingArea.splice(index, 1);
                updateParkingArea();
            }
        }
        
        // Add event handlers for new buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-layout button
            const autoLayoutBtn = document.getElementById('auto-layout-btn');
            if (autoLayoutBtn) {
                autoLayoutBtn.addEventListener('click', handleAutoLayout);
            }
            
            // AI Slogan button
            const aiSloganBtn = document.getElementById('ai-slogan-btn');
            if (aiSloganBtn) {
                aiSloganBtn.addEventListener('click', handleAISlogan);
            }
            
            // JPEG export button
            const jpegBtn = document.getElementById('jpeg-btn');
            if (jpegBtn) {
                jpegBtn.addEventListener('click', handleJPEGExport);
            }

                const cardFontDecreaseBtn = document.getElementById('card-font-decrease');
                if (cardFontDecreaseBtn) {
                    cardFontDecreaseBtn.addEventListener('click', () => adjustCardFonts('decrease'));
                }

                const cardFontIncreaseBtn = document.getElementById('card-font-increase');
                if (cardFontIncreaseBtn) {
                    cardFontIncreaseBtn.addEventListener('click', () => adjustCardFonts('increase'));
                }
        });
        
        // Auto-layout handler
        async function handleAutoLayout() {
            const btn = document.getElementById('auto-layout-btn');
            btn.disabled = true;
            btn.textContent = 'ðŸŽ¯ DÃ¼zenleniyor...';
            
            try {
                // Get products from current page
                const pageProducts = [];
                if (fabricCanvas) {
                    fabricCanvas.getObjects().forEach(obj => {
                        if (obj.productData) {
                            pageProducts.push(obj.productData);
                        }
                    });
                }
                
                if (pageProducts.length === 0) {
                    alert('Canvas\'ta dÃ¼zenlenecek Ã¼rÃ¼n yok!');
                    return;
                }
                
                const response = await fetch('/api/auto-layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        products: pageProducts,
                        page_size: { width: A4_WIDTH, height: A4_HEIGHT }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.layout) {
                    // Clear canvas
                    fabricCanvas.clear();
                    fabricCanvas.backgroundColor = '#ffffff';
                    
                    // Apply template first if selected
                    if (currentTemplate && templateConfigs[currentTemplate]) {
                        applyTemplateToCanvas(templateConfigs[currentTemplate]);
                    }
                    
                    // Apply auto-layout
                    data.layout.forEach(item => {
                        addProductToCanvasAt(item.product, item.position.x, item.position.y);
                    });
                    
                    showNotification('âœ… Otomatik dÃ¼zenleme tamamlandÄ±!');
                } else {
                    alert('DÃ¼zenleme hatasÄ±: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸŽ¯ AI Otomatik DÃ¼zenle';
            }
        }
        
        // AI Slogan handler - Opens modal with campaign slogans
        async function handleAISlogan() {
            await showAISloganModal();
        }
        
        // Show AI Slogan Modal with campaign slogans
        async function showAISloganModal() {
            const btn = document.getElementById('ai-slogan-btn');
            btn.disabled = true;
            btn.textContent = 'ðŸ”„ Sloganlar OluÅŸturuluyor...';
            
            try {
                // Get slogans from AI
                const res1 = await fetch('/api/ai/suggest-slogans');
                const data1 = await res1.json();
                
                if (!data1.success || !data1.slogans || data1.slogans.length === 0) {
                    alert('âŒ Slogan oluÅŸturulamadÄ±: ' + (data1.error || 'Bilinmeyen hata'));
                    return;
                }
                
                const slogans = data1.slogans;
                
                // Show modal
                const modal = document.getElementById('slogan-modal');
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                
                // Show loading message
                const sloganList = document.getElementById('slogan-list');
                sloganList.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">ðŸ”„ 3D gÃ¶rseller oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';
                
                // Generate images for each slogan
                for (let i = 0; i < slogans.length; i++) {
                    const slogan = slogans[i];
                    
                    try {
                        const res2 = await fetch('/api/ai/generate-slogan-image', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({slogan: slogan})
                        });
                        const data2 = await res2.json();
                        
                        // Clear loading message on first slogan
                        if (i === 0) {
                            sloganList.innerHTML = '';
                        }
                        
                        // Add slogan card
                        const card = document.createElement('div');
                        card.style.cssText = 'background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s;';
                        card.onmouseenter = () => card.style.transform = 'translateY(-5px)';
                        card.onmouseleave = () => card.style.transform = 'translateY(0)';
                        
                        if (data2.success && data2.image_url) {
                            card.innerHTML = `
                                <img src="${data2.image_url}" 
                                     style="width:100%; height:auto; border-radius:8px; margin-bottom:10px;"
                                     alt="${slogan}">
                                <p style="font-weight:bold; margin:10px 0; font-size:14px; color:#333;">${slogan}</p>
                                <button onclick="addSloganToCanvas('${slogan.replace(/'/g, "\\'")}', '${data2.image_url}')" 
                                        style="width:100%; padding:10px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                                    Canvas'a Ekle
                                </button>
                            `;
                        } else {
                            // Fallback: text only
                            card.innerHTML = `
                                <div style="height:150px; display:flex; align-items:center; justify-content:center; background:#f0f0f0; border-radius:8px; margin-bottom:10px;">
                                    <span style="font-size:24px; font-weight:bold; color:#667eea;">${slogan}</span>
                                </div>
                                <p style="font-weight:bold; margin:10px 0; font-size:14px; color:#333;">${slogan}</p>
                                <button onclick="addSloganToCanvas('${slogan.replace(/'/g, "\\'")}', '')" 
                                        style="width:100%; padding:10px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                                    Canvas'a Ekle
                                </button>
                            `;
                        }
                        
                        sloganList.appendChild(card);
                    } catch (error) {
                        console.error('Error generating slogan image:', error);
                    }
                }
                
                showNotification('âœ… Sloganlar hazÄ±r! Birini seÃ§in.');
            } catch (error) {
                alert('âŒ Hata: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸ¤– AI Slogan Ekle';
            }
        }
        
        // Close slogan modal
        function closeSloganModal() {
            const modal = document.getElementById('slogan-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        // Add slogan to canvas
        function addSloganToCanvas(text, imageUrl) {
            if (!fabricCanvas) {
                alert('Canvas hazÄ±r deÄŸil!');
                return;
            }
            
            // Option 1: As image (DALL-E 3D image)
            if (imageUrl && imageUrl.trim() !== '') {
                fabric.Image.fromURL(imageUrl, (img) => {
                    if (!img) {
                        // Fallback to text if image fails
                        addSloganAsText(text);
                        return;
                    }
                    
                    // Scale to fit canvas width
                    const maxWidth = A4_WIDTH - 100;
                    if (img.width > maxWidth) {
                        img.scaleToWidth(maxWidth);
                    }
                    
                    img.set({
                        left: A4_WIDTH / 2,
                        top: 50,
                        originX: 'center',
                        selectable: true,
                        hasControls: true,
                        hasBorders: true
                    });
                    
                    fabricCanvas.add(img);
                    fabricCanvas.setActiveObject(img);
                    fabricCanvas.renderAll();
                    
                    showNotification('âœ… Slogan canvas\'a eklendi!');
                }, { crossOrigin: 'anonymous' });
            } else {
                // Option 2: As text (if no image)
                addSloganAsText(text);
            }
            
            closeSloganModal();
        }
        
        // Helper: Add slogan as text
        function addSloganAsText(text) {
            const sloganText = new fabric.Textbox(text, {
                left: A4_WIDTH / 2,
                top: 50,
                width: A4_WIDTH - 100,
                fontSize: 60,
                fontFamily: 'Arial Black',
                fontWeight: 'bold',
                fill: '#ff0000',
                stroke: '#ffffff',
                strokeWidth: 3,
                textAlign: 'center',
                originX: 'center',
                shadow: new fabric.Shadow({
                    color: 'rgba(0,0,0,0.5)',
                    blur: 8,
                    offsetX: 4,
                    offsetY: 4
                })
            });
            
            fabricCanvas.add(sloganText);
            fabricCanvas.setActiveObject(sloganText);
            fabricCanvas.renderAll();
            
            showNotification('âœ… Slogan canvas\'a eklendi!');
        }
        
        // JPEG Export handler
        async function handleJPEGExport() {
            const btn = document.getElementById('jpeg-btn');
            btn.disabled = true;
            btn.textContent = 'ðŸ–¼ï¸ JPEG OluÅŸturuluyor...';
            
            try {
                if (!fabricCanvas) {
                    alert('Canvas hazÄ±r deÄŸil!');
                    return;
                }
                
                // Get canvas data URL
                const imageData = fabricCanvas.toDataURL({
                    format: 'png',
                    quality: 1
                });
                
                // Send to server for JPEG conversion
                const response = await fetch('/api/export/jpeg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageData: imageData,
                        page_number: currentPage + 1,
                        quality: 90
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `brosur_sayfa_${currentPage + 1}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('âœ… JPEG indirildi!');
                } else {
                    const error = await response.json();
                    alert('JPEG export hatasÄ±: ' + (error.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸ–¼ï¸ JPEG Ä°ndir';
            }
        }
        
        // PDF Export
        document.getElementById('pdf-btn').addEventListener('click', async () => {
            alert('â³ PDF oluÅŸturuluyor...');
            
            const script1 = document.createElement('script');
            script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(script1);
            
            script1.onload = () => {
                const script2 = document.createElement('script');
                script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(script2);
                
                script2.onload = () => {
                    const { jsPDF } = window.jspdf;
                    
                    html2canvas(canvasDiv, { scale: 2 }).then(canvas => {
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 10, 10, 190, 277);
                        pdf.save('market-brosuru.pdf');
                        alert('âœ… PDF indirildi!');
                    });
                };
            };
        });
        
        // Instagram (basit PNG)
        document.getElementById('instagram-btn').addEventListener('click', async () => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            document.head.appendChild(script);
            
            script.onload = () => {
                html2canvas(canvasDiv, { scale: 2, backgroundColor: '#fff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL();
                    link.download = 'brosur-instagram.png';
                    link.click();
                    alert('âœ… Instagram resmi indirildi!');
                });
            };
        });
    </script>

    <!-- Image Search Modal -->
    <div id="image-modal" class="modal hidden">
        <div class="modal-content">
            <h2>ðŸ” Resim SeÃ§</h2>
            <p>AI tarafÄ±ndan Ã¶nerilen resimlerden birini seÃ§in:</p>
            <div id="image-suggestions"></div>
            <div class="modal-buttons">
                <button id="close-modal-btn" class="btn-close">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Slogan Modal -->
    <div id="slogan-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <h2>ðŸ¤– AI Slogan Ã–nerileri</h2>
            <p>AI tarafÄ±ndan oluÅŸturulan kampanya sloganlarÄ±ndan birini seÃ§in:</p>
            <div id="slogan-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;"></div>
            <div class="modal-buttons">
                <button id="close-slogan-modal-btn" class="btn-close" onclick="closeSloganModal()">Kapat</button>
            </div>
        </div>
    </div>
    
    <!-- Template Modal -->
    <div id="template-modal" class="modal hidden">
        <div class="modal-content">
            <h2>ðŸ“„ Åžablon YÃ¼kle</h2>
            <p>Bu ÅŸablonu nasÄ±l kullanmak istersiniz?</p>
            <div style="margin: 20px 0;">
                <label style="display: block; margin: 10px 0;">
                    <input type="radio" name="template-option" value="all-pages" checked>
                    Bu ÅŸablonu tÃ¼m sayfalarda kullan
                </label>
                <label style="display: block; margin: 10px 0;">
                    <input type="radio" name="template-option" value="current-page">
                    Sadece bu sayfada kullan
                </label>
            </div>
            <div class="modal-buttons">
                <button id="apply-template-btn" class="btn-primary">Uygula</button>
                <button id="close-template-modal-btn" class="btn-close">Ä°ptal</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal hidden" style="background: rgba(0, 0, 0, 0.7);">
        <div style="text-align: center; color: white;">
            <div class="spinner" style="width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            <h2 style="margin-top: 20px;">ðŸ¤– AI BroÅŸÃ¼r OluÅŸturuluyor...</h2>
            <p>LÃ¼tfen bekleyin, broÅŸÃ¼rÃ¼nÃ¼z hazÄ±rlanÄ±yor.</p>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Interact.js Styles */
        .draggable {
          background: #6366f1;
          color: white;
          padding: 20px;
          border-radius: 8px;
          cursor: move;
          user-select: none;
          position: absolute;
        }

        .resize-drag {
          border: 2px dashed #9333ea;
        }
    </style>
    
    
    <script>
        function enableInteract(target) {
          interact(target)
            .draggable({
              listeners: {
                move(event) {
                  const x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
                  const y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;

                  event.target.style.transform = `translate(${x}px, ${y}px)`;
                  event.target.setAttribute('data-x', x);
                  event.target.setAttribute('data-y', y);
                }
              }
            })
            .resizable({
              edges: { top: true, left: true, bottom: true, right: true },
              listeners: {
                move(event) {
                  let { x, y } = event.target.dataset;
                  x = parseFloat(x) || 0;
                  y = parseFloat(y) || 0;

                  Object.assign(event.target.style, {
                    width: `${event.rect.width}px`,
                    height: `${event.rect.height}px`,
                    transform: `translate(${x + event.deltaRect.left}px, ${y + event.deltaRect.top}px)`
                  });

                  event.target.dataset.x = x + event.deltaRect.left;
                  event.target.dataset.y = y + event.deltaRect.top;
                }
              },
              modifiers: [
                interact.modifiers.restrictSize({
                  min: { width: 100, height: 50 },
                  max: { width: 1000, height: 800 }
                })
              ],
              inertia: true
            });
        }

        // Sayfadaki tÃ¼m ilgili Ã¶ÄŸelere uygula
        document.addEventListener("DOMContentLoaded", function () {
          document.querySelectorAll('.resize-drag').forEach(enableInteract);
        });

        // ========== USER-SPECIFIC DATA MANAGEMENT ==========
        // TÃ¼m kullanÄ±cÄ± ayarlarÄ±nÄ± backend'e kaydet (user_id bazlÄ±)
        async function saveAllSettings() {
            try {
                const settingsData = {
                    companyInfo: JSON.parse(localStorage.getItem('companyInfo') || '{}'),
                    socialMedia: JSON.parse(localStorage.getItem('socialMedia') || '[]'),
                    mealCards: JSON.parse(localStorage.getItem('mealCards') || '[]'),
                    logo: localStorage.getItem('companyLogo') || '',
                    canvasState: JSON.parse(localStorage.getItem('multipage_canvas_state') || 'null'),
                    templates: JSON.parse(localStorage.getItem('userTemplates') || '[]')
                };

                const response = await fetch('/api/save-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();
                if (result.success) {
                    console.log('âœ… Ayarlar kaydedildi (user_id bazlÄ±)');
                    return true;
                } else {
                    console.error('âŒ Ayarlar kaydedilemedi:', result.message);
                    if (typeof showNotification === 'function') {
                        showNotification('âš ï¸ Ayarlar kaydedilemedi: ' + result.message);
                    }
                    return false;
                }
            } catch (error) {
                console.error('âŒ saveAllSettings hatasÄ±:', error);
                if (typeof showNotification === 'function') {
                    showNotification('âš ï¸ BaÄŸlantÄ± hatasÄ±, ayarlar kaydedilemedi');
                }
                return false;
            }
        }

        // Backend'den kullanÄ±cÄ± ayarlarÄ±nÄ± yÃ¼kle (user_id bazlÄ±)
        async function loadAllSettings() {
            try {
                const response = await fetch('/api/get-settings');
                const result = await response.json();

                if (result.success && result.data) {
                    const data = result.data;
                    
                    // LocalStorage'a geri yÃ¼kle (mevcut fonksiyonlar iÃ§in)
                    if (data.companyInfo && typeof data.companyInfo === 'object') {
                        localStorage.setItem('companyInfo', JSON.stringify(data.companyInfo));
                        if (typeof loadCompanyInfo === 'function') loadCompanyInfo();
                    }
                    
                    if (data.socialMedia && Array.isArray(data.socialMedia)) {
                        localStorage.setItem('socialMedia', JSON.stringify(data.socialMedia));
                        if (typeof loadSocialMedia === 'function') loadSocialMedia();
                    }
                    
                    if (data.mealCards && Array.isArray(data.mealCards)) {
                        localStorage.setItem('mealCards', JSON.stringify(data.mealCards));
                        if (typeof loadMealCards === 'function') loadMealCards();
                    }
                    
                    if (data.logo && typeof data.logo === 'string') {
                        localStorage.setItem('companyLogo', data.logo);
                    }
                    
                    if (data.canvasState) {
                        const canvasStateStr = typeof data.canvasState === 'string' 
                            ? data.canvasState 
                            : JSON.stringify(data.canvasState);
                        localStorage.setItem('multipage_canvas_state', canvasStateStr);
                    }
                    
                    if (data.templates && Array.isArray(data.templates)) {
                        localStorage.setItem('userTemplates', JSON.stringify(data.templates));
                    }

                    console.log('âœ… Ayarlar yÃ¼klendi (user_id bazlÄ±)');
                } else {
                    console.log('â„¹ï¸ HenÃ¼z kaydedilmiÅŸ ayar yok');
                }
            } catch (error) {
                console.error('âŒ loadAllSettings hatasÄ±:', error);
                if (typeof showNotification === 'function') {
                    showNotification('âš ï¸ Ayarlar yÃ¼klenemedi');
                }
            }
        }

        // Sayfa yÃ¼klendiÄŸinde ayarlarÄ± backend'den Ã§ek
        window.addEventListener('DOMContentLoaded', async function() {
            // Check session first - if authenticated, show dashboard
            await checkSessionAsync();      // Await session check
            
            await loadAllSettings();
            await checkAdminAccess();       // Admin kontrolÃ¼ (admin toggle button gÃ¶ster) - window.isAdmin set edilir
            await loadAdminLayout();        // Global layout'u yÃ¼kle (mÃ¼ÅŸteriler iÃ§in)
            await loadBackgroundSettings(); // Global arka plan ayarlarÄ±nÄ± yÃ¼kle
            
            console.log('âœ… TÃ¼m baÅŸlatma iÅŸlemleri tamamlandÄ±, isAdmin:', window.isAdmin);
        });
        
        // Async version of checkSession
        async function checkSessionAsync() {
            try {
                const r = await fetch('/api/check-session');
                const data = await r.json();
                if (data.success) {
                    showMainScreen(data.user);
                    
                    // ========== BROÅžÃœRE AKTAR: SessionStorage'dan Ã¼rÃ¼nleri al ==========
                    const stagedPayload = sessionStorage.getItem('approvedCanvasPayload');
                    if (stagedPayload) {
                        try {
                            const stagedProducts = JSON.parse(stagedPayload);
                            console.log('ðŸŽ¨ Canvas payload alÄ±ndÄ±:', stagedProducts.length, 'Ã¼rÃ¼n');
                            
                            // SessionStorage'Ä± temizle
                            sessionStorage.removeItem('approvedCanvasPayload');
                            sessionStorage.removeItem('approvedPageSummary');
                            
                            // Canvas hazÄ±r olunca Ã¼rÃ¼nleri yerleÅŸtir
                            setTimeout(() => {
                                if (fabricCanvas && stagedProducts.length > 0) {
                                    placeProductsOnCanvas(stagedProducts);
                                } else {
                                    console.warn('âš ï¸ Canvas hazÄ±r deÄŸil veya Ã¼rÃ¼n yok');
                                }
                            }, 1500);
                            
                        } catch (parseError) {
                            console.error('âŒ Payload parse hatasÄ±:', parseError);
                            loadProducts();
                        }
                    } else {
                        // Normal akÄ±ÅŸ - DB'den Ã¼rÃ¼nleri yÃ¼kle
                        loadProducts();
                    }
                }
            } catch (error) {
                console.error('âŒ Session check error:', error);
            }
        }
        
        // ========== ÃœRÃœNLERI CANVAS'A YERLEÅžTÄ°R ==========
        function placeProductsOnCanvas(products) {
            if (!fabricCanvas) {
                console.error('âŒ fabricCanvas hazÄ±r deÄŸil!');
                return;
            }
            
            console.log('ðŸ”„ ÃœrÃ¼nler Canvas\'a yerleÅŸtiriliyor:', products.length);
            
            // Canvas'Ä± temizle ama background'u koru
            fabricCanvas.clear();
            fabricCanvas.backgroundColor = '#ffffff';
            
            const startX = getCardGridStartX();
            
            products.forEach((product, index) => {
                const position = getCardPosition(index, startX);
                console.log(`ðŸ“¦ ÃœrÃ¼n ${index + 1}: ${product.name} -> (${position.x}, ${position.y})`);
                // FIX: x,y -> left,top dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                addCardToCanvas(product, { left: position.x, top: position.y, suppressRender: true });
            });
            
            fabricCanvas.renderAll();
            console.log('âœ… TÃ¼m Ã¼rÃ¼nler Canvas\'a yerleÅŸtirildi!');
            
            // DEBUG: Canvas durumunu kontrol et
            console.log('ðŸ” DEBUG - Canvas boyutu:', fabricCanvas.width, 'x', fabricCanvas.height);
            console.log('ðŸ” DEBUG - Canvas objeleri:', fabricCanvas.getObjects().length);
            fabricCanvas.getObjects().forEach((obj, i) => {
                console.log(`ðŸ” DEBUG - Obje ${i}: left=${obj.left}, top=${obj.top}, visible=${obj.visible}, opacity=${obj.opacity}`);
            });
            
            // DEBUG: Canvas DOM elementi
            const canvasEl = fabricCanvas.getElement();
            console.log('ðŸ” DEBUG - Canvas element ID:', canvasEl?.id);
            console.log('ðŸ” DEBUG - Canvas element parent:', canvasEl?.parentElement?.id);
            console.log('ðŸ” DEBUG - Canvas lower-canvas class:', document.querySelector('.lower-canvas'));
            
            // ZORLA RENDER
            setTimeout(() => {
                console.log('ðŸ”„ Zorla render deneniyor...');
                fabricCanvas.requestRenderAll();
                fabricCanvas.calcOffset();
                fabricCanvas.renderAll();
                console.log('ðŸ”„ Zorla render tamamlandÄ±, obje sayÄ±sÄ±:', fabricCanvas.getObjects().length);
            }, 500);
        }
        
        // ========== BASÄ°T ÃœRÃœN KARTI ==========
        function createSimpleProductCard(product, x, y) {
            addCardToCanvas(product, { left: x, top: y });
            console.log('âœ… Kart eklendi:', product.name);
        }

        // ========== SETTINGS MODAL FUNCTIONS ==========
        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'block';
            loadModalSettings(); // Backend'den veriyi yÃ¼kle
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Tab switching
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('settings-tab')) return;
            
            const modal = document.getElementById('settings-modal');
            if (!modal || modal.style.display === 'none') return; // Guard: Only work when modal is open
            
            const tabName = e.target.getAttribute('data-tab');
            
            // Remove active from all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = 'rgba(255, 255, 255, 0.7)';
                tab.style.borderBottomColor = 'transparent';
            });
            
            // Hide all content
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Activate clicked tab
            e.target.classList.add('active');
            e.target.style.background = 'rgba(255, 255, 255, 0.2)';
            e.target.style.color = 'white';
            e.target.style.borderBottomColor = 'white';
            
            // Show corresponding content
            const targetContent = document.querySelector(`.settings-tab-content[data-content="${tabName}"]`);
            if (targetContent) {
                targetContent.style.display = 'block';
                targetContent.classList.add('active');
            }
        });

        // Load settings into modal from backend
        async function loadModalSettings() {
            try {
                const response = await fetch('/api/get-settings');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // Firma Bilgileri
                    if (data.companyInfo) {
                        document.getElementById('modal-company-name').value = data.companyInfo.name || '';
                        document.getElementById('modal-company-address').value = data.companyInfo.address || '';
                        document.getElementById('modal-company-phone').value = data.companyInfo.phone || '';
                        document.getElementById('modal-company-email').value = data.companyInfo.email || '';
                    }
                    
                    // Logo - Check backend first, then localStorage
                    let logoUrl = data.logo || localStorage.getItem('companyLogo');
                    if (logoUrl) {
                        const preview = document.getElementById('modal-logo-preview');
                        if (preview) {
                            preview.innerHTML = `<img src="${logoUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">`;
                        }
                        // Sync to localStorage
                        localStorage.setItem('companyLogo', logoUrl);
                    }
                    
                    // Sosyal Medya
                    if (data.socialMedia && Array.isArray(data.socialMedia)) {
                        const list = document.getElementById('modal-social-media-list');
                        list.innerHTML = '';
                        data.socialMedia.forEach(item => {
                            const div = document.createElement('div');
                            div.style.cssText = 'display: flex; gap: 12px; align-items: center; background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px;';
                            div.innerHTML = `
                                <i class="fab fa-${item.platform}" style="color: white; font-size: 24px;"></i>
                                <input type="text" value="${item.username}" readonly style="flex: 1; padding: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: white;">
                            `;
                            list.appendChild(div);
                        });
                    }
                    
                    // Yemek Ã‡ekleri
                    if (data.mealCards && Array.isArray(data.mealCards)) {
                        const checkboxes = document.querySelectorAll('input[name="modal-meal-card"]');
                        checkboxes.forEach(checkbox => {
                            const cardData = data.mealCards.find(card => card.name === checkbox.value);
                            if (cardData) {
                                checkbox.checked = cardData.checked;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('âŒ Modal ayarlarÄ± yÃ¼klenemedi:', error);
            }
        }

        // Save modal functions
        async function saveModalCompanyInfo() {
            const companyInfo = {
                name: document.getElementById('modal-company-name').value || '',
                address: document.getElementById('modal-company-address').value || '',
                phone: document.getElementById('modal-company-phone').value || '',
                email: document.getElementById('modal-company-email').value || ''
            };
            
            try {
                const response = await fetch('/api/save-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ companyInfo })
                });
                
                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
                    
                    // Update main cards (with guards)
                    const nameEl = document.getElementById('company-name');
                    const addressEl = document.getElementById('company-address');
                    const phoneEl = document.getElementById('company-phone');
                    const emailEl = document.getElementById('company-email');
                    
                    if (nameEl) nameEl.value = companyInfo.name;
                    if (addressEl) addressEl.value = companyInfo.address;
                    if (phoneEl) phoneEl.value = companyInfo.phone;
                    if (emailEl) emailEl.value = companyInfo.email;
                    
                    if (typeof showNotification === 'function') {
                        showNotification('âœ… Firma bilgileri kaydedildi');
                    }
                    console.log('âœ… Firma bilgileri backend\'e kaydedildi');
                } else {
                    if (typeof showNotification === 'function') {
                        showNotification('âŒ Kaydetme hatasÄ±: ' + result.error);
                    }
                }
            } catch (error) {
                console.error('âŒ Firma bilgileri kaydetme hatasÄ±:', error);
                if (typeof showNotification === 'function') {
                    showNotification('âŒ Kaydetme hatasÄ±');
                }
            }
        }

        async function saveModalMealCards() {
            const checkboxes = document.querySelectorAll('input[name="modal-meal-card"]');
            const selectedCards = [];
            
            checkboxes.forEach(checkbox => {
                selectedCards.push({
                    name: checkbox.value,
                    icon: checkbox.getAttribute('data-icon') || 'ðŸ´',
                    checked: checkbox.checked
                });
            });
            
            try {
                const response = await fetch('/api/save-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mealCards: selectedCards })
                });
                
                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('mealCards', JSON.stringify(selectedCards));
                    
                    // Update main cards (with existence check)
                    const mainCheckboxes = document.querySelectorAll('input[name="meal-card"]');
                    if (mainCheckboxes && mainCheckboxes.length > 0) {
                        mainCheckboxes.forEach(checkbox => {
                            const cardData = selectedCards.find(card => card.name === checkbox.value);
                            if (cardData) {
                                checkbox.checked = cardData.checked;
                            }
                        });
                    }
                    
                    if (typeof showNotification === 'function') {
                        showNotification('âœ… Yemek Ã§ekleri kaydedildi');
                    }
                    console.log('âœ… Yemek Ã§ekleri backend\'e kaydedildi');
                } else {
                    if (typeof showNotification === 'function') {
                        showNotification('âŒ Kaydetme hatasÄ±: ' + result.error);
                    }
                }
            } catch (error) {
                console.error('âŒ Yemek Ã§ekleri kaydetme hatasÄ±:', error);
                if (typeof showNotification === 'function') {
                    showNotification('âŒ Kaydetme hatasÄ±');
                }
            }
        }

        function addModalSocialMedia() {
            if (typeof showNotification === 'function') {
                showNotification('â„¹ï¸ Ana sayfadaki sosyal medya kartÄ±ndan ekleyebilirsiniz');
            }
        }

        // Logo upload function for modal
        async function handleModalLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showNotification('â³ Logo yÃ¼kleniyor...');
            
            const formData = new FormData();
            formData.append('logo', file);
            
            try {
                const response = await fetch('/api/upload-logo', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    const logoUrl = result.logo_url;
                    console.log('âœ… Logo yÃ¼klendi:', logoUrl);
                    
                    // Save logo URL to backend settings
                    const saveResponse = await fetch('/api/save-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ logo: logoUrl })
                    });
                    
                    const saveResult = await saveResponse.json();
                    console.log('âœ… Settings save response:', saveResult);
                    
                    // Save to localStorage for wizard and other components
                    localStorage.setItem('companyLogo', logoUrl);
                    
                    // Update modal preview
                    const modalPreview = document.getElementById('modal-logo-preview');
                    if (modalPreview) {
                        modalPreview.innerHTML = `<img src="${logoUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;">`;
                    }
                    
                    // Update wizard logo if open
                    const wizardLogo = document.querySelector('.wizard-logo, .wizard-logo-initials');
                    if (wizardLogo) {
                        wizardLogo.outerHTML = `<img src="${logoUrl}" alt="Logo" class="wizard-logo">`;
                    }
                    
                    showNotification('âœ… Logo baÅŸarÄ±yla yÃ¼klendi!');
                } else {
                    showNotification('âŒ Logo yÃ¼klenemedi: ' + (result.error || result.message));
                    console.error('âŒ Logo upload error:', result);
                }
            } catch (error) {
                console.error('âŒ Logo yÃ¼kleme hatasÄ±:', error);
                showNotification('âŒ Logo yÃ¼klenemedi: ' + error.message);
            }
        }

        // ========== ADMIN CUSTOMIZATION SYSTEM ==========
        // (isAdminMode and selectedButton are defined at script top to avoid hoisting issues)

        // Check if user is admin (on page load)
        async function checkAdminAccess() {
            try {
                const response = await fetch('/api/check-admin');
                const result = await response.json();
                
                // Set global admin flag (with fallback for role check)
                const isAdmin = result.success && (result.is_admin || result.role === 'admin');
                window.isAdmin = !!isAdmin;
                
                if (isAdmin) {
                    // Show admin toggle button
                    const adminBtn = document.getElementById('admin-toggle-btn');
                    if (adminBtn) {
                        adminBtn.style.display = 'flex';
                        console.log('âœ… Admin toggle button gÃ¶rÃ¼nÃ¼r kÄ±lÄ±ndÄ±');
                    } else {
                        console.warn('âš ï¸ Admin toggle button (#admin-toggle-btn) bulunamadÄ±');
                    }
                    
                    // Show Site Management button for admin
                    const siteManagementBtn = document.getElementById('btn-site-management');
                    if (siteManagementBtn) {
                        siteManagementBtn.style.display = 'flex';
                        console.log('âœ… Site YÃ¶netimi butonu gÃ¶rÃ¼nÃ¼r kÄ±lÄ±ndÄ±');
                    }
                    
                    // Enable admin features in editor
                    enableAdminFeatures();
                    
                    console.log('âœ… Admin access granted - Editor aktif, isAdmin:', window.isAdmin);
                } else {
                    console.log('â„¹ï¸ Regular user (no admin access)');
                }
            } catch (error) {
                console.error('âŒ Admin check failed:', error);
                window.isAdmin = false;
            }
        }
        
        // Enable admin-specific features in the editor
        function enableAdminFeatures() {
            // 1. Enable admin-only UI controls
            const adminControls = document.querySelectorAll('.admin-only');
            if (adminControls.length > 0) {
                adminControls.forEach(ctrl => {
                    ctrl.style.pointerEvents = 'auto';
                    ctrl.style.opacity = '1';
                });
                console.log(`âœ… ${adminControls.length} admin control aktif edildi`);
            }
            
            // 2. Enable admin panel if it exists
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel) {
                adminPanel.style.pointerEvents = 'auto';
                console.log('âœ… Admin panel aktif');
            }
            
            // 3. Make sure canvas is editable for admin
            if (typeof fabricCanvas !== 'undefined' && fabricCanvas) {
                fabricCanvas.selection = true;
                console.log('âœ… Canvas selection aktif');
            }
            
            console.log('âœ… TÃ¼m admin Ã¶zellikleri aktif edildi');
        }

        // Toggle Admin Mode
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            const panel = document.getElementById('admin-panel');
            const modeText = document.getElementById('admin-mode-text');
            const adminBtn = document.getElementById('admin-toggle-btn');
            
            if (isAdminMode) {
                panel.style.display = 'block';
                modeText.textContent = 'Normal Mod';
                if (adminBtn) adminBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                enableAdminDragging();
                console.log('âœ… Admin Mode: AÃ‡IK');
            } else {
                panel.style.display = 'none';
                modeText.textContent = 'Admin DÃ¼zenleme Modu';
                if (adminBtn) adminBtn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)';
                disableAdminDragging();
                selectedButton = null;
                console.log('â„¹ï¸ Admin Mode: KAPALI');
            }
        }

        // Enable dragging for toolbar buttons
        function enableAdminDragging() {
            const buttons = ['btn-excel-upload', 'btn-settings', 'btn-logout'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                // Add visual indicator
                btn.style.cursor = 'move';
                btn.style.border = '2px dashed rgba(255, 255, 255, 0.5)';
                
                // Make draggable with Interact.js
                interact(`#${btnId}`)
                    .draggable({
                        inertia: true,
                        modifiers: [
                            interact.modifiers.restrictRect({
                                restriction: '#header-toolbar',
                                endOnly: true
                            })
                        ],
                        autoScroll: true,
                        listeners: {
                            move: dragMoveListener
                        }
                    });
                
                // Click to select
                btn.addEventListener('click', function(e) {
                    if (isAdminMode) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectButton(btn);
                    }
                }, true);
            });
        }

        function disableAdminDragging() {
            const buttons = ['btn-excel-upload', 'btn-settings', 'btn-logout'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                // Remove visual indicator
                btn.style.cursor = 'pointer';
                btn.style.border = 'none';
                
                // Disable draggable
                interact(`#${btnId}`).unset();
            });
        }

        function dragMoveListener(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        function selectButton(btn) {
            selectedButton = btn;
            
            // Update selected info
            const selectedInfo = document.getElementById('selected-element-info');
            const selectedName = document.getElementById('selected-element-name');
            selectedInfo.style.display = 'block';
            selectedName.textContent = btn.textContent.trim();
            
            // Load current styles
            const computedStyle = window.getComputedStyle(btn);
            document.getElementById('admin-fontsize-slider').value = parseInt(computedStyle.fontSize);
            document.getElementById('fontsize-value').textContent = computedStyle.fontSize;
        }

        // Slider event listeners - with null checks
        const adminColorPicker = document.getElementById('admin-color-picker');
        if (adminColorPicker) {
            adminColorPicker.addEventListener('change', function() {
                if (!selectedButton) return;
                const colors = this.value.split(',');
                selectedButton.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;
            });
        }

        const adminWidthSlider = document.getElementById('admin-width-slider');
        if (adminWidthSlider) {
            adminWidthSlider.addEventListener('input', function() {
                const widthValueEl = document.getElementById('width-value');
                if (widthValueEl) widthValueEl.textContent = this.value + 'px';
                if (selectedButton) selectedButton.style.width = this.value + 'px';
            });
        }

        const adminHeightSlider = document.getElementById('admin-height-slider');
        if (adminHeightSlider) {
            adminHeightSlider.addEventListener('input', function() {
                const heightValueEl = document.getElementById('height-value');
                if (heightValueEl) heightValueEl.textContent = this.value + 'px';
                if (selectedButton) selectedButton.style.height = this.value + 'px';
            });
        }

        const adminPaddingSlider = document.getElementById('admin-padding-slider');
        if (adminPaddingSlider) {
            adminPaddingSlider.addEventListener('input', function() {
                const val = this.value;
                const paddingValueEl = document.getElementById('padding-value');
                if (paddingValueEl) paddingValueEl.textContent = `${val}px ${val*2}px`;
                if (selectedButton) selectedButton.style.padding = `${val}px ${val*2}px`;
            });
        }

        const adminFontsizeSlider = document.getElementById('admin-fontsize-slider');
        if (adminFontsizeSlider) {
            adminFontsizeSlider.addEventListener('input', function() {
                const fontsizeValueEl = document.getElementById('fontsize-value');
                if (fontsizeValueEl) fontsizeValueEl.textContent = this.value + 'px';
                if (selectedButton) selectedButton.style.fontSize = this.value + 'px';
            });
        }

        // Save admin layout
        async function saveAdminLayout() {
            try {
                const buttons = ['btn-excel-upload', 'btn-settings', 'btn-logout'];
                const layout = {
                    buttons: {}
                };
                
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (!btn) return;
                    
                    const computedStyle = window.getComputedStyle(btn);
                    layout.buttons[btnId] = {
                        x: parseFloat(btn.getAttribute('data-x')) || 0,
                        y: parseFloat(btn.getAttribute('data-y')) || 0,
                        background: btn.style.background || computedStyle.background,
                        width: btn.style.width || computedStyle.width,
                        height: btn.style.height || computedStyle.height,
                        padding: btn.style.padding || computedStyle.padding,
                        fontSize: btn.style.fontSize || computedStyle.fontSize
                    };
                });
                
                const response = await fetch('/api/save-admin-layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(layout)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('âœ… Layout kaydedildi! TÃ¼m mÃ¼ÅŸteriler bu tasarÄ±mÄ± gÃ¶recek.');
                    console.log('âœ… Admin layout saved');
                } else {
                    alert('âŒ Layout kaydedilemedi: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ Save layout error:', error);
                alert('âŒ BaÄŸlantÄ± hatasÄ±');
            }
        }

        // Load admin layout
        async function loadAdminLayout() {
            try {
                const response = await fetch('/api/get-admin-layout');
                const result = await response.json();
                
                if (result.success && result.data && result.data.buttons) {
                    const layout = result.data;
                    
                    // Defensive: Validate layout structure before applying
                    if (typeof layout.buttons !== 'object') {
                        console.warn('âš ï¸ Invalid layout structure, falling back to default');
                        return;
                    }
                    
                    const allowedButtons = ['btn-excel-upload', 'btn-template-download', 'btn-settings', 'btn-logout'];
                    
                    Object.keys(layout.buttons).forEach(btnId => {
                        // Validate button ID
                        if (!allowedButtons.includes(btnId)) {
                            console.warn(`âš ï¸ Unknown button ID: ${btnId}, skipping`);
                            return;
                        }
                        
                        const btn = document.getElementById(btnId);
                        if (!btn) {
                            console.warn(`âš ï¸ Button not found: ${btnId}, skipping`);
                            return;
                        }
                        
                        const style = layout.buttons[btnId];
                        
                        // Defensive: Validate style object
                        if (typeof style !== 'object' || style === null) {
                            console.warn(`âš ï¸ Invalid style for ${btnId}, skipping`);
                            return;
                        }
                        
                        // Check for required fields
                        const requiredFields = ['x', 'y', 'background', 'width', 'height', 'padding', 'fontSize'];
                        const missingFields = requiredFields.filter(field => !(field in style));
                        
                        if (missingFields.length > 0) {
                            console.warn(`âš ï¸ Missing required fields for ${btnId}: ${missingFields.join(', ')}, skipping`);
                            return;
                        }
                        
                        // Apply position (with range validation)
                        if (typeof style.x === 'number' && typeof style.y === 'number') {
                            if (Math.abs(style.x) <= 2000 && Math.abs(style.y) <= 2000) {
                                btn.style.transform = `translate(${style.x}px, ${style.y}px)`;
                                btn.setAttribute('data-x', style.x);
                                btn.setAttribute('data-y', style.y);
                            } else {
                                console.warn(`âš ï¸ Position out of range for ${btnId}, using default (0, 0)`);
                                btn.style.transform = 'translate(0px, 0px)';
                                btn.setAttribute('data-x', '0');
                                btn.setAttribute('data-y', '0');
                            }
                        } else {
                            console.warn(`âš ï¸ Invalid position types for ${btnId}, using default (0, 0)`);
                            btn.style.transform = 'translate(0px, 0px)';
                            btn.setAttribute('data-x', '0');
                            btn.setAttribute('data-y', '0');
                        }
                        
                        // Apply styles (with validation and sanitization)
                        const stringFields = ['background', 'width', 'height', 'padding', 'fontSize'];
                        stringFields.forEach(field => {
                            if (style[field] && typeof style[field] === 'string' && style[field].trim() && style[field].length <= 200) {
                                btn.style[field] = style[field];
                            } else {
                                console.warn(`âš ï¸ Invalid ${field} for ${btnId}, keeping default`);
                            }
                        });
                    });
                    
                    console.log('âœ… Admin layout loaded');
                } else {
                    console.log('â„¹ï¸ No admin layout found, using defaults');
                }
            } catch (error) {
                console.error('âŒ Load layout error:', error);
                console.warn('âš ï¸ Falling back to default layout');
            }
        }

        // Reset admin layout
        function resetAdminLayout() {
            if (!confirm('TÃ¼m deÄŸiÅŸiklikleri sÄ±fÄ±rlamak istediÄŸinizden emin misiniz?')) return;
            
            const buttons = ['btn-excel-upload', 'btn-settings', 'btn-logout'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                
                btn.style.transform = '';
                btn.setAttribute('data-x', '0');
                btn.setAttribute('data-y', '0');
                btn.style.width = '';
                btn.style.height = '';
                btn.style.padding = '';
                btn.style.fontSize = '';
            });
            
            alert('âœ… Layout sÄ±fÄ±rlandÄ±');
        }

        // ========== BACKGROUND SETTINGS SYSTEM ==========
        let uploadedBackgroundUrl = null;
        
        // Background type selector event listener
        const bgTypeSelector = document.getElementById('bg-type-selector');
        if (bgTypeSelector) {
            bgTypeSelector.addEventListener('change', function() {
                const type = this.value;
                const gradientSection = document.getElementById('bg-gradient-section');
                const imageSection = document.getElementById('bg-image-section');
                
                if (type === 'gradient') {
                    if (gradientSection) gradientSection.style.display = 'block';
                    if (imageSection) imageSection.style.display = 'none';
                } else if (type === 'image') {
                    if (gradientSection) gradientSection.style.display = 'none';
                    if (imageSection) imageSection.style.display = 'block';
                } else {
                    if (gradientSection) gradientSection.style.display = 'none';
                    if (imageSection) imageSection.style.display = 'none';
                }
            });
        }
        
        // Image upload handler
        const bgImageInput = document.getElementById('bg-image-input');
        if (bgImageInput) {
            bgImageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate size
            if (file.size > 5 * 1024 * 1024) {
                alert('âŒ Dosya Ã§ok bÃ¼yÃ¼k (max 5MB)');
                return;
            }
            
            // Validate type
            if (!['image/jpeg', 'image/jpg', 'image/png', 'image/gif'].includes(file.type)) {
                alert('âŒ GeÃ§ersiz dosya tipi (sadece jpg, png, gif)');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/upload-background', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedBackgroundUrl = result.background_url;
                    
                    // Show preview
                    const preview = document.getElementById('bg-image-preview');
                    preview.style.backgroundImage = `url(${uploadedBackgroundUrl})`;
                    preview.style.display = 'block';
                    
                    console.log('âœ… Background image uploaded:', uploadedBackgroundUrl);
                } else {
                    alert('âŒ YÃ¼kleme hatasÄ±: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ Upload error:', error);
                alert('âŒ BaÄŸlantÄ± hatasÄ±');
            }
            });
        }
        
        // Save background settings
        async function saveBackgroundSettings() {
            try {
                const type = document.getElementById('bg-type-selector').value;
                const dashboardChecked = document.getElementById('bg-page-dashboard').checked;
                const loginChecked = document.getElementById('bg-page-login').checked;
                
                if (!dashboardChecked && !loginChecked) {
                    alert('âš ï¸ En az bir sayfa seÃ§melisiniz');
                    return;
                }
                
                let value = '';
                let position = 'cover';
                
                if (type === 'gradient') {
                    value = document.getElementById('bg-gradient-picker').value;
                } else if (type === 'image') {
                    if (!uploadedBackgroundUrl) {
                        alert('âš ï¸ LÃ¼tfen Ã¶nce resim yÃ¼kleyin');
                        return;
                    }
                    value = uploadedBackgroundUrl;
                    position = document.getElementById('bg-image-position').value;
                } else {
                    value = '';
                }
                
                // Build settings payload
                const settings = {
                    pages: {}
                };
                
                if (dashboardChecked) {
                    settings.pages.dashboard = {
                        type: type,
                        value: value,
                        position: position
                    };
                }
                
                if (loginChecked) {
                    settings.pages.login = {
                        type: type,
                        value: value,
                        position: position
                    };
                }
                
                const response = await fetch('/api/save-background-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… Arka plan ayarlarÄ± kaydedildi! TÃ¼m mÃ¼ÅŸteriler bu tasarÄ±mÄ± gÃ¶recek.');
                    await loadBackgroundSettings(); // Reload to apply
                    console.log('âœ… Background settings saved');
                } else {
                    alert('âŒ Kaydetme hatasÄ±: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ Save background error:', error);
                alert('âŒ BaÄŸlantÄ± hatasÄ±');
            }
        }
        
        // Load background settings
        async function loadBackgroundSettings() {
            try {
                const response = await fetch('/api/get-background-settings');
                const result = await response.json();
                
                if (result.success && result.data && result.data.pages) {
                    const settings = result.data;
                    
                    // Apply to dashboard page
                    if (settings.pages.dashboard) {
                        applyBackground('dashboard', settings.pages.dashboard);
                    }
                    
                    // Apply to login page
                    if (settings.pages.login) {
                        applyBackground('login', settings.pages.login);
                    }
                    
                    console.log('âœ… Background settings loaded');
                } else {
                    console.log('â„¹ï¸ No background settings found, using defaults');
                }
            } catch (error) {
                console.error('âŒ Load background error:', error);
            }
        }
        
        // Apply background to specific page
        function applyBackground(pageName, settings) {
            try {
                // Validate settings
                if (!settings || typeof settings !== 'object') return;
                if (!settings.type || !settings.value) return;
                if (settings.value.length > 500) return; // Security check
                
                let targetElement = null;
                
                if (pageName === 'dashboard') {
                    // Apply to main screen
                    targetElement = document.getElementById('main-screen');
                } else if (pageName === 'login') {
                    // Apply to login screen
                    targetElement = document.getElementById('login-screen');
                }
                
                if (!targetElement) return;
                
                // Apply based on type
                if (settings.type === 'gradient') {
                    targetElement.style.background = settings.value;
                    targetElement.style.backgroundSize = '';
                    targetElement.style.backgroundPosition = '';
                    targetElement.style.backgroundRepeat = '';
                } else if (settings.type === 'image') {
                    targetElement.style.backgroundImage = `url(${settings.value})`;
                    
                    // Apply position settings
                    const position = settings.position || 'cover';
                    if (position === 'cover') {
                        targetElement.style.backgroundSize = 'cover';
                        targetElement.style.backgroundPosition = 'center';
                        targetElement.style.backgroundRepeat = 'no-repeat';
                    } else if (position === 'contain') {
                        targetElement.style.backgroundSize = 'contain';
                        targetElement.style.backgroundPosition = 'center';
                        targetElement.style.backgroundRepeat = 'no-repeat';
                    } else if (position === 'repeat') {
                        targetElement.style.backgroundSize = 'auto';
                        targetElement.style.backgroundPosition = 'top left';
                        targetElement.style.backgroundRepeat = 'repeat';
                    } else if (position === 'center') {
                        targetElement.style.backgroundSize = 'auto';
                        targetElement.style.backgroundPosition = 'center';
                        targetElement.style.backgroundRepeat = 'no-repeat';
                    }
                } else {
                    // Reset to default
                    targetElement.style.background = '';
                    targetElement.style.backgroundImage = '';
                    targetElement.style.backgroundSize = '';
                    targetElement.style.backgroundPosition = '';
                    targetElement.style.backgroundRepeat = '';
                }
                
                console.log(`âœ… Background applied to ${pageName}`);
            } catch (error) {
                console.error(`âŒ Apply background error for ${pageName}:`, error);
            }
        }

        // Logout function
        function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                fetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        localStorage.clear();
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                        window.location.reload();
                    });
            }
        }

        // Otomatik kaydetme: Her ayar deÄŸiÅŸtiÄŸinde backend'e kaydet (debounced)
        let saveTimeout;
        let isSaving = false;
        function autoSaveSettings() {
            if (isSaving) {
                console.log('â³ Kaydetme devam ediyor, atlanÄ±yor...');
                return;
            }
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                isSaving = true;
                await saveAllSettings();
                isSaving = false;
            }, 1500); // 1.5 saniye sonra kaydet
        }

        // Mevcut save fonksiyonlarÄ±na hook ekle (sadece user interaction'da Ã§alÄ±ÅŸÄ±r)
        if (typeof saveCompanyInfo !== 'undefined') {
            const originalSaveCompanyInfo = saveCompanyInfo;
            saveCompanyInfo = function() {
                originalSaveCompanyInfo.apply(this, arguments);
                autoSaveSettings();
            };
        }

        if (typeof saveSocialMedia !== 'undefined') {
            const originalSaveSocialMedia = saveSocialMedia;
            saveSocialMedia = function() {
                originalSaveSocialMedia.apply(this, arguments);
                autoSaveSettings();
            };
        }

        if (typeof saveMealCards !== 'undefined') {
            const originalSaveMealCards = saveMealCards;
            saveMealCards = function() {
                originalSaveMealCards.apply(this, arguments);
                autoSaveSettings();
            };
        }
    </script>

    <!-- ADMIN CUSTOMIZATION PANEL -->
    <div id="admin-panel" style="display: none; position: fixed; top: 80px; right: 20px; width: 350px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.95) 0%, rgba(109, 40, 217, 0.95) 100%); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.2); z-index: 9998; max-height: calc(100vh - 100px); overflow-y: auto;">
        <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">ðŸŽ¨ Admin DÃ¼zenleme Paneli</h3>
        
        <!-- Selected Element Info -->
        <div id="selected-element-info" style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none;">
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 12px; margin: 0;">SeÃ§ili: <span id="selected-element-name" style="font-weight: 600;">-</span></p>
        </div>
        
        <!-- Color Picker -->
        <div style="margin-bottom: 20px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸŽ¨ Buton Rengi</label>
            <select id="admin-color-picker" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; cursor: pointer;">
                <option value="#667eea,#764ba2">Mor Gradient</option>
                <option value="#10b981,#059669">YeÅŸil Gradient</option>
                <option value="#f59e0b,#d97706">Turuncu Gradient</option>
                <option value="#ef4444,#dc2626">KÄ±rmÄ±zÄ± Gradient</option>
                <option value="#3b82f6,#2563eb">Mavi Gradient</option>
                <option value="#ec4899,#d946ef">Pembe Gradient</option>
                <option value="#6366f1,#4f46e5">Ä°ndigo Gradient</option>
            </select>
        </div>
        
        <!-- Size Controls -->
        <div style="margin-bottom: 20px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“ GeniÅŸlik</label>
            <input type="range" id="admin-width-slider" min="80" max="300" value="150" step="10" style="width: 100%; margin-bottom: 8px;">
            <span id="width-value" style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">150px</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“ YÃ¼kseklik</label>
            <input type="range" id="admin-height-slider" min="30" max="80" value="42" step="2" style="width: 100%; margin-bottom: 8px;">
            <span id="height-value" style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">42px</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“¦ Padding</label>
            <input type="range" id="admin-padding-slider" min="5" max="25" value="10" step="1" style="width: 100%; margin-bottom: 8px;">
            <span id="padding-value" style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">10px 20px</span>
        </div>
        
        <!-- Font Size -->
        <div style="margin-bottom: 20px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ”¤ Font Boyutu</label>
            <input type="range" id="admin-fontsize-slider" min="10" max="20" value="14" step="1" style="width: 100%; margin-bottom: 8px;">
            <span id="fontsize-value" style="color: rgba(255, 255, 255, 0.7); font-size: 12px;">14px</span>
        </div>
        
        <!-- Divider -->
        <hr style="border: none; border-top: 2px solid rgba(255, 255, 255, 0.2); margin: 32px 0;">
        
        <!-- Background Settings Section -->
        <h4 style="color: white; margin: 0 0 16px 0; font-size: 18px; font-weight: 700;">ðŸ–¼ï¸ Arka Plan AyarlarÄ±</h4>
        
        <!-- Page Selector -->
        <div style="margin-bottom: 16px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“„ Sayfa SeÃ§</label>
            <div style="display: flex; gap: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: rgba(255, 255, 255, 0.9); font-size: 13px;">
                    <input type="checkbox" id="bg-page-dashboard" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Dashboard</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: rgba(255, 255, 255, 0.9); font-size: 13px;">
                    <input type="checkbox" id="bg-page-login" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Login</span>
                </label>
            </div>
        </div>
        
        <!-- Background Type -->
        <div style="margin-bottom: 16px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸŽ¨ Arka Plan Tipi</label>
            <select id="bg-type-selector" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; cursor: pointer;">
                <option value="gradient">Gradient</option>
                <option value="image">Resim</option>
                <option value="none">Yok (VarsayÄ±lan)</option>
            </select>
        </div>
        
        <!-- Gradient Selector (shown when type=gradient) -->
        <div id="bg-gradient-section" style="margin-bottom: 16px;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸŒˆ Gradient SeÃ§</label>
            <select id="bg-gradient-picker" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; cursor: pointer;">
                <option value="linear-gradient(135deg, #667eea 0%, #764ba2 100%)">Mor-Mavi</option>
                <option value="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)">Pembe-KÄ±rmÄ±zÄ±</option>
                <option value="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)">Mavi-Cyan</option>
                <option value="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)">YeÅŸil-Turkuaz</option>
                <option value="linear-gradient(135deg, #fa709a 0%, #fee140 100%)">Pembe-SarÄ±</option>
                <option value="linear-gradient(135deg, #30cfd0 0%, #330867 100%)">Cyan-Mor</option>
                <option value="linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)">AÃ§Ä±k Turkuaz-Pembe</option>
                <option value="linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)">Pastel Pembe</option>
                <option value="linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)">Turuncu-Åžeftali</option>
                <option value="linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)">AÃ§Ä±k Mavi</option>
            </select>
        </div>
        
        <!-- Image Upload Section (shown when type=image) -->
        <div id="bg-image-section" style="margin-bottom: 16px; display: none;">
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“· Resim YÃ¼kle</label>
            <input type="file" id="bg-image-input" accept="image/jpeg,image/jpg,image/png,image/gif" style="display: none;">
            <button onclick="document.getElementById('bg-image-input').click()" style="width: 100%; background: rgba(255, 255, 255, 0.2); color: white; border: 2px dashed rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-bottom: 12px;">
                ðŸ“¤ Resim SeÃ§ (Max 5MB)
            </button>
            
            <!-- Image Preview -->
            <div id="bg-image-preview" style="display: none; width: 100%; height: 120px; border-radius: 8px; background-size: cover; background-position: center; border: 2px solid rgba(255, 255, 255, 0.3); margin-bottom: 12px;"></div>
            
            <!-- Image Position -->
            <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px; font-size: 14px;">ðŸ“ Resim Pozisyonu</label>
            <select id="bg-image-position" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; cursor: pointer;">
                <option value="cover">Kapla (Cover)</option>
                <option value="contain">SÄ±ÄŸdÄ±r (Contain)</option>
                <option value="repeat">Tekrarla (Repeat)</option>
                <option value="center">Ortala (Center)</option>
            </select>
        </div>
        
        <!-- Save Background Button -->
        <button onclick="saveBackgroundSettings()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); margin-bottom: 16px;">
            ðŸ–¼ï¸ Arka Plan Kaydet
        </button>
        
        <!-- Divider -->
        <hr style="border: none; border-top: 2px solid rgba(255, 255, 255, 0.2); margin: 32px 0;">
        
        <!-- Save & Reset Buttons -->
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button onclick="saveAdminLayout()" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
                ðŸ’¾ Kaydet
            </button>
            <button onclick="resetAdminLayout()" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);">
                ðŸ”„ SÄ±fÄ±rla
            </button>
        </div>
        
        <p style="color: rgba(255, 255, 255, 0.6); font-size: 11px; margin-top: 16px; line-height: 1.5;">ðŸ’¡ ButonlarÄ± sÃ¼rÃ¼kleyip yerlerini deÄŸiÅŸtirebilirsiniz. DeÄŸiÅŸiklikler tÃ¼m mÃ¼ÅŸterilere yansÄ±r.</p>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 9999; overflow-y: auto;">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px 20px;">
            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%); backdrop-filter: blur(20px); border-radius: 24px; width: 100%; max-width: 900px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.2);">
                
                <!-- Modal Header -->
                <div style="padding: 24px 32px; border-bottom: 2px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: white; font-size: 28px; font-weight: 700; margin: 0;">âš™ï¸ Ayarlar</h2>
                    <button onclick="closeSettingsModal()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 32px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">Ã—</button>
                </div>
                
                <!-- Tabs -->
                <div style="padding: 0 32px; display: flex; gap: 8px; overflow-x: auto; background: rgba(0, 0, 0, 0.2); border-bottom: 2px solid rgba(255, 255, 255, 0.1);">
                    <button class="settings-tab active" data-tab="firma" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid white; transition: all 0.3s;">ðŸ“Š Firma Bilgileri</button>
                    <button class="settings-tab" data-tab="logo" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸŽ¨ Logo</button>
                    <button class="settings-tab" data-tab="social" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“± Sosyal Medya</button>
                    <button class="settings-tab" data-tab="meal" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ½ï¸ Yemek Ã‡ekleri</button>
                    <button class="settings-tab" data-tab="credit" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ’³ Kredi/Puan</button>
                    <button class="settings-tab" data-tab="templates" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“ ÅžablonlarÄ±m</button>
                    <button class="settings-tab" data-tab="brochures" style="background: transparent; color: rgba(255, 255, 255, 0.7); border: none; padding: 14px 20px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s;">ðŸ“„ BroÅŸÃ¼rlerim</button>
                </div>
                
                <!-- Tab Contents -->
                <div style="padding: 32px; max-height: 60vh; overflow-y: auto;">
                    
                    <!-- Firma Bilgileri Tab -->
                    <div class="settings-tab-content active" data-content="firma">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ“Š Firma Bilgileri</h3>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px;">Åžirket AdÄ±</label>
                                <input type="text" id="modal-company-name" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;" placeholder="Ã¶rn: AEUyazÄ±lÄ±m">
                            </div>
                            <div>
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px;">Adres (4 satÄ±r)</label>
                                <textarea id="modal-company-address" rows="4" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; resize: vertical;" placeholder="Ã¶rn: AtatÃ¼rk Cad. No: 123&#10;KadÄ±kÃ¶y/Ä°stanbul&#10;TÃ¼rkiye&#10;Posta Kodu: 34000"></textarea>
                            </div>
                            <div>
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px;">Telefon</label>
                                <input type="tel" id="modal-company-phone" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;" placeholder="Ã¶rn: 0212 555 1234">
                            </div>
                            <div>
                                <label style="color: rgba(255, 255, 255, 0.9); font-weight: 600; display: block; margin-bottom: 8px;">E-posta</label>
                                <input type="email" id="modal-company-email" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;" placeholder="Ã¶rn: info@aeuyazilim.com">
                            </div>
                            <button onclick="saveModalCompanyInfo()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s;">ðŸ’¾ Kaydet</button>
                        </div>
                    </div>
                    
                    <!-- Logo Tab -->
                    <div class="settings-tab-content" data-content="logo" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸŽ¨ Logo YÃ¼kleme</h3>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                            <div id="modal-logo-preview" style="width: 200px; height: 200px; border: 3px dashed rgba(255, 255, 255, 0.4); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05);">
                                <span style="color: rgba(255, 255, 255, 0.6); font-size: 14px;">Logo Ã–nizleme</span>
                            </div>
                            <input type="file" id="modal-logo-input" accept="image/*" style="display: none;" onchange="handleModalLogoUpload(event)">
                            <button onclick="document.getElementById('modal-logo-input').click()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">ðŸ“¤ Logo SeÃ§ ve YÃ¼kle</button>
                        </div>
                    </div>
                    
                    <!-- Sosyal Medya Tab -->
                    <div class="settings-tab-content" data-content="social" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ“± Sosyal Medya HesaplarÄ±</h3>
                        <div id="modal-social-media-list" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Social media items dynamically loaded -->
                        </div>
                        <button onclick="addModalSocialMedia()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-top: 16px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">âž• Sosyal Medya Ekle</button>
                    </div>
                    
                    <!-- Yemek Ã‡ekleri Tab -->
                    <div class="settings-tab-content" data-content="meal" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ½ï¸ Kabul Edilen Yemek Ã‡ekleri</h3>
                        <div id="modal-meal-cards" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <label style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" name="modal-meal-card" value="Sodexo" data-icon="ðŸ½ï¸" style="width: 20px; height: 20px;">
                                <span style="color: white; font-weight: 600;">ðŸ½ï¸ Sodexo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" name="modal-meal-card" value="Multinet" data-icon="ðŸ´" style="width: 20px; height: 20px;">
                                <span style="color: white; font-weight: 600;">ðŸ´ Multinet</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" name="modal-meal-card" value="Setcard" data-icon="ðŸ¥˜" style="width: 20px; height: 20px;">
                                <span style="color: white; font-weight: 600;">ðŸ¥˜ Setcard</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" name="modal-meal-card" value="Ticket" data-icon="ðŸ²" style="width: 20px; height: 20px;">
                                <span style="color: white; font-weight: 600;">ðŸ² Ticket</span>
                            </label>
                        </div>
                        <button onclick="saveModalMealCards()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; margin-top: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">ðŸ’¾ Kaydet</button>
                    </div>
                    
                    <!-- Kredi/Puan Tab -->
                    <div class="settings-tab-content" data-content="credit" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ’³ Kredi ve Puan Durumu</h3>
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 24px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 16px; font-weight: 600;">Mevcut Kredi:</span>
                                <span style="color: #10b981; font-size: 24px; font-weight: 700;">â‚º500</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 16px; font-weight: 600;">Puan:</span>
                                <span style="color: #f59e0b; font-size: 24px; font-weight: 700;">1,250 â­</span>
                            </div>
                            <p style="color: rgba(255, 255, 255, 0.7); margin-top: 20px; font-size: 14px; text-align: center;">Kredi ve puan sistemi iÃ§in lÃ¼tfen yÃ¶neticinizle iletiÅŸime geÃ§in.</p>
                        </div>
                    </div>
                    
                    <!-- ÅžablonlarÄ±m Tab -->
                    <div class="settings-tab-content" data-content="templates" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ“ KayÄ±tlÄ± ÅžablonlarÄ±m</h3>
                        <div id="modal-user-templates" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
                            <!-- Templates loaded dynamically -->
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 2px dashed rgba(255, 255, 255, 0.3); text-align: center; color: rgba(255, 255, 255, 0.6);">HenÃ¼z kayÄ±tlÄ± ÅŸablon yok</div>
                        </div>
                    </div>
                    
                    <!-- BroÅŸÃ¼rlerim Tab -->
                    <div class="settings-tab-content" data-content="brochures" style="display: none;">
                        <h3 style="color: white; margin-bottom: 20px; font-size: 20px;">ðŸ“„ KayÄ±tlÄ± BroÅŸÃ¼rlerim</h3>
                        <div id="modal-user-brochures" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Brochures loaded dynamically -->
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 24px; border-radius: 12px; border: 2px dashed rgba(255, 255, 255, 0.3); text-align: center; color: rgba(255, 255, 255, 0.6);">HenÃ¼z kayÄ±tlÄ± broÅŸÃ¼r yok</div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- BroÅŸÃ¼r Master - Yeni minimalist wizard JS tarafÄ±ndan dinamik oluÅŸturuluyor -->

    <!-- Ghost Assistant JS -->
    <script src="/static/js/ghost.js"></script>
    <!-- Settings Panel JS -->
    <script src="/static/js/settings-panel.js"></script>
    <!-- Brochure Templates & Studio -->
    <script src="/static/js/brochure-templates.js"></script>
    <script src="/static/js/brochure-studio.js"></script>
    <!-- Brochure Wizard JS -->
    <script src="/static/js/brochure-wizard.js"></script>
</body>
</html>
